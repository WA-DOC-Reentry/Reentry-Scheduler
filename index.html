
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Location Schedule Management System v3.32</title>
    <style>
        :root {
            /* Professional Corporate Palette */
            --primary-dark: #334155; /* Grey-Blue (Slate) for Banners */
            --primary-light: #3b82f6; /* Action Blue (Buttons/Accents) */
            --bg-page: #f8fafc; /* Very light grey/white page bg */
            --bg-surface: #ffffff; /* Pure white surface */
            --text-main: #0f172a; /* Slate 900 */
            --text-muted: #64748b; /* Slate 500 */
            --border-color: #cbd5e1; /* Slate 300 */
            --header-height: 70px; /* Adjusted for single bar header */
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-page);
            color: var(--text-main);
            line-height: 1.5;
            padding-top: var(--header-height);
        }

        .container { width: 100%; max-width: 1600px; margin: 0 auto; padding: 20px 40px; }

        /* SMART HEADER CONTAINER */
        #smartHeader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--bg-surface);
            z-index: 2000;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease-out;
            height: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            border-bottom: 1px solid var(--border-color);
        }
        
        #smartHeader.hidden-header { transform: translateY(-85%); }
        
        /* 1. Top Banner (Dark Blue) - Contains Title & Date */
        .header { 
            background: var(--primary-dark); 
            padding: 15px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: white;
        }
        .title-section h1 { color: white; font-size: 20px; font-weight: 700; letter-spacing: 0.02em; margin: 0; text-transform: uppercase; }
        .date-display { color: #e2e8f0; font-weight: 500; font-size: 14px; }

        /* 2. Controls Bar (White) - Contains Location & Tabs */
        .controls-bar {
            padding: 10px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
            gap: 20px;
            flex-wrap: wrap;
        }

        /* Location Selector - Clean text style */
        .location-selector { display: flex; align-items: center; gap: 10px; }
        .location-selector label { font-weight: 600; font-size: 13px; text-transform: uppercase; color: var(--text-muted); }
        .location-selector select { 
            padding: 6px 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            font-size: 14px; 
            background: var(--bg-page); 
            color: var(--text-main); 
            font-weight: 600; 
            cursor: pointer;
        }
        .location-selector select:hover { border-color: var(--primary-light); }

        /* Tabs - Grey Bubbles */
        .tabs { display: flex; gap: 8px; background: transparent; padding: 0; border: none; box-shadow: none; }
        .tab { 
            padding: 8px 16px; 
            background: #e2e8f0; /* Grey Bubble */
            border: 1px solid transparent; 
            border-radius: 20px; /* Pill shape */
            cursor: pointer; 
            font-size: 13px; 
            font-weight: 600; 
            color: var(--text-muted); 
            transition: all 0.2s ease; 
        }
        .tab:hover { background: #cbd5e1; color: var(--text-main); }
        .tab.active { 
            background: var(--primary-light); 
            color: white; 
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        /* Filter Bar (Conditional) */
        #calendarControls {
            padding: 10px 40px;
            background: #f1f5f9;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .filter-section { display: flex; gap: 20px; align-items: center; flex: 1; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { margin: 0; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .filter-group select { padding: 4px 8px; font-size: 13px; border: 1px solid var(--border-color); border-radius: 4px; background: white; }
        
        .calendar-nav { display: flex; gap: 5px; margin-left: auto; align-items: center; }
        .calendar-title-container { flex: 1; text-align: center; font-size: 16px; font-weight: 700; color: var(--text-main); padding: 0 15px; }

        .tab-content { min-height: 500px; margin-top: 20px; }
        .card-content { background: var(--bg-surface); padding: 25px; border-radius: 8px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
        .hidden { display: none !important; }

        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row > div { flex: 1; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        input, select, textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; background: white; color: var(--text-main); transition: border-color 0.15s; }
        input:focus, select:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .radio-group { display: flex; align-items: center; gap: 15px; }
        .radio-group label { display: flex; align-items: center; gap: 5px; font-weight: 500; text-transform: none; margin: 0; cursor: pointer; color: var(--text-main); }
        .radio-group input[type="radio"] { width: auto; margin: 0; }

        /* Buttons */
        .btn { padding: 8px 16px; border: 1px solid transparent; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
        .btn-primary { background: var(--primary-light); color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: white; color: var(--text-main); border-color: var(--border-color); }
        .btn-secondary:hover { background: #f8fafc; border-color: #94a3b8; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-sm { padding: 4px 10px; font-size: 11px; }

        /* Action Bubbles */
        .action-bubble { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; cursor: pointer; margin-right: 4px; border: 1px solid transparent; transition: all 0.2s; text-decoration: none; line-height: 1; letter-spacing: 0.02em; }
        .action-bubble.edit { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
        .action-bubble.edit:hover { background: #dbeafe; }
        .action-bubble.archive { background: #fef2f2; color: #b91c1c; border-color: #fecaca; }
        .action-bubble.archive:hover { background: #fee2e2; }
        .action-bubble.view { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
        .action-bubble.view:hover { background: #dcfce7; }
        .action-bubble.delete { background: #f1f5f9; color: #475569; border-color: #cbd5e1; }
        .action-bubble.delete:hover { background: #e2e8f0; color: #0f172a; }
        .action-bubble.restore { background: #dcfce7; color: #166534; border-color: #86efac; }

        /* Log Bubble Style */
        .log-bubble { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 11px; color: #334155; cursor: pointer; transition: all 0.2s ease; max-width: 100%; overflow: hidden; }
        .log-bubble:hover { background-color: #e2e8f0; border-color: #94a3b8; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .log-bubble.empty { border-style: dashed; color: #94a3b8; background-color: transparent; }
        .log-bubble-time { font-weight: 700; color: #64748b; font-size: 10px; }
        .log-bubble-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .icon-btn { display: none; }

        /* Layouts */
        .location-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .location-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; background: white; transition: all 0.3s ease; box-shadow: var(--card-shadow); }
        .location-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: var(--primary-light); }
        
        .table-container { overflow-x: auto; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        th { background: var(--primary-dark); font-weight: 600; color: white; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; }
        td { color: var(--text-main); font-weight: 500; }
        tr:hover td { background-color: #f8fafc; }
        .scratched { text-decoration: line-through; color: #94a3b8; background-color: #f1f5f9; opacity: 0.7; }
        .refused-text { color: #ef4444 !important; font-weight: 700; }

        .calendar-wrapper { display: flex; gap: 25px; align-items: flex-start; }
        .calendar-main-content { flex: 1; }
        .calendar-actions-sidebar { width: 260px; position: sticky; top: 260px; z-index: 900; }
        
        .actions-sidebar-section { background: white; padding: 20px; border-radius: 8px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); }
        .assignment-bubbles-container { display: grid; grid-template-columns: 1fr; gap: 8px; } 
        .assignment-bubble { color: white; text-align: center; padding: 8px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }

        /* Calendar Styling */
        .shift-section { background: white; border-radius: 8px; box-shadow: var(--card-shadow); margin-bottom: 30px; border: 1px solid var(--border-color); overflow: hidden; }
        
        .calendar-grid { display: grid; border: none; }
        .calendar-week-view { grid-template-columns: 200px repeat(7, 1fr); }
        .calendar-week-view > div { border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; }
        
        .calendar-header-row { display: grid; grid-template-columns: 200px repeat(7, 1fr); margin-bottom: 10px; border-radius: 6px; overflow: hidden; box-shadow: var(--card-shadow); }
        .calendar-header-cell { background: var(--primary-dark); font-weight: 700; text-align: center; padding: 12px; color: white; text-transform: uppercase; font-size: 12px; border-right: 1px solid rgba(255,255,255,0.1); }
        
        .calendar-month-view { grid-template-columns: repeat(7, 1fr); grid-auto-rows: 140px; background: white; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .calendar-month-view .calendar-cell { border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        
        .calendar-cell { background: white; padding: 6px; min-height: 90px; position: relative; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; cursor: pointer; transition: background 0.2s; }
        .calendar-cell:hover { background: #f8fafc; }
        .calendar-cell.other-month { background: #f9fafb; }

        .shift-header-cell { padding: 15px; font-weight: 700; color: white; text-align: left; display: flex; align-items: center; font-size: 15px; grid-column: 1 / 2; }
        .shift-staffing-cell { background: #f1f5f9; display: flex; justify-content: center; align-items: center; padding: 6px; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .schedule-name-cell { padding: 12px; font-weight: 600; background: #f8fafc; display: flex; align-items: center; color: #334155; font-size: 13px; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }

        .staffing-level { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; min-width: 50px; text-align: center; }
        .staffing-under { background-color: #fee2e2; color: #991b1b; }
        .staffing-full { background-color: #dcfce7; color: #166534; }
        .staffing-over { background-color: #dbeafe; color: #1e40af; }

        .draggable { cursor: pointer; padding: 4px 8px; background: white; border-radius: 4px; margin: 2px 0; font-size: 11px; border: 1px solid #e2e8f0; border-left-width: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .draggable:hover { transform: translateX(2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-color: var(--primary-light); }
        .drag-over { background: #eff6ff !important; outline: 2px dashed var(--primary-light); outline-offset: -2px; }

        /* Daily View Assignment Item */
        .daily-assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left-width: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .daily-assignment-item:hover {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-color: #cbd5e1;
        }
        .daily-assignment-name { font-size: 14px; font-weight: 600; }
        
        .assignment-tag { font-size: 9px; font-weight: 700; padding: 2px 5px; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .status-vacant { background: #fff7ed; color: #c2410c; text-align: center; padding: 10px; border-radius: 6px; font-size: 12px; border: 1px dashed #fdba74; margin-top: 5px; background-image: repeating-linear-gradient(45deg, #fff7ed, #fff7ed 10px, #ffedd5 10px, #ffedd5 20px); }
        
        /* RDO and Vacant Indicators */
        .vacant-slot-indicator { margin-top: 4px; padding: 6px; background-color: #fff1f2; border: 1px dashed #f43f5e; color: #be123c; font-size: 10px; text-align: center; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .rdo-slot-indicator { margin-top: 4px; padding: 6px; background-color: #f8fafc; border: 1px dashed #94a3b8; color: #64748b; font-size: 10px; text-align: center; border-radius: 4px; font-weight: bold; text-transform: uppercase; opacity: 0.8; }

        /* Floating Action Bar */
        .floating-action-bar { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: white; padding: 15px 30px; border-radius: 50px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); display: flex; align-items: center; gap: 25px; z-index: 1500; transition: bottom 0.4s; }
        .floating-action-bar.visible { bottom: 30px; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 3000; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 90vw; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .close-modal { background: #f1f5f9; border: 1px solid #e2e8f0; font-size: 24px; cursor: pointer; color: #64748b; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .close-modal:hover { background: #e2e8f0; color: var(--text-main); border-color: #cbd5e1; }

        /* Admin Tabs within Modal */
        .admin-modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .admin-modal-tabs .tab { 
            background: transparent; 
            border: none; 
            border-bottom: 2px solid transparent; 
            border-radius: 0; 
            color: var(--text-muted); 
            padding: 10px 15px;
        }
        .admin-modal-tabs .tab:hover { background: #f8fafc; color: var(--primary-light); }
        .admin-modal-tabs .tab.active { border-bottom-color: var(--primary-light); color: var(--primary-light); background: transparent; box-shadow: none; }

        .ot-signup-badge { position: absolute; top: 4px; right: 4px; background-color: var(--accent-color); color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; cursor: pointer; z-index: 10; border: 1px solid rgba(255,255,255,0.2); }
        
        .ot-cell-selected { background-color: #dbeafe !important; border: 2px solid var(--accent-color) !important; }
        .ot-count-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; background: #f1f5f9; font-weight: bold; font-size: 12px; cursor: pointer; border: 1px solid #cbd5e1; }
        .ot-count-badge:hover { background: #e2e8f0; }

        /* New OT Calendar Item Styles */
        .ot-shift-block { 
            cursor: pointer; 
            padding: 6px 8px; 
            margin-bottom: 4px; 
            border-radius: 6px; 
            font-size: 11px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 4px solid transparent;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        .ot-shift-block:hover { transform: translateX(2px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-color: #94a3b8; }
        .ot-shift-block.has-volunteers { background-color: #f0fdf4; border-color: #bbf7d0; }
        .ot-shift-block.selected { background-color: #eff6ff; border-color: var(--primary-light); box-shadow: 0 0 0 2px var(--primary-light); }
        
        /* New Split Layout for OT Calendar */
        .ot-shift-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: stretch; }
        
        .ot-signup-bubble { 
            flex: 1; 
            cursor: pointer; 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-size: 12px; 
            background: white; 
            border: 1px solid #e2e8f0; 
            border-left: 4px solid transparent; 
            transition: all 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .ot-signup-bubble:hover { transform: translateY(-1px); border-color: #94a3b8; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .ot-signup-bubble.selected { background-color: #eff6ff; border-color: var(--primary-light); box-shadow: 0 0 0 2px var(--primary-light); }
        
        .ot-signup-icon { font-weight: bold; font-size: 14px; color: #cbd5e1; margin-left: 8px; }
        .ot-signup-bubble:hover .ot-signup-icon { color: var(--primary-light); }
        .ot-signup-bubble.selected .ot-signup-icon { color: var(--primary-light); }
        
        .ot-view-bubble { 
            min-width: 50px; 
            cursor: pointer; 
            padding: 0 10px; 
            border-radius: 6px; 
            background: #f8fafc; 
            border: 1px solid #e2e8f0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: 700; 
            color: #64748b; 
            transition: all 0.2s;
        }
        .ot-view-bubble:hover { background-color: #e2e8f0; border-color: #94a3b8; }
        .ot-view-bubble.has-volunteers { background-color: #dcfce7; color: #166534; border-color: #86efac; }

        /* OT Calendar Grid - Clearer Boundaries */
        .ot-calendar-grid {
            gap: 1px;
            background-color: #cbd5e1; /* Softer grid lines */
            border: 1px solid #cbd5e1;
        }
        .ot-calendar-grid .calendar-cell { min-height: 140px; padding: 8px; }
        
        /* Monthly View Improvements */
        .monthly-shift-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            margin-bottom: 4px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left-width: 4px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .monthly-shift-summary:hover { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transform: translateX(2px); }
        .count-badge { background: #e2e8f0; color: #475467; padding: 2px 6px; border-radius: 10px; font-weight: 700; font-size: 10px; }
        .monthly-assignment-pill {
            padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-bottom: 4px;
            cursor: pointer; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .ot-calendar-grid .calendar-header-cell {
            border: none !important;
        }

        .contact-log-entry { font-size: 11px; color: #64748b; border-left: 2px solid #cbd5e1; padding-left: 8px; margin-bottom: 4px; }
        .contact-log-timestamp { font-size: 9px; color: #94a3b8; font-weight: 600; }

        /* Professional Weekly Hours Table */
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; color: #334155; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .modern-table thead th { background-color: var(--primary-dark); color: white; font-weight: 600; text-transform: uppercase; font-size: 11px; padding: 12px 16px; border-bottom: 1px solid #475467; text-align: center; border-right: 1px solid rgba(255,255,255,0.1); }
        .modern-table thead th:last-child { border-right: none; }
        .modern-table tbody tr { transition: background-color 0.15s; }
        .modern-table tbody tr:hover { background-color: #f8fafc; }
        .modern-table tbody td { padding: 12px 16px; border-bottom: 1px solid var(--border-color); text-align: center; vertical-align: middle; border-right: 1px solid #f1f5f9; }
        .modern-table tbody td:first-child { text-align: left; font-weight: 600; color: #1e293b; border-right: 1px solid var(--border-color); background: #f8fafc; }
        .modern-table tbody tr:last-child td { border-bottom: none; }
        .total-cell { font-weight: 700; color: var(--primary-dark); background-color: #e2e8f0; border-radius: 6px; padding: 4px 8px; border: 1px solid #cbd5e1; }

        /* Bubble Table for Roster/Weekly Hours */
        .bubble-container { background: transparent !important; border: none !important; box-shadow: none !important; overflow: visible !important; }
        .employee-bubble-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .employee-bubble-table thead th { background: var(--primary-dark); color: white; font-size: 11px; font-weight: 700; text-transform: uppercase; padding: 12px 15px; text-align: left; border: none; }
        .employee-bubble-table thead th:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; padding-left: 20px; }
        .employee-bubble-table thead th:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        .employee-bubble-table tbody td { background: #f1f5f9; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); border-right: 1px solid #e2e8f0; padding: 10px; vertical-align: top; color: var(--text-main); font-weight: 500; }
        .employee-bubble-table tbody td:first-child { border-left: 1px solid var(--border-color); border-top-left-radius: 12px; border-bottom-left-radius: 12px; font-weight: 600; color: var(--text-main); }
        .employee-bubble-table tbody td:last-child { border-right: 1px solid var(--border-color); border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
        .employee-bubble-table tbody tr { transition: all 0.2s ease; }
        .employee-bubble-table tbody tr:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .employee-bubble-table tbody tr:hover td { border-color: var(--primary-light); }

        @media (max-width: 1200px) { .calendar-wrapper { flex-direction: column; } .calendar-actions-sidebar { position: static; width: 100%; margin-top: 20px; } }
        @media (max-width: 768px) { .form-row { flex-direction: column; } .tabs { flex-wrap: wrap; } .calendar-week-view, .calendar-daily-view { grid-template-columns: 80px 1fr; } .location-bar { flex-direction: column; align-items: stretch; } .location-selector { width: 100%; } .container { padding: 10px; } .header { flex-direction: column; align-items: flex-start; gap: 10px; } }
        @media print { 
            .tabs, .action-buttons, .filter-section, .btn, .location-bar, .calendar-actions-sidebar, .sticky-header, .floating-action-bar { display: none !important; } 
            .print-wrapper { break-inside: avoid; page-break-inside: avoid; margin-bottom: 20px; display: block; }
            .shift-section { border: 1px solid #ccc !important; box-shadow: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        .locked { opacity: 0.6; cursor: not-allowed !important; pointer-events: none; filter: grayscale(0.8); position: relative; }
        .btn-locked { opacity: 0.6; cursor: not-allowed !important; pointer-events: none; background-color: #94a3b8 !important; border-color: #cbd5e1 !important; color: white !important; }

        /* Admin Tiles - Professional Look */

        /* Home Page Tiles */
        .home-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .location-selector-tile { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .location-selector-tile h2 { margin: 0 0 15px 0; font-size: 24px; font-weight: 700; }
        .location-selector-tile select { width: 100%; max-width: 400px; padding: 12px 16px; font-size: 16px; border: none; border-radius: 8px; background: white; color: #2c3e50; }
        .home-tiles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .home-tile { background: white; border: 1px solid var(--border-color); border-radius: 16px; padding: 30px; cursor: pointer; transition: all 0.3s ease; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .home-tile:hover { transform: translateY(-8px); box-shadow: 0 12px 32px rgba(0,0,0,0.15); border-color: var(--primary-light); }
        .home-tile-icon { width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .home-tile-title { font-size: 20px; font-weight: 700; color: var(--text-main); margin: 0; }

        /* Shift Item Drag and Drop */
        .shift-item { background: white; border: 1px solid var(--border-color); border-left: 4px solid; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: move; transition: all 0.2s; }
        .shift-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .shift-item.dragging { opacity: 0.5; transform: scale(0.98); }
        .admin-tile { background: white; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .admin-tile:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); border-color: var(--primary-light); }
        .admin-tile-icon { width: 70px; height: 70px; margin: 0 auto 15px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .admin-tile-title { font-size: 18px; font-weight: 700; color: var(--text-main); margin: 0 0 8px 0; }
        .admin-tile-desc { font-size: 13px; color: var(--text-muted); margin: 0; line-height: 1.5; }
    </style>
</head>
<body>
    <div id="smartHeader">
        <!-- 1. Top Banner (Dark Blue) -->
        <div class="header" style="position: relative;">
            <div class="title-section"><h1 id="mainTitle" onclick="goHome()" style="cursor: pointer;">Weekly Schedule</h1></div>
            <div id="currentTabTitle" style="position: absolute; left: 50%; transform: translateX(-50%); font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">HOME</div>
            <div style="display:flex; align-items:center; gap:15px;">
                <button id="loginBtn" class="btn btn-secondary btn-sm" onclick="showLoginModal()">Login</button>
                <button id="saveBtn" class="btn btn-success btn-sm" onclick="saveToFirebase()">Save Changes</button>
                <button class="btn btn-warning" onclick="openTutorials()" style="font-weight:800; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.2);">ðŸŽ“ TUTORIALS</button>
                <button id="headerPrintBtn" class="btn btn-primary btn-sm hidden" onclick="promptPrint('calendarContainer', 'Schedule Calendar')">Print Schedule</button>
                <button class="btn btn-secondary btn-sm" onclick="goHome()">Home</button>
                <div class="date-display"><span id="currentDate"></span></div>
            </div>
        </div>

        <div id="calendarControls" class="hidden"></div>
    </div>

    <div class="container">
        <div id="home" class="tab-content"></div>
        <div id="calendar" class="tab-content hidden"></div>
        <div id="roster" class="tab-content hidden card-content"></div>
        <div id="weeklyHours" class="tab-content hidden card-content"></div>
        <div id="overtime" class="tab-content hidden card-content"></div>
        <div id="vacation" class="tab-content hidden card-content"></div>
    </div>

    <div id="modalContainer"></div>
    <div id="floatingBarContainer"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA77qciskztlJKiQUI0J4By3aX2D9B328k",
          authDomain: "reentry-scheduler.firebaseapp.com",
          databaseURL: "https://reentry-scheduler-default-rtdb.firebaseio.com",
          projectId: "reentry-scheduler",
          storageBucket: "reentry-scheduler.firebasestorage.app",
          messagingSenderId: "562567578320",
          appId: "1:562567578320:web:8839cba90d5bafad0554d5",
          measurementId: "G-Z56QEFLPCB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const ROLES = { OWNER: 'Owner', ADMIN: 'Admin', EMPLOYEE: 'Employee', GUEST: 'Guest' };
        let currentUser = null; // { id, name, role, ... }
        // --- Constants ---
        const ASSIGNMENT_TYPES = { REGULAR: 'Regular Work Schedule', OVERTIME_V: 'Voluntary Overtime', OVERTIME_M: 'Mandatory Overtime', ON_CALL: 'On-Call Work Schedule', VACATION: 'Vacation', VACATION_SEGMENT: 'Vacation Segment', RDO: 'Regular Day Off', SCDO: 'Schedule Change Day Off', SDO: 'Scheduled Day Off', TRAINING: 'Training' };
        const OVERTIME_ASSIGNMENTS = [ASSIGNMENT_TYPES.OVERTIME_V, ASSIGNMENT_TYPES.OVERTIME_M];
        const ADDITIVE_TYPES = [ASSIGNMENT_TYPES.OVERTIME_V, ASSIGNMENT_TYPES.OVERTIME_M, ASSIGNMENT_TYPES.ON_CALL];
        const WORKING_HOUR_TYPES = [ASSIGNMENT_TYPES.REGULAR, ...OVERTIME_ASSIGNMENTS, ASSIGNMENT_TYPES.TRAINING, ASSIGNMENT_TYPES.ON_CALL];
        const TIME_OFF_HOUR_TYPES = [ASSIGNMENT_TYPES.SCDO, ASSIGNMENT_TYPES.VACATION, ASSIGNMENT_TYPES.VACATION_SEGMENT, ASSIGNMENT_TYPES.SDO, ASSIGNMENT_TYPES.RDO];
        const SHIFT_COLORS = [
            { name: 'Blue', value: '#3b82f6' },
            { name: 'Green', value: '#10b981' },
            { name: 'Red', value: '#ef4444' },
            { name: 'Amber', value: '#f59e0b' },
            { name: 'Purple', value: '#8b5cf6' },
            { name: 'Teal', value: '#06b6d4' },
            { name: 'Pink', value: '#ec4899' },
            { name: 'Slate', value: '#64748b' }
        ];
        
        const globalData = { locations: [], currentLocation: null, settings: { maxLocations: 20 }, logs: [] };
        let hasUnsavedChanges = false;
        let currentData = null;
        let currentCalendarDate = new Date();
        let calendarViewType = 'weekly';
        let draggedElement = null;
        let overtimeSelectedDates = [];
        let isEmployeeTypeEditingUnlocked = false;
        let selectedSidebarEmployeeId = "";
        let lastScrollY = 0;
        let isQuickAssignExpanded = false;
        let weeklyHoursViewMode = 'active';
        let currentVoluntaryFilter = null;
        let currentMandatoryFilter = null;

        class Location {
            constructor(name) {
                this.id = 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.name = name;
                this.archived = false;
                this.archivedAt = null;

                const defaultShifts = this.getDefaultShifts();
                const trainingShift = { id: generateId(), name: 'Training', color: '#334155', startTime: '08:00', endTime: '16:00', order: 99, minEmployees: 0, archived: false };
                const trainingSchedule = { id: generateId(), name: 'Training', shiftId: trainingShift.id, workDays: [1,2,3,4,5], archived: false, order: 999 };

                this.data = {
                    employees: [], 
                    shifts: [...defaultShifts, trainingShift], 
                    schedules: [trainingSchedule], 
                    assignments: [],
                    overtimeSignups: [], overtimeScratches: { voluntary: [], mandatory: [] }, overtimeLists: { voluntary: [], mandatory: [] }, overtimeNotes: {}, overtimeRefusals: {},
                    vacationSchedules: [], vacationAssignments: [], 
                    employeeTypes: this.getDefaultEmployeeTypes(),
                    logs: [], 
                    config: { title: 'Weekly Schedule' }
                };
            }
            getDefaultShifts() { return [{ id: generateId(), name: 'Graveyard', color: '#f59e0b', startTime: '22:00', endTime: '06:00', order: 1, minEmployees: 1, archived: false }, { id: generateId(), name: 'Day Shift', color: '#3b82f6', startTime: '06:00', endTime: '14:00', order: 2, minEmployees: 2, archived: false }, { id: generateId(), name: 'Swing Shift', color: '#10b981', startTime: '14:00', endTime: '22:00', order: 3, minEmployees: 2, archived: false }]; }
            getDefaultEmployeeTypes() { return [{ id: generateId(), name: 'Full-time', isDefault: true }, { id: generateId(), name: 'On-call', isDefault: true }, { id: generateId(), name: 'Sergeant', isDefault: true }]; }
        }

        function generateId() { return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); }
        
        function generateCredentials(name) {
            let firstName = "";
            let lastName = "";
            
            if (name.includes(',')) {
                const parts = name.split(',');
                lastName = parts[0].trim();
                firstName = parts.length > 1 ? parts[1].trim() : "";
            } else {
                const parts = name.trim().split(/\s+/);
                if (parts.length > 0) {
                    firstName = parts[0];
                    lastName = parts.slice(1).join('');
                }
            }

            let username = (firstName.length >= 2 ? firstName.substring(0, 2) : firstName) + lastName.replace(/\s+/g, '');
            if (!username) username = "user" + Math.floor(Math.random() * 1000);

            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%";
            let password = "";
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return { username, password };
        }

        // --- Logging System ---
        function logAction(action, details, target = null) {
            const user = currentUser ? `${currentUser.name} (${currentUser.username})` : 'System/Guest';
            const timestamp = new Date().toISOString();
            const entry = { timestamp, user, action, details };
            
            // Mark as unsaved for data-modifying actions
            if (action !== 'Login' && action !== 'Logout') {
                hasUnsavedChanges = true;
                const btn = document.getElementById('saveBtn');
                if (btn && !btn.textContent.includes('*')) btn.textContent = 'Save Changes *';
            }
            
            if (target) {
                if (!target.logs) target.logs = [];
                target.logs.push(entry);
            } else {
                // Fallback to general log (Location level or Global level)
                if (currentData) {
                    if (!currentData.logs) currentData.logs = [];
                    currentData.logs.push(entry);
                } else {
                     if (!globalData.logs) globalData.logs = [];
                     globalData.logs.push(entry);
                }
            }
        }

        // FIXED: Helper to create a LOCAL Date object from a YYYY-MM-DD string
        // This prevents the UTC timezone shift issue (offsetting dates by -1 day)
        function getLocalDateFromStr(dateStr) {
            if (!dateStr) return new Date();
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // FIXED: Helper to ensure local dates are formatted as YYYY-MM-DD without timezone shifts
        function getLocalDateString(date) { 
            const year = date.getFullYear(); 
            const month = String(date.getMonth() + 1).padStart(2, '0'); 
            const day = String(date.getDate()).padStart(2, '0'); 
            return `${year}-${month}-${day}`; 
        }
        function formatDate(dateString) { if (!dateString) return 'N/A'; const d = getLocalDateFromStr(dateString); return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
        function getTodayDateString() { return getLocalDateString(new Date()); }
        function getWeekDates(startDate) { const dates = []; const start = new Date(startDate); start.setDate(start.getDate() - start.getDay()); for (let i = 0; i < 7; i++) { const date = new Date(start); date.setDate(start.getDate() + i); dates.push(date); } return dates; }
        function getAssignmentColor(type) { const map = { [ASSIGNMENT_TYPES.REGULAR]: '#3b82f6', [ASSIGNMENT_TYPES.ON_CALL]: '#93c5fd', [ASSIGNMENT_TYPES.VACATION]: '#10b981', [ASSIGNMENT_TYPES.VACATION_SEGMENT]: '#047857', [ASSIGNMENT_TYPES.TRAINING]: '#334155', [ASSIGNMENT_TYPES.RDO]: '#94a3b8', [ASSIGNMENT_TYPES.OVERTIME_V]: '#8b5cf6', [ASSIGNMENT_TYPES.OVERTIME_M]: '#581c87' }; return map[type] || '#64748b'; }
        function getContrastColor(hex) { if (!hex || hex.length < 7) return '#ffffff'; const r = parseInt(hex.substr(1, 2), 16); const g = parseInt(hex.substr(3, 2), 16); const b = parseInt(hex.substr(5, 2), 16); const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000; return (yiq >= 128) ? '#000000' : '#ffffff'; }
        function getEmployeeName(id) { const e = currentData.employees.find(x => x.id === id); return e ? e.name : 'Unknown'; }
        function getFullTimeEmployees() { const ftType = currentData.employeeTypes.find(t => t.name === 'Full-time'); if(!ftType) return []; return currentData.employees.filter(e => e.type === ftType.id && !e.archived); }

        window.onload = function() {
            loadFromFirebase(); // Load data on startup
            if (globalData.locations.length === 0) { globalData.locations.push(new Location('Main Location')); }
            updateLocationUI();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('currentTabTitle').textContent = 'HOME';
            
            goHome(); 
            window.addEventListener('scroll', () => { const header = document.getElementById('smartHeader'); if(window.scrollY > 50 && window.scrollY > lastScrollY) { header.classList.add('hidden-header'); } else { header.classList.remove('hidden-header'); } lastScrollY = window.scrollY; });
            window.addEventListener('mousemove', (e) => { if(e.clientY < 50) document.getElementById('smartHeader').classList.remove('hidden-header'); });
            document.getElementById('smartHeader').addEventListener('mouseleave', () => { if (window.scrollY > 50) { document.getElementById('smartHeader').classList.add('hidden-header'); } });
            
            // Prevent accidental tab close
            window.addEventListener('beforeunload', function (e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        };

        // --- Firebase Functions ---
        function saveToFirebase() {
            const btn = document.getElementById('saveBtn');
            if(btn) btn.textContent = 'Saving...';

            // NEW LOGIC: Move the "current" work into the "global" storage
            if (globalData.currentLocation && currentData) {
                const locIndex = globalData.locations.findIndex(l => l.id === globalData.currentLocation);
                if (locIndex !== -1) {
                    // This line "packs" your employees into the global box
                    globalData.locations[locIndex].data = currentData;
                }
            }

            // Now send the FULL package to Firebase
            db.ref('scheduleData').set(globalData)
            .then(() => {
                console.log("Cloud Update Successful!");
                hasUnsavedChanges = false;
                if(btn) btn.textContent = 'Save Changes';
                alert("Synced to Firebase successfully! All employees are now in the cloud.");
            })
            .catch((error) => {
                if(btn) btn.textContent = 'Save Changes';
                console.error("Cloud Save Failed:", error);
                alert("Save failed: " + error.message);
            });
        }

        function loadFromFirebase() {
            const btn = document.getElementById('saveBtn');
            if(btn) btn.textContent = 'Loading...';

            db.ref('scheduleData').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    globalData.locations = data.locations || [];
                    globalData.currentLocation = data.currentLocation;
                    globalData.settings = data.settings || { maxLocations: 20 };
                    globalData.logs = data.logs || [];
                    
                    // Sanitize Data to prevent crashes on empty arrays from Firebase
                    globalData.locations.forEach(loc => {
                        if (!loc.data) loc.data = {};
                        const d = loc.data;
                        if (!d.employees) d.employees = [];
                        if (!d.shifts) d.shifts = [];
                        if (!d.schedules) d.schedules = [];
                        if (!d.assignments) d.assignments = [];
                        if (!d.overtimeSignups) d.overtimeSignups = [];
                        if (!d.overtimeScratches) d.overtimeScratches = { voluntary: [], mandatory: [] };
                        if (!d.overtimeLists) d.overtimeLists = { voluntary: [], mandatory: [] };
                        if (!d.overtimeNotes) d.overtimeNotes = {};
                        if (!d.overtimeRefusals) d.overtimeRefusals = {};
                        if (!d.vacationSchedules) d.vacationSchedules = [];
                        if (!d.vacationAssignments) d.vacationAssignments = [];
                        if (!d.employeeTypes) d.employeeTypes = [];
                        if (!d.logs) d.logs = [];
                        if (!d.config) d.config = { title: 'Weekly Schedule' };
                        
                        // Ensure sub-items have logs array
                        d.employees.forEach(e => { if(!e.logs) e.logs = []; });
                        d.shifts.forEach(s => { if(!s.logs) s.logs = []; });
                        d.schedules.forEach(s => { if(!s.logs) s.logs = []; });
                    });

                    if (globalData.currentLocation) {
                        const loc = globalData.locations.find(l => l.id === globalData.currentLocation);
                        if (loc) currentData = loc.data;
                    }
                    updateLocationUI();
                    if (!document.getElementById('home').classList.contains('hidden')) loadHome();
                }
                if(btn) btn.textContent = 'Save Changes';
            }).catch((error) => {
                if(btn) btn.textContent = 'Save Changes';
                console.error("Firebase Load Error:", error);
            });
        }

        // --- Account Management ---
        function showMyAccountModal() {
            if (!currentUser) return alert("Please login first.");
            if (currentUser.id === 'master') return alert("Master account cannot be edited.");
            
            createModal('My Account', `
                <div class="form-group"><label>Username</label><input type="text" value="${currentUser.username || ''}" disabled style="background:#f1f5f9; color:#64748b; cursor:not-allowed;"></div>
                <div class="form-group"><label>Password</label><input type="text" id="myAccountPass" value="${currentUser.password || ''}"></div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveMyAccount()">Update Password</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `, '400px');
        }

        function saveMyAccount() {
            const newPass = document.getElementById('myAccountPass').value;
            if (!newPass) return alert("Password cannot be empty.");
            
            let empFound = false;
            // Search all locations to find and update the user record
            for (const loc of globalData.locations) {
                const emp = loc.data.employees.find(e => e.id === currentUser.id);
                if (emp) {
                    emp.password = newPass;
                    currentUser.password = newPass;
                    empFound = true;
                    // If this is the currently loaded location, ensure UI might reflect if needed (though password isn't shown)
                }
            }

            if (empFound) {
                // We can't easily log to the specific employee object here without finding it again in the structure, 
                // but since it's the current user, we can try. For now, system log is acceptable for self-change or we rely on the loop above.
                // Actually, let's just log to system as "User X changed password"
                logAction('Password Change', 'User changed their own password');
                alert("Password updated successfully.");
                saveToFirebase();
                closeModal();
            } else {
                // Fallback if user is somehow not in globalData (e.g. master or glitch)
                currentUser.password = newPass;
                alert("Session password updated (Record not found in storage).");
                closeModal();
            }
        }

        // --- Login System ---
        function showLoginModal() {
            createModal('Login', `
                <div class="form-group"><label>Username</label><input type="text" id="loginUser"></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPass"></div>
                <div class="action-buttons"><button class="btn btn-primary" onclick="performLogin()">Login</button></div>
            `, '400px');
        }

        function performLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            
            // Master Admin Backdoor
            if (u === 'admin' && p === 'admin') {
                currentUser = { id: 'master', name: 'Master Admin', role: ROLES.OWNER };
                updateLoginUI();
                closeModal();
                return;
            }

            let foundEmp = null;
            let foundLocId = null;

            // Search all locations for the user
            for (const loc of globalData.locations) {
                if (loc.archived) continue;
                const emp = loc.data.employees.find(e => e.username === u && e.password === p && !e.archived);
                if (emp) {
                    foundEmp = emp;
                    foundLocId = loc.id;
                    break;
                }
            }

            if (foundEmp) {
                currentUser = { ...foundEmp, role: foundEmp.systemRole || ROLES.EMPLOYEE };
                
                // Determine target location: User's default -> Location found in -> Current Global
                const targetLocId = foundEmp.defaultLocation || foundLocId;
                const targetLoc = globalData.locations.find(l => l.id === targetLocId && !l.archived);
                
                if (targetLoc) {
                    globalData.currentLocation = targetLoc.id;
                    currentData = targetLoc.data;
                    updateLocationUI();
                }

                logAction('Login', `User logged in: ${foundEmp.name}`, foundEmp);
                updateLoginUI();
                closeModal();
                goHome();
            } else {
                alert('Invalid credentials');
            }
        }

        function logout() { 
            if (hasUnsavedChanges) {
                if (!confirm("You have unsaved changes. If you log out now, they may be lost. Are you sure you want to log out?")) return;
            }
            logAction('Logout', 'User logged out'); 
            currentUser = null; updateLoginUI(); goHome(); 
        }
        function updateLoginUI() {
            const btn = document.getElementById('loginBtn');
            if (currentUser) { btn.textContent = `Logout (${currentUser.name})`; btn.onclick = logout; }
            else { btn.textContent = 'Login'; btn.onclick = showLoginModal; }
        }


        function goHome() {
            document.getElementById('calendarControls').classList.add('hidden');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('home').classList.remove('hidden');
            document.body.style.paddingTop = '70px';
            document.getElementById('currentTabTitle').textContent = 'HOME';
            document.getElementById('headerPrintBtn').classList.add('hidden');
            loadHome();
        }
        function loadHome() {
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const lockAdmin = (role === ROLES.EMPLOYEE || role === ROLES.GUEST) ? 'locked' : '';
            const lockRestricted = (role === ROLES.GUEST) ? 'locked' : '';

            const container = document.getElementById('home');
            var html = '<div class="home-container">';
            html += '<div class="location-selector-tile">';
            html += '<div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px;">';
            html += '<div><h2 style="margin:0 0 10px 0;">ðŸ“ Select Your Location</h2>';
            html += '<select id="homeLocationSelect" onchange="switchLocationFromHome()" style="cursor: pointer;">';
            html += '<option value="">-- Select Location --</option>';
            globalData.locations.filter(l => !l.archived).forEach(l => {
                html += '<option value="' + l.id + '" ' + (l.id === globalData.currentLocation ? 'selected' : '') + '>' + l.name + '</option>';
            });
            html += '</select></div>';
            if (currentUser) {
                html += `<div style="display:flex; gap:10px; align-items:center;"><button class="btn btn-secondary" onclick="showMyAccountModal()">View Account</button><button class="btn btn-danger" onclick="logout()">Log Out</button></div>`;
            }
            html += '</div>';
            html += '</div>';
            html += '<div class="home-tiles-grid">';
            html += '<div class="home-tile" onclick="navigateToTab(\'calendar\')">';
            html += '<div class="home-tile-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ðŸ“…</div>';
            html += '<h3 class="home-tile-title">Schedule Calendar</h3>';
            html += '</div>';
            html += '<div class="home-tile" onclick="navigateToTab(\'roster\')">';
            html += '<div class="home-tile-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">ðŸ‘¥</div>';
            html += '<h3 class="home-tile-title">Roster</h3>';
            html += '</div>';
            html += '<div class="home-tile" onclick="navigateToTab(\'weeklyHours\')">';
            html += '<div class="home-tile-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">â°</div>';
            html += '<h3 class="home-tile-title">Weekly Hours</h3>';
            html += '</div>';
            html += `<div class="home-tile ${lockRestricted}" onclick="navigateToTab('overtime')">`;
            html += '<div class="home-tile-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">ðŸ’¼</div>';
            html += '<h3 class="home-tile-title">Overtime</h3>';
            html += '</div>';
            html += `<div class="home-tile ${lockRestricted}" onclick="navigateToTab('vacation')">`;
            html += '<div class="home-tile-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ðŸ–ï¸</div>';
            html += '<h3 class="home-tile-title">Vacation Segments</h3>';
            html += '</div>';
            html += `<div class="home-tile ${lockAdmin}" onclick="showAdminPanel()">`;
            html += '<div class="home-tile-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">âš™ï¸</div>';
            html += '<h3 class="home-tile-title">Admin Settings</h3>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            container.innerHTML = html;
        }

        function switchLocationFromHome() {
            const id = document.getElementById('homeLocationSelect').value;
            if (!id) { globalData.currentLocation = null; currentData = null; return; }
            globalData.currentLocation = id;
            currentData = globalData.locations.find(l => l.id === id).data;
            if(!currentData.overtimeNotes) currentData.overtimeNotes = {};
            updateLocationUI();
        }

        function navigateToTab(tabName) {
            if (!currentData) return alert('Please select a location first.');
            document.getElementById('home').classList.add('hidden');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            
            const titles = {
                'calendar': 'Schedule Calendar',
                'roster': 'Roster',
                'weeklyHours': 'Weekly Hours',
                'overtime': 'Overtime',
                'vacation': 'Vacation Segments'
            };
            document.getElementById('currentTabTitle').textContent = titles[tabName] || '';

            if (tabName === 'calendar') {
                document.getElementById('calendarControls').classList.remove('hidden');
                document.body.style.paddingTop = '130px';
                document.getElementById('headerPrintBtn').classList.remove('hidden');
            } else {
                document.getElementById('calendarControls').classList.add('hidden');
                document.body.style.paddingTop = '70px';
                document.getElementById('headerPrintBtn').classList.add('hidden');
            }
            
            loadTabContent(tabName);
        }

        function loadTabContent(tabName) { if (!currentData) return; if (tabName === 'roster') loadRoster(); else if (tabName === 'calendar') loadCalendar(); else if (tabName === 'weeklyHours') loadWeeklyHours(); else if (tabName === 'overtime') loadOvertime(); else if (tabName === 'vacation') loadVacation(); }
        function refreshCurrentTab(tabName) { if (tabName) loadTabContent(tabName); }
        function updateLocationDropdown() { if (!document.getElementById('home').classList.contains('hidden')) loadHome(); }
        function switchLocation() { /* No-op */ }
        function updateLocationUI() { if (currentData) document.getElementById('mainTitle').textContent = currentData.config.title; }

        function printContent(containerId, title) {
            const content = document.getElementById(containerId).innerHTML;
            const printWindow = window.open('', '', 'height=600,width=900');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            const styles = document.getElementsByTagName('style');
            for (let i = 0; i < styles.length; i++) { printWindow.document.write(styles[i].outerHTML); }
            printWindow.document.write('<style>body { background: white; padding: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .no-print { display: none; } @media print { @page { size: landscape; } }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h2 style="margin-bottom:20px; color:#334155;">' + title + '</h2>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }

        function promptPrint(containerId, defaultTitle) {
            const title = prompt("Enter Print Title:", defaultTitle);
            if (title !== null) {
                printContent(containerId, title);
            }
        }

        function createModal(title, content, maxWidth = '800px') { document.getElementById('modalContainer').innerHTML = `<div class="modal active"><div class="modal-content" style="max-width: ${maxWidth};"><div class="modal-header"><h2>${title}</h2><button class="close-modal" onclick="closeModal()">Ã—</button></div>${content}</div></div>`; }
        function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }
        function showConfirmationModal(title, message, onConfirm, onCancel) { createModal(title, `<div style="text-align:center; padding:20px;"><p>${message}</p><div class="action-buttons" style="justify-content:center;"><button class="btn btn-secondary" id="cancelModalBtn">Cancel</button><button class="btn btn-primary" id="confirmModalBtn">Confirm</button></div></div>`, '400px'); document.getElementById('confirmModalBtn').onclick = () => { closeModal(); if (onConfirm) onConfirm(); }; document.getElementById('cancelModalBtn').onclick = () => { closeModal(); if (onCancel) onCancel(); }; }
        function showCustomPrompt(message, initialValue, callback) { createModal('Input', `<div class="form-group"><label>${message}</label><input id="promptVal" value="${initialValue||''}" style="width:100%;"></div><div class="action-buttons"><button class="btn btn-primary" id="promptOkBtn">OK</button></div>`, '400px'); const input = document.getElementById('promptVal'); input.focus(); document.getElementById('promptOkBtn').onclick = () => { const val = input.value; closeModal(); if (callback) callback(val); }; input.addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('promptOkBtn').click(); }); }
        function showArchiveModal(title, message, onConfirm, onCancel) { createModal(title, `<div style="padding:10px;"><p>${message}</p><div class="form-group"><label>Effective Archive Date (Remove assignments on and after this date):</label><input type="date" id="archiveDate" value="${getTodayDateString()}"></div><div class="action-buttons"><button class="btn btn-secondary" onclick="cancelArchive()">Cancel</button><button class="btn btn-danger" onclick="confirmArchive()">Archive</button></div></div>`, '450px'); window.confirmArchive = () => { const date = document.getElementById('archiveDate').value; closeModal(); onConfirm(date); }; window.cancelArchive = () => { closeModal(); if(onCancel) onCancel(); }; }

        function loadCalendar() {
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const lockClear = (role === ROLES.ADMIN || role === ROLES.EMPLOYEE || role === ROLES.GUEST) ? 'btn-locked' : '';
            document.getElementById('calendar').innerHTML = `<div style="margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center;"><button class="btn btn-secondary" onclick="goHome()">â† Back to Home</button><div style="display:flex; align-items:center; gap: 15px;"><button class="btn btn-danger ${lockClear}" onclick="clearAssignmentsForMonth()">Clear Month Log</button><div id="quickAssignButtonContainer"></div></div></div><div class="calendar-wrapper"><div class="calendar-main-content" id="calendarContainer"></div><div id="calendarActionsSidebar" class="calendar-actions-sidebar"></div></div>`;
            document.getElementById('calendarControls').innerHTML = `<div class="filter-section"><div class="filter-group"><label>View:</label><select id="calendarViewType" onchange="updateCalendarView()"><option value="weekly">Weekly</option><option value="monthly">Monthly</option><option value="daily">Daily</option></select></div><div class="filter-group"><label>Shift:</label><select id="calendarShiftFilter" onchange="updateCalendarView()"><option value="">All Shifts</option></select></div><div class="filter-group"><label>Employee:</label><select id="calendarEmployeeFilter" onchange="updateCalendarView()"><option value="">All Employees</option></select></div><div class="filter-group"><label>Type:</label><select id="calendarTypeFilter" onchange="updateCalendarView()"><option value="all">All Assignments</option><option value="work">Work Assignments</option><option value="timeoff">Time Off Assignments</option></select></div></div><div class="calendar-nav"><button class="btn btn-secondary" onclick="prevCal()">â†</button><div class="calendar-title-container"><span id="calendarPeriodLabel"></span></div><button class="btn btn-secondary" onclick="nextCal()">â†’</button><button class="btn btn-secondary" onclick="todayCal()">Today</button></div>`;
            updateCalendarFilters(); updateCalendarView();
        }
        function updateCalendarFilters() { const sFilter = document.getElementById('calendarShiftFilter'); if(!sFilter) return; sFilter.innerHTML = '<option value="">All Shifts</option>' + currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s => `<option value="${s.id}">${s.name}</option>`).join(''); const eFilter = document.getElementById('calendarEmployeeFilter'); eFilter.innerHTML = '<option value="">All Employees</option>' + currentData.employees.filter(e => !e.archived && !e.isHidden).map(e => `<option value="${e.id}">${e.name}</option>`).join(''); }
        function updateCalendarView() { const viewSelect = document.getElementById('calendarViewType'); if (!viewSelect) return; calendarViewType = viewSelect.value; const label = document.getElementById('calendarPeriodLabel'); if (!label) return; if(calendarViewType === 'weekly') { const dates = getWeekDates(currentCalendarDate); label.textContent = `${dates[0].toLocaleDateString()} - ${dates[6].toLocaleDateString()}`; displayWeeklyCalendar(); } else if(calendarViewType === 'monthly') { label.textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }); displayMonthlyCalendar(); } else { label.textContent = currentCalendarDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }); displayDailyCalendar(); } renderActionsSidebar(); }
        function prevCal() { if(calendarViewType === 'weekly') currentCalendarDate.setDate(currentCalendarDate.getDate()-7); else if(calendarViewType === 'monthly') currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); else currentCalendarDate.setDate(currentCalendarDate.getDate()-1); updateCalendarView(); }
        function nextCal() { if(calendarViewType === 'weekly') currentCalendarDate.setDate(currentCalendarDate.getDate()+7); else if(calendarViewType === 'monthly') currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); else currentCalendarDate.setDate(currentCalendarDate.getDate()+1); updateCalendarView(); }
        function todayCal() { currentCalendarDate = new Date(); updateCalendarView(); }
        
        function clearAssignmentsForMonth() {
            const monthName = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            showConfirmationModal('Clear Month?', `Delete ALL assignments for ${monthName}? This cannot be undone.`, () => {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                const toRemove = currentData.assignments.filter(a => {
                    const d = getLocalDateFromStr(a.date);
                    return d.getFullYear() === year && d.getMonth() === month;
                });

                toRemove.forEach(ass => syncVacationDelete(ass));

                currentData.assignments = currentData.assignments.filter(a => !toRemove.includes(a));
                updateCalendarView();
                alert(`Cleared schedule for ${monthName}.`);
            });
        }

        function displayWeeklyCalendar() {
            const container = document.getElementById('calendarContainer'); const dates = getWeekDates(currentCalendarDate); const empFilter = document.getElementById('calendarEmployeeFilter').value; const shiftFilter = document.getElementById('calendarShiftFilter').value; const typeFilter = document.getElementById('calendarTypeFilter') ? document.getElementById('calendarTypeFilter').value : 'all';
            let html = '';
            const headerRow = `<div class="calendar-header-row"><div class="calendar-header-cell"></div>` + dates.map(d => `<div class="calendar-header-cell">${d.toLocaleDateString('en-US',{weekday:'short'})} ${d.getDate()}</div>`).join('') + `</div>`;
            
            currentData.shifts.filter(s => (!s.archived || s.archivedAt > dates[6].toISOString()) && (!shiftFilter || s.id === shiftFilter)).sort((a,b)=>(a.order||99)-(b.order||99)).forEach(shift => {
                let shiftHtml = headerRow + `<div class="shift-section"><div class="calendar-grid calendar-week-view"><div class="shift-header-cell" style="background:${shift.color}">${shift.name}</div>`;
                
                // Staffing Row
                if (!empFilter) {
                    dates.forEach(d => {
                        const dateStr = getLocalDateString(d); 
                        const assignmentsOnShift = getFilteredAssignments(dateStr, shift.id);
                        const workingCount = assignmentsOnShift.filter(a => WORKING_HOUR_TYPES.includes(a.type) && a.type !== ASSIGNMENT_TYPES.TRAINING).length;
                        const required = shift.minEmployees || 0;
                        let staffingClass = 'staffing-full';
                        if (workingCount < required) staffingClass = 'staffing-under';
                        if (workingCount > required) staffingClass = 'staffing-over';
                        shiftHtml += `<div class="shift-staffing-cell"><span class="staffing-level ${staffingClass}">${workingCount}/${required}</span></div>`;
                    });
                } else {
                    shiftHtml += `<div class="shift-staffing-cell" style="grid-column:span 7">Filtered View</div>`;
                }

                let hasRows = false;
                currentData.schedules.filter(s => s.shiftId === shift.id && (!s.archived || s.archivedAt > dates[0].toISOString())).sort((a,b)=>(a.order||99)-(b.order||99)).forEach(sched => {
                    if (empFilter) { const hasAss = dates.some(d => currentData.assignments.some(a => a.scheduleId === sched.id && a.date === getLocalDateString(d) && a.employeeId === empFilter)); if (!hasAss) return; }
                    hasRows = true; shiftHtml += `<div class="schedule-name-cell">${sched.name}</div>`; dates.forEach(d => { shiftHtml += renderCell(d, sched, empFilter, typeFilter); });
                });
                
                shiftHtml += `</div></div>`;
                if(hasRows || !empFilter) html += shiftHtml;
            });
            container.innerHTML = html; addDragListeners();
        }

        function getFilteredAssignments(dateStr, shiftId) {
            return currentData.assignments.filter(a => {
                const sched = currentData.schedules.find(s => s.id === a.scheduleId);
                return a.date === dateStr && sched && sched.shiftId === shiftId;
            });
        }

        function renderCell(date, sched, empFilter, typeFilter = 'all') {
            const dateStr = getLocalDateString(date); 
            let cell = `<div class="calendar-cell" onclick="showClickToAssignModal('${sched.id}', '${dateStr}')" data-date="${dateStr}" data-schedule-id="${sched.id}">`;
            const asses = currentData.assignments.filter(a => a.scheduleId === sched.id && a.date === dateStr);
            let displayed = empFilter ? asses.filter(a => a.employeeId === empFilter) : asses;
            if(typeFilter === 'work') displayed = displayed.filter(a => WORKING_HOUR_TYPES.includes(a.type));
            else if(typeFilter === 'timeoff') displayed = displayed.filter(a => TIME_OFF_HOUR_TYPES.includes(a.type));
            const hasLeave = displayed.some(a => TIME_OFF_HOUR_TYPES.includes(a.type)); 
            const hasFillingWork = displayed.some(a => WORKING_HOUR_TYPES.includes(a.type) && a.type !== ASSIGNMENT_TYPES.TRAINING);
            const hasTraining = displayed.some(a => a.type === ASSIGNMENT_TYPES.TRAINING);
            const isWorkDay = (sched.workDays || []).includes(date.getDay());

            // NEW: Check if the schedule belongs to a "Training" shift
            const shift = currentData.shifts.find(s => s.id === sched.shiftId);
            const isTrainingShiftSchedule = shift && shift.name === 'Training';

            displayed.forEach(a => {
                const emp = currentData.employees.find(e => e.id === a.employeeId);
                if(emp) {
                     const color = getAssignmentColor(a.type);
                     const contrast = getContrastColor(color);
                     const noteIcon = a.note ? ' <span style="font-size:10px" title="' + a.note + '">ðŸ“</span>' : '';
                     cell += `<div class="draggable" draggable="true" data-assignment-id="${a.id}" style="border-left-color:${color}" title="${a.type}${a.note ? ': ' + a.note : ''}">${emp.name}${noteIcon} <span class="assignment-tag" style="background-color:${color}; color:${contrast}" title="${a.type}">${a.type.substring(0,3)}</span></div>`;
                }
            });
            
            // Logic for RDO vs Vacant
            if (!empFilter && typeFilter === 'all') {
                 if (!isWorkDay && displayed.length === 0) {
                      cell += `<div class="rdo-slot-indicator">RDO</div>`;
                 } else if (isWorkDay && !hasFillingWork && !isTrainingShiftSchedule) {
                      if (displayed.length === 0) {
                          cell += `<div class="status-badge status-vacant">Vacant</div>`;
                      } else if (hasLeave) {
                          cell += `<div class="vacant-slot-indicator">VACANT (Leave)</div>`;
                      } else if (hasTraining) {
                          cell += `<div class="vacant-slot-indicator">VACANT (Training)</div>`;
                      }
                 }
            }
            
            return cell + `</div>`;
        }

        function displayMonthlyCalendar() {
            const container = document.getElementById('calendarContainer'); const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth(); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); 
            const shiftFilter = document.getElementById('calendarShiftFilter').value;
            const empFilter = document.getElementById('calendarEmployeeFilter').value; const typeFilter = document.getElementById('calendarTypeFilter') ? document.getElementById('calendarTypeFilter').value : 'all';
            let html = `<div class="calendar-grid calendar-month-view">`; ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => html+=`<div class="calendar-header-cell">${d}</div>`); for(let i=0; i<firstDay; i++) html+=`<div class="calendar-cell other-month"></div>`;
            
            const shifts = currentData.shifts.filter(s => !s.archived).sort((a,b) => (a.order||99) - (b.order||99));

            for(let i=1; i<=daysInMonth; i++) {
                const dateStr = getLocalDateString(new Date(year, month, i)); 
                html += `<div class="calendar-cell"><div class="calendar-day-label">${i}</div>`;
                
                if (empFilter) {
                    const assignments = currentData.assignments.filter(a => a.employeeId === empFilter && a.date === dateStr);
                    assignments.forEach(a => {
                        if (typeFilter === 'work' && !WORKING_HOUR_TYPES.includes(a.type)) return;
                        if (typeFilter === 'timeoff' && !TIME_OFF_HOUR_TYPES.includes(a.type)) return;
                        
                        let label = a.type;
                        let color = getAssignmentColor(a.type);
                        if (a.scheduleId) {
                            const sched = currentData.schedules.find(s => s.id === a.scheduleId);
                            if (sched) {
                                const shift = currentData.shifts.find(s => s.id === sched.shiftId);
                                if (shift) { label = shift.name; color = shift.color; }
                            }
                        }
                        if (TIME_OFF_HOUR_TYPES.includes(a.type)) label = a.type;
                        const contrast = getContrastColor(color);
                        html += `<div class="monthly-assignment-pill" style="background:${color}; color:${contrast};" onclick="showClickToAssignModal(null, '${dateStr}')">${label}</div>`;
                    });
                } else {
                    shifts.forEach(shift => {
                        if (shiftFilter && shift.id !== shiftFilter) return;
                        const count = currentData.assignments.filter(a => {
                            if (a.date !== dateStr) return false;
                            const sched = currentData.schedules.find(s => s.id === a.scheduleId);
                            if (!sched || sched.shiftId !== shift.id) return false;
                            if (typeFilter === 'work' && !WORKING_HOUR_TYPES.includes(a.type)) return false;
                            if (typeFilter === 'timeoff' && !TIME_OFF_HOUR_TYPES.includes(a.type)) return false;
                            return true;
                        }).length;

                        if (count > 0) {
                            html += `<div class="monthly-shift-summary" style="border-left-color:${shift.color};" onclick="showMonthlyShiftDetails('${shift.id}', '${dateStr}')">
                                        <span style="font-weight:600; color:#334155;">${shift.name}</span>
                                        <span class="count-badge">${count}</span>
                                     </div>`;
                        }
                    });
                }
                html += `</div>`;
            }
            html += `</div>`; container.innerHTML = html;
        }

        function showMonthlyShiftDetails(shiftId, dateStr) {
            const shift = currentData.shifts.find(s => s.id === shiftId);
            const empFilter = document.getElementById('calendarEmployeeFilter').value;
            const typeFilter = document.getElementById('calendarTypeFilter') ? document.getElementById('calendarTypeFilter').value : 'all';
            const assignments = currentData.assignments.filter(a => {
                if (a.date !== dateStr) return false;
                const sched = currentData.schedules.find(s => s.id === a.scheduleId);
                if (!sched || sched.shiftId !== shiftId) return false;
                if (empFilter && a.employeeId !== empFilter) return false;
                if (typeFilter === 'work' && !WORKING_HOUR_TYPES.includes(a.type)) return false;
                if (typeFilter === 'timeoff' && !TIME_OFF_HOUR_TYPES.includes(a.type)) return false;
                return true;
            });
            
            let html = `<div style="margin-bottom:15px;">
                <button class="btn btn-primary btn-sm" onclick="showAssignModalContent(null, '${dateStr}', '${shiftId}')">+ Add Employee</button>
            </div>`;
            
            if (assignments.length === 0) {
                html += `<p style="color:#64748b;">No employees assigned.</p>`;
            } else {
                html += `<table class="modern-table"><thead><tr><th>Employee</th><th>Schedule</th><th>Type</th><th>Action</th></tr></thead><tbody>`;
                assignments.forEach(a => {
                    const emp = currentData.employees.find(e => e.id === a.employeeId);
                    const sched = currentData.schedules.find(s => s.id === a.scheduleId);
                    html += `<tr>
                        <td>${emp ? emp.name : 'Unknown'}</td>
                        <td>${sched ? sched.name : 'Unknown'}</td>
                        <td>${a.type}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteAssignment('${a.id}')">Remove</button></td>
                    </tr>`;
                });
                html += `</tbody></table>`;
            }
            
            createModal(`${shift.name} - ${formatDate(dateStr)}`, html, '800px');
        }

        function displayDailyCalendar() {
            const container = document.getElementById('calendarContainer'); 
            const dateStr = getLocalDateString(currentCalendarDate);
            const empFilter = document.getElementById('calendarEmployeeFilter').value; 
            const typeFilter = document.getElementById('calendarTypeFilter') ? document.getElementById('calendarTypeFilter').value : 'all'; 
            const shifts = document.getElementById('calendarShiftFilter').value ? currentData.shifts.filter(s => s.id === document.getElementById('calendarShiftFilter').value && !s.archived) : currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99));
            
            let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding-bottom: 20px;">`;
            
            shifts.forEach(shift => {
                const contrast = getContrastColor(shift.color);
                html += `<div class="shift-section" style="margin-bottom:0; height:100%; display:flex; flex-direction:column;">
                            <div class="shift-header-cell" style="background:${shift.color}; color:${contrast}; justify-content:center; border-bottom:1px solid rgba(0,0,0,0.1);">${shift.name}</div>
                            <div style="padding:15px; flex:1; background:#fff;">`;
                
                const schedules = currentData.schedules.filter(s => s.shiftId === shift.id && !s.archived).sort((a,b)=>(a.order||99)-(b.order||99));
                let hasVisibleSchedules = false;

                schedules.forEach(sched => {
                     let show = true; if(empFilter) { if(!currentData.assignments.some(a => a.scheduleId === sched.id && a.date === dateStr && a.employeeId === empFilter)) show = false; }
                     if(show) { 
                        hasVisibleSchedules = true;
                        let assignmentsHtml = '';
                        let asses = currentData.assignments.filter(a => a.scheduleId === sched.id && a.date === dateStr);
                        
                        if (empFilter) asses = asses.filter(a => a.employeeId === empFilter);
                        if (typeFilter === 'work') asses = asses.filter(a => WORKING_HOUR_TYPES.includes(a.type));
                        else if (typeFilter === 'timeoff') asses = asses.filter(a => TIME_OFF_HOUR_TYPES.includes(a.type));

                        if (asses.length > 0) {
                            asses.forEach(a => {
                                const emp = currentData.employees.find(e => e.id === a.employeeId);
                                if (emp) {
                                    const color = getAssignmentColor(a.type);
                                    const contrast = getContrastColor(color);
                                    const noteIcon = a.note ? ' <span style="font-size:10px" title="' + a.note + '">ðŸ“</span>' : '';
                                    
                                    assignmentsHtml += `<div class="daily-assignment-item draggable" draggable="true" data-assignment-id="${a.id}" style="border-left-color:${color}" onclick="showClickToAssignModal('${sched.id}', '${dateStr}')">
                                                            <span class="daily-assignment-name">${emp.name}${noteIcon}</span>
                                                            <span class="assignment-tag" style="background-color:${color}; color:${contrast}" title="${a.type}">${a.type}</span>
                                                        </div>`;
                                }
                            });
                        } else {
                            assignmentsHtml += `<div style="padding: 10px; color: #94a3b8; cursor:pointer; text-align:center; border: 2px dashed #e2e8f0; border-radius:6px; font-size:12px;" onclick="showClickToAssignModal('${sched.id}', '${dateStr}')">Empty Slot</div>`;
                        }
                        
                        html += `<div style="margin-bottom:15px;">
                                    <div style="font-weight:700; color:#475467; margin-bottom:8px; font-size:13px; display:flex; align-items:center; gap:8px;">
                                        <span style="width:8px; height:8px; background:${shift.color}; border-radius:50%; display:inline-block;"></span>
                                        ${sched.name}
                                    </div>
                                    <div class="calendar-cell" data-date="${dateStr}" data-schedule-id="${sched.id}" style="display:flex; flex-direction:column; gap:6px; padding:8px; border-radius:6px; border:1px solid #f1f5f9; min-height:50px;">${assignmentsHtml}</div>
                                 </div>`;
                     }
                });

                if (!hasVisibleSchedules) {
                    html += `<div style="text-align:center; color:#94a3b8; font-style:italic; padding:10px;">No schedules available.</div>`;
                }

                html += `</div></div>`;
            });
            html += `</div>`; 
            container.innerHTML = html; 
            addDragListeners();
        }

        function renderActionsSidebar() {
            const btnContainer = document.getElementById('quickAssignButtonContainer');
            const sidebar = document.getElementById('calendarActionsSidebar'); 
            
            if (calendarViewType === 'monthly') {
                if (btnContainer) btnContainer.style.display = 'none';
                if (sidebar) sidebar.style.display = 'none';
                return;
            } else {
                if (btnContainer) btnContainer.style.display = 'block';
            }

            const emps = currentData.employees.filter(e => !e.archived && !e.isHidden).sort((a,b)=>a.name.localeCompare(b.name)).map(e => `<option value="${e.id}">${e.name}</option>`).join(''); 
            let bubbles = '';
            Object.values(ASSIGNMENT_TYPES).forEach(type => { const color = getAssignmentColor(type); const contrast = getContrastColor(color); bubbles += `<div class="assignment-bubble" draggable="true" data-assignment-type="${type}" style="background:${color}; color:${contrast}" title="${type}">${type}</div>`; });
            
            const chevron = isQuickAssignExpanded ? 'â–¼' : 'â–¶';
            
            if (btnContainer) {
                btnContainer.innerHTML = `<button class="btn btn-primary" style="display:flex; gap:10px; align-items:center;" onclick="toggleQuickAssign()"><span>Quick Assign</span> <span>${chevron}</span></button>`;
            }

            if (isQuickAssignExpanded) {
                sidebar.style.display = 'block';
                sidebar.innerHTML = `<div class="actions-sidebar-section">
                    <div class="form-group"><select id="actions-employee-select" onchange="selectedSidebarEmployeeId = this.value"><option value="">Select Employee</option>${emps}</select></div>
                    <div class="assignment-bubbles-container">${bubbles}</div>
                </div>`;
                if(selectedSidebarEmployeeId) { const sel = document.getElementById('actions-employee-select'); if(sel) sel.value = selectedSidebarEmployeeId; }
                addDragListeners();
            } else {
                sidebar.style.display = 'none';
                sidebar.innerHTML = '';
            }
        }

        function toggleQuickAssign() {
            isQuickAssignExpanded = !isQuickAssignExpanded;
            renderActionsSidebar();
        }

        function addDragListeners() { document.querySelectorAll('.assignment-bubble, .draggable').forEach(el => { el.addEventListener('dragstart', e => { draggedElement = e.target; e.dataTransfer.effectAllowed = el.classList.contains('assignment-bubble') ? 'copy' : 'move'; }); }); document.querySelectorAll('.calendar-cell').forEach(cell => { cell.addEventListener('dragover', e => { e.preventDefault(); cell.classList.add('drag-over'); }); cell.addEventListener('dragleave', () => cell.classList.remove('drag-over')); cell.addEventListener('drop', handleDrop); }); }
        
        function handleDrop(e) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) {
                e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('drag-over');
                return alert("View Only: You do not have permission to edit the schedule.");
            }
            e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('drag-over'); 
            if (!draggedElement) return; 
            
            const date = e.currentTarget.dataset.date; 
            let schedId = e.currentTarget.dataset.scheduleId;
            
            if (!schedId) {
                const schedOpts = currentData.schedules.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                createModal('Select Schedule', `
                    <div class="form-group">
                        <label>Select Schedule for Assignment</label>
                        <select id="dropSchedSelect">${schedOpts}</select>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmDropSched('${date}')">Confirm</button>
                    </div>
                `, '400px');
                return;
            }

            processDrop(date, schedId);
        }

        function confirmDropSched(date) {
            const schedId = document.getElementById('dropSchedSelect').value;
            closeModal();
            if (schedId) processDrop(date, schedId);
        }

        function processDrop(date, schedId) {
            // RDO CHECK: Block drop if it's an RDO (non-work day for this schedule)
            if (schedId) {
                const sched = currentData.schedules.find(s => s.id === schedId);
                // Use getLocalDateFromStr to ensure we check the correct day of week for RDOs
                const dObj = getLocalDateFromStr(date);
                const dayOfWeek = dObj.getDay(); // Use Local Day
                const isWorkDay = sched ? (sched.workDays || []).includes(dayOfWeek) : true;
                
                if (!isWorkDay) {
                    return alert("Action blocked: This slot is an RDO (Regular Day Off). You cannot drag assignments here unless you manually override it by clicking the slot.");
                }
            }

            if(draggedElement.classList.contains('assignment-bubble')) { 
                const type = draggedElement.dataset.assignmentType; 
                const existing = currentData.assignments.find(a => a.scheduleId === schedId && a.date === date && !ADDITIVE_TYPES.includes(a.type)); 
                
                let targetEmpId = selectedSidebarEmployeeId;
                if (existing) {
                    // If existing is NOT a vacancy (i.e. it's a working slot), force target to existing emp (Update/Replace)
                    // If existing IS a vacancy (Leave/Training), prefer Sidebar selection (Fill), fallback to existing (Edit Leave)
                    const isVacancy = TIME_OFF_HOUR_TYPES.includes(existing.type) || existing.type === ASSIGNMENT_TYPES.TRAINING;
                    if (!isVacancy) {
                        targetEmpId = existing.employeeId;
                    } else if (!targetEmpId) {
                        targetEmpId = existing.employeeId;
                    }
                }

                if (!targetEmpId) {
                    return alert('Select an employee from sidebar first.');
                }

                let assignmentType = type;
                if (type === ASSIGNMENT_TYPES.VACATION) {
                    const segId = generateId();
                    currentData.vacationSchedules.push({ id: segId, employeeId: targetEmpId, startDate: date, endDate: date });
                    currentData.vacationAssignments.push({ id: generateId(), segmentId: segId, employeeId: targetEmpId, date: date });
                    logAction('Create Vacation', `Created vacation segment on ${date}`, currentData.employees.find(e=>e.id===targetEmpId));
                    assignmentType = ASSIGNMENT_TYPES.VACATION_SEGMENT;
                }

                applyAssignment(targetEmpId, schedId, date, date, assignmentType); 
            } 
            else if (draggedElement.dataset.assignmentId) { 
                const ass = currentData.assignments.find(a => a.id === draggedElement.dataset.assignmentId); 
                if (ass) { 
                    const targetAss = currentData.assignments.find(a => a.scheduleId === schedId && a.date === date && !ADDITIVE_TYPES.includes(a.type)); 
                    if(targetAss) { 
                        showConfirmationModal('Replace?', `Replace ${getEmployeeName(targetAss.employeeId)}?`, () => {
                            logAction('Replace Assignment', `Replaced ${getEmployeeName(targetAss.employeeId)} with ${getEmployeeName(ass.employeeId)} on ${date}`, currentData.employees.find(e=>e.id===targetAss.employeeId)); 
                            currentData.assignments = currentData.assignments.filter(x => x.id !== targetAss.id); 
                            ass.scheduleId = schedId; 
                            ass.date = date; 
                            updateCalendarView(); 
                        }); 
                    } else { 
                        logAction('Move Assignment', `Moved assignment to ${date}`, currentData.employees.find(e=>e.id===ass.employeeId));
                        ass.scheduleId = schedId; 
                        ass.date = date; 
                        updateCalendarView(); 
                    } 
                } 
            } 
            draggedElement = null; 
        }

        // --- Logic: Assignment Updated with Additive Rules ---
        function applyAssignment(empId, schedId, start, end, type, note = '') {
            // Check for scratches
            if (type === ASSIGNMENT_TYPES.OVERTIME_V && currentData.overtimeScratches.voluntary.includes(empId)) {
                alert(`Action Blocked: ${getEmployeeName(empId)} is currently scratched from the Voluntary Overtime list.`);
                return false;
            }
            if (type === ASSIGNMENT_TYPES.OVERTIME_M && currentData.overtimeScratches.mandatory.includes(empId)) {
                alert(`Action Blocked: ${getEmployeeName(empId)} is currently scratched from the Mandatory Overtime list.`);
                return false;
            }
            
            // Clear refusal if working mandatory overtime
            if (type === ASSIGNMENT_TYPES.OVERTIME_M && currentData.overtimeRefusals && currentData.overtimeRefusals[empId]) {
                currentData.overtimeRefusals[empId].active = false;
            }

            // 1. Clear existing for this emp on this date ONLY if new type is Base
            const isAdditive = ADDITIVE_TYPES.includes(type);
            
            // If adding Base type, clear other Base types for this emp on this day
            if (!isAdditive) {
                // Clear slot if occupied by another base assignment (replacement)
                currentData.assignments = currentData.assignments.filter(a => {
                    if (a.date === start && a.scheduleId === schedId && !ADDITIVE_TYPES.includes(a.type)) return false;
                    if (a.date === start && a.scheduleId === schedId && !ADDITIVE_TYPES.includes(a.type)) {
                        // Allow stacking if existing is Leave or Training (Vacancy) and we are assigning a different person
                        if (a.employeeId !== empId && (TIME_OFF_HOUR_TYPES.includes(a.type) || a.type === ASSIGNMENT_TYPES.TRAINING)) {
                            return true;
                        }
                        return false;
                    }
                    return true;
                });
            }
            
            // 2. Add new
            currentData.assignments.push({ id: generateId(), employeeId: empId, scheduleId: schedId, date: start, type, note });
            
            // Auto-Scratch Logic
            if (currentData.config.autoScratch !== false) {
                if (type === ASSIGNMENT_TYPES.OVERTIME_V) {
                    if(!currentData.overtimeScratches.voluntary.includes(empId)) currentData.overtimeScratches.voluntary.push(empId);
                    if(!currentData.overtimeScratches.mandatory.includes(empId)) currentData.overtimeScratches.mandatory.push(empId);
                } else if (type === ASSIGNMENT_TYPES.OVERTIME_M) {
                    if(!currentData.overtimeScratches.mandatory.includes(empId)) currentData.overtimeScratches.mandatory.push(empId);
                }
            }

            updateCalendarView();
            return true;
        }
        
        function showClickToAssignModal(schedId, date) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) {
                return; // View only, no interaction
            }
            // 1. Get ALL assignments for this slot
            let assignments;
            if (schedId && schedId !== 'null') {
                assignments = currentData.assignments.filter(a => a.scheduleId === schedId && a.date === date);
            } else {
                // Monthly View: Show all assignments for the date
                assignments = currentData.assignments.filter(a => a.date === date);
            }
            
            // 2. Check Work Day status
            const sched = (schedId && schedId !== 'null') ? currentData.schedules.find(s => s.id === schedId) : null;
            // Use local date parsing for RDO check
            const dObj = getLocalDateFromStr(date);
            // If no schedule context (Monthly view), assume it's a work day to allow assignment
            const isWorkDay = sched ? (sched.workDays || []).includes(dObj.getDay()) : true; 
            
            const startDateObj = dObj;
            const defaultEndDate = new Date(startDateObj);
            defaultEndDate.setFullYear(defaultEndDate.getFullYear() + 1);
            const defaultEndStr = getLocalDateString(defaultEndDate);

            if (assignments.length > 0) {
                // MANAGE MODE: List all assignments found in this slot
                let listHtml = `<div style="max-height:400px; overflow-y:auto; margin-bottom:15px;">`;
                
                assignments.forEach(ass => {
                    const empName = getEmployeeName(ass.employeeId);
                    const schedName = ass.scheduleId ? (currentData.schedules.find(s=>s.id===ass.scheduleId)?.name || 'Unknown Sched') : 'No Schedule';
                    const color = getAssignmentColor(ass.type);
                    listHtml += `
                        <div style="background:#f8fafc; border:1px solid #e2e8f0; border-left: 4px solid ${color}; padding:10px; border-radius:4px; margin-bottom:10px;">
                            <div style="font-size:10px; color:#64748b; margin-bottom:2px;">${schedName}</div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <strong>${empName}</strong>
                                <span style="font-size:11px; background:${color}; color:white; padding:2px 6px; border-radius:4px;">${ass.type}</span>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <input type="text" value="${ass.note || ''}" placeholder="Note..." 
                                    onchange="saveAssignmentNote('${ass.id}', this.value)"
                                    style="flex:1; padding:6px; font-size:12px; border:1px solid #cbd5e1; border-radius:4px;">
                                <button class="btn btn-danger btn-sm" onclick="deleteAssignment('${ass.id}')">Delete</button>
                            </div>
                        </div>`;
                });
                listHtml += `</div>`;
                
                // Add "Add Another" button to allow stacking assignments
                listHtml += `
                    <div style="border-top:1px solid #e2e8f0; padding-top:15px; text-align:center;">
                        <button class="btn btn-secondary btn-sm" onclick="showAssignModalContent('${schedId}', '${date}')">+ Add Another Assignment</button>
                    </div>`;

                createModal('Manage Assignments', listHtml + `<div class="action-buttons"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>`, '500px');
                
            } else if (!isWorkDay) {
                // RDO LOCKED MODE
                 createModal('RDO Locked', `
                    <div style="text-align:center; padding:10px;">
                        <div style="font-size:40px; margin-bottom:10px;">ðŸ”’</div>
                        <h3 style="color:#64748b; margin-bottom:10px;">Regular Day Off</h3>
                        <p style="margin-bottom:20px; color:#475467;">This slot is configured as a non-working day.</p>
                        <div class="action-buttons" style="justify-content:center;">
                            <button class="btn btn-danger" onclick="enableRDOOverride('${schedId}', '${date}', '${defaultEndStr}')">Override & Assign</button>
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                        </div>
                    </div>
                `, '400px');
            } else {
                // EMPTY SLOT - ASSIGN MODE
                showAssignModalContent(schedId, date);
            }
        }

        // Helper to render the Assign Form (New Function)
        function showAssignModalContent(schedId, date, preselectedShiftId = null) {
             const emps = currentData.employees.filter(e => !e.archived).map(e => `<option value="${e.id}">${e.name}</option>`).join(''); 
             const types = Object.values(ASSIGNMENT_TYPES).map(t => `<option value="${t}">${t}</option>`).join('');
             
             // If coming from Monthly view (schedId is null), allow selecting a schedule
             let schedSelector = '';
             if (!schedId || schedId === 'null') {
                 let scheds = currentData.schedules.filter(s => !s.archived);
                 if (preselectedShiftId) {
                     scheds = scheds.filter(s => s.shiftId === preselectedShiftId);
                 }
                 const schedOpts = scheds.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                 schedSelector = `<div><label>Schedule</label><select id="assignSched">${schedOpts}</select></div>`;
             }

             const dObj = getLocalDateFromStr(date);
             const defaultEndDate = new Date(dObj);
             defaultEndDate.setFullYear(defaultEndDate.getFullYear() + 1);
             const defaultEndStr = getLocalDateString(defaultEndDate);

             createModal('Assign', `
                    <div class="form-row"><div><label>Employee</label><select id="assignEmp">${emps}</select></div>${schedSelector}<div><label>Type</label><select id="assignType">${types}</select></div></div>
                    
                    <div class="form-group">
                        <label>Note</label>
                        <input type="text" id="assignNote" placeholder="Optional note">
                    </div>

                    <div class="form-group">
                        <label>Assignment Range</label>
                        <div class="radio-group" style="margin-bottom:10px;">
                            <label><input type="radio" name="dur" value="day" checked onclick="toggleAssignDateInputs()"> Single Day</label>
                            <label><input type="radio" name="dur" value="custom" onclick="toggleAssignDateInputs()"> Multi-Day</label>
                        </div>
                        <div id="assignDateRange" class="form-row hidden">
                            <div><label>Start</label><input type="date" id="assignStart" value="${date}"></div>
                            <div><label>End</label><input type="date" id="assignEnd" value="${defaultEndStr}"></div>
                        </div>
                    </div>
                    
                    <div class="action-buttons"><button class="btn btn-primary" onclick="processAssign('${schedId}', '${date}')">Assign</button></div>
                `, '800px'); 
        }
        
        function enableRDOOverride(schedId, date, defaultEndStr) {
            // Re-use the standard assign modal
            showAssignModalContent(schedId, date);
        }

        function saveAssignmentNote(id, val) {
            // Updated to accept value directly
            const ass = currentData.assignments.find(a => a.id === id);
            if (ass) {
                ass.note = val;
                updateCalendarView();
            }
        }

        function toggleAssignDateInputs() {
            const isCustom = document.querySelector('input[name="dur"][value="custom"]').checked;
            document.getElementById('assignDateRange').classList.toggle('hidden', !isCustom);
        }
        
        function processAssign(schedId, date) { 
            const empId = document.getElementById('assignEmp').value; 
            
            // Handle missing schedId (Monthly View)
            if (!schedId || schedId === 'null') {
                const el = document.getElementById('assignSched');
                if (el) schedId = el.value;
            }

            const type = document.getElementById('assignType').value; 
            const note = document.getElementById('assignNote').value;
            const dur = document.querySelector('input[name="dur"]:checked').value; 
            
            const sched = currentData.schedules.find(s => s.id === schedId);
            const workDays = sched ? (sched.workDays || [0,1,2,3,4,5,6]) : [0,1,2,3,4,5,6];

            // Handle Vacation Segment Creation
            const isVacation = (type === ASSIGNMENT_TYPES.VACATION);
            const assignmentType = isVacation ? ASSIGNMENT_TYPES.VACATION_SEGMENT : type;
            let segId = null;

            if (isVacation) {
                let s = (dur === 'day') ? date : document.getElementById('assignStart').value;
                let e = (dur === 'day') ? date : document.getElementById('assignEnd').value;
                
                if (dur !== 'day') {
                    if (!s || !e) return alert("Start and End dates are required.");
                    if (e < s) return alert("End date cannot be before start date.");
                }

                segId = generateId();
                currentData.vacationSchedules.push({ id: segId, employeeId: empId, startDate: s, endDate: e });
            }

            if(dur === 'day') { 
                logAction('Assign Single', `Assigned to ${assignmentType} on ${date}`, currentData.employees.find(e=>e.id===empId));
                applyAssignment(empId, schedId, date, date, assignmentType, note); 
                if (isVacation && segId) {
                    currentData.vacationAssignments.push({ id: generateId(), segmentId: segId, employeeId: empId, date: date });
                }
            } else {
                // Multi-day / Build Schedule
                const startVal = document.getElementById('assignStart').value;
                const endVal = document.getElementById('assignEnd').value;
                
                if (!startVal || !endVal) return alert("Start and End dates are required.");
                if (endVal < startVal) return alert("End date cannot be before start date.");

                // FIXED: Use getLocalDateFromStr for iteration to avoid timezone shifts
                const current = getLocalDateFromStr(startVal);
                const end = getLocalDateFromStr(endVal);
                
                logAction('Assign Multi-Day', `Assigned to ${assignmentType} from ${startVal} to ${endVal}`, currentData.employees.find(e=>e.id===empId));
                // Loop through dates
                while (current <= end) {
                    const isoDate = getLocalDateString(current);
                    const dayOfWeek = current.getDay(); // Use Local Day 
                    
                    if (isVacation && segId) {
                        currentData.vacationAssignments.push({ id: generateId(), segmentId: segId, employeeId: empId, date: isoDate });
                    }

                    if (workDays.includes(dayOfWeek)) { 
                        applyAssignment(empId, schedId, isoDate, null, assignmentType, note); 
                    }
                    current.setDate(current.getDate() + 1);
                }
            } 
            closeModal(); 
        }
        
        // MODIFIED: Delete Assignment with Options
        function deleteAssignment(id) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const ass = currentData.assignments.find(a => a.id === id);
            if (!ass) return;
            
            createModal('Delete Assignment', `
                <div style="padding:15px;">
                    <p style="margin-bottom:20px; font-size:14px; color:#475467;">
                        You are deleting an assignment for <strong>${getEmployeeName(ass.employeeId)}</strong> on <strong>${formatDate(ass.date)}</strong>.
                    </p>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <button class="btn btn-secondary" style="justify-content:flex-start; text-align:left; padding:12px;" onclick="performDelete('${id}', 'single')">
                            <span style="display:block; font-weight:700; margin-bottom:2px;">Delete Only This Instance</span>
                            <span style="display:block; font-size:11px; font-weight:normal; color:#64748b;">Remove assignment for this date only.</span>
                        </button>
                        <button class="btn btn-danger ${role === ROLES.ADMIN ? 'btn-locked' : ''}" style="justify-content:flex-start; text-align:left; padding:12px;" onclick="performDelete('${id}', 'future')">
                            <span style="display:block; font-weight:700; margin-bottom:2px;">Delete This & All Future</span>
                            <span style="display:block; font-size:11px; font-weight:normal; color:#fee2e2;">Remove this and all future assignments for this employee on this schedule.</span>
                        </button>
                        <button class="btn btn-warning ${role === ROLES.ADMIN ? 'btn-locked' : ''}" style="justify-content:flex-start; text-align:left; padding:12px;" onclick="performDelete('${id}', 'past')">
                            <span style="display:block; font-weight:700; margin-bottom:2px;">Delete Past Range</span>
                            <span style="display:block; font-size:11px; font-weight:normal; color:white;">Remove assignments from a specific past date up to this date.</span>
                        </button>
                    </div>
                    <div style="margin-top:20px; text-align:right; border-top:1px solid #e2e8f0; padding-top:10px;">
                        <button class="btn btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </div>
            `, '450px');
        }

        function syncVacationDelete(assignment) {
            if (assignment.type !== ASSIGNMENT_TYPES.VACATION && assignment.type !== ASSIGNMENT_TYPES.VACATION_SEGMENT) return;
            const vacIndex = currentData.vacationAssignments.findIndex(v => v.employeeId === assignment.employeeId && v.date === assignment.date);
            if (vacIndex === -1) return;
            const vacAss = currentData.vacationAssignments[vacIndex];
            const segId = vacAss.segmentId;
            currentData.vacationAssignments.splice(vacIndex, 1);
            const remaining = currentData.vacationAssignments.filter(v => v.segmentId === segId);
            if (remaining.length === 0) {
                currentData.vacationSchedules = currentData.vacationSchedules.filter(s => s.id !== segId);
            } else {
                const dates = remaining.map(r => r.date).sort();
                const seg = currentData.vacationSchedules.find(s => s.id === segId);
                if (seg) { seg.startDate = dates[0]; seg.endDate = dates[dates.length - 1]; }
            }
        }

        // NEW FUNCTION: Handle the deletion logic
        function performDelete(id, mode) {
            const ass = currentData.assignments.find(a => a.id === id);
            if (!ass) { closeModal(); return; }

            if (mode === 'single') {
                syncVacationDelete(ass);
                logAction('Delete Assignment', `Deleted single assignment on ${ass.date}`, currentData.employees.find(e=>e.id===ass.employeeId));
                currentData.assignments = currentData.assignments.filter(a => a.id !== id);
                closeModal();
                updateCalendarView();
            } else if (mode === 'future') {
                showConfirmationModal('Confirm Bulk Delete', 
                    `Are you sure you want to delete this assignment and ALL future assignments for <strong>${getEmployeeName(ass.employeeId)}</strong> on this schedule?<br><br>This action cannot be undone.`, 
                    () => {
                        currentData.assignments = currentData.assignments.filter(a => {
                            if (a.employeeId === ass.employeeId && a.scheduleId === ass.scheduleId && a.date >= ass.date) {
                                syncVacationDelete(a);
                                return false; // Remove
                            }
                            return true; // Keep
                        });
                        logAction('Delete Future', `Deleted future assignments from ${ass.date}`, currentData.employees.find(e=>e.id===ass.employeeId));
                        updateCalendarView();
                    }
                );
            } else if (mode === 'past') {
                createModal('Delete Past Range', `
                    <div style="padding:15px;">
                        <p style="margin-bottom:15px;">Select the start date for deletion. This will delete all assignments for <strong>${getEmployeeName(ass.employeeId)}</strong> on this schedule from the selected date up to <strong>${formatDate(ass.date)}</strong>.</p>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="deleteStartDate">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="deleteAssignment('${id}')">Back</button>
                            <button class="btn btn-danger" onclick="confirmDeletePast('${id}')">Delete Range</button>
                        </div>
                    </div>
                `, '400px');
            }
        }

        function confirmDeletePast(id) {
            const startDate = document.getElementById('deleteStartDate').value;
            if (!startDate) return alert("Please select a start date.");
            
            const ass = currentData.assignments.find(a => a.id === id);
            if (!ass) { closeModal(); return; }
            
            if (startDate > ass.date) return alert("Start date cannot be after the selected assignment date.");

            showConfirmationModal('Confirm Past Delete', 
                `Are you sure you want to delete assignments from <strong>${formatDate(startDate)}</strong> to <strong>${formatDate(ass.date)}</strong>?`,
                () => {
                    currentData.assignments = currentData.assignments.filter(a => {
                        if (a.employeeId === ass.employeeId && a.scheduleId === ass.scheduleId && a.date >= startDate && a.date <= ass.date) {
                            syncVacationDelete(a);
                            return false; // Remove
                        }
                        return true; // Keep
                    });
                    logAction('Delete Past', `Deleted past assignments from ${startDate} to ${ass.date}`, currentData.employees.find(e=>e.id===ass.employeeId));
                    updateCalendarView();
                }
            );
        }

        function loadRoster() {
            const container = document.getElementById('roster'); const shiftOptions = `<option value="">All Shifts</option>` + currentData.shifts.filter(s=>!s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); const typeOptions = `<option value="">All Types</option>` + currentData.employeeTypes.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const showHiddenOption = (role === ROLES.OWNER) ? `<div class="filter-group" style="margin-left:10px;"><label style="cursor:pointer; display:flex; align-items:center; gap:5px; text-transform:none; font-size:13px;"><input type="checkbox" id="rosterShowHidden" onchange="renderRosterTables()" style="width:auto;"> Show Hidden</label></div>` : '';
            container.innerHTML = `<div style="margin-bottom: 10px;"><button class="btn btn-secondary" onclick="goHome()">â† Back to Home</button></div><div class="filter-section" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><div style="display:flex; gap:15px;"><div class="filter-group"><label>Sort:</label><select id="rosterSort" onchange="renderRosterTables()"><option value="alpha">Alphabetical (A-Z)</option><option value="seniority">Seniority (Oldest First)</option><option value="inverse">Inverse Seniority (Newest First)</option></select></div><div class="filter-group"><label>Shift:</label><select id="rosterShiftFilter" onchange="renderRosterTables()">${shiftOptions}</select></div><div class="filter-group"><label>Type:</label><select id="rosterTypeFilter" onchange="renderRosterTables()">${typeOptions}</select></div>${showHiddenOption}</div><div class="tabs" style="margin:0; box-shadow:none"><button class="tab active" onclick="toggleRosterView('active')">Active</button><button class="tab" onclick="toggleRosterView('archived')">Archived</button></div></div><div id="rosterActiveView" class="roster-view"><div id="rosterActive" class="table-container bubble-container"></div></div><div id="rosterArchivedView" class="roster-view hidden"><div id="rosterArchived" class="table-container bubble-container"></div></div>`;
            renderRosterTables();
        }
        function toggleRosterView(view) { document.getElementById('rosterActiveView').classList.toggle('hidden', view !== 'active'); document.getElementById('rosterArchivedView').classList.toggle('hidden', view !== 'archived'); const tabs = document.querySelectorAll('#roster .tab'); tabs.forEach(t => t.classList.remove('active')); if (view === 'active') tabs[0].classList.add('active'); if (view === 'archived') tabs[1].classList.add('active'); }
        function renderRosterTables() {
            const sort = document.getElementById('rosterSort')?.value || 'alpha'; const shiftFilter = document.getElementById('rosterShiftFilter')?.value; const typeFilter = document.getElementById('rosterTypeFilter')?.value;
            const showHidden = document.getElementById('rosterShowHidden')?.checked || false;
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const canEdit = (role === ROLES.OWNER || role === ROLES.ADMIN);
            const canManageAccounts = (role === ROLES.OWNER || role === ROLES.ADMIN);
            let active = currentData.employees.filter(e => !e.archived);
            if (!showHidden) active = active.filter(e => !e.isHidden);
            if (shiftFilter) active = active.filter(e => e.defaultShift === shiftFilter);
            if (typeFilter) active = active.filter(e => e.type === typeFilter);
            active.sort((a, b) => { if (sort === 'alpha') return a.name.localeCompare(b.name); if (sort === 'seniority') { const dA = new Date(a.seniorityDate); const dB = new Date(b.seniorityDate); if (dA < dB) return -1; if (dA > dB) return 1; return a.name.localeCompare(b.name); } if (sort === 'inverse') { const dA = new Date(a.seniorityDate); const dB = new Date(b.seniorityDate); if (dA > dB) return -1; if (dA < dB) return 1; return b.name.localeCompare(a.name); } return 0; });
            const archived = currentData.employees.filter(e => e.archived);
            let html = `<table class="employee-bubble-table"><thead><tr><th>Name</th><th>Seniority</th><th>Default Shift</th><th>Type</th><th>Notes</th><th>Actions</th></tr></thead><tbody>`;
            active.forEach(e => { 
                const shiftName = currentData.shifts.find(s=>s.id===e.defaultShift)?.name || 'N/A'; 
                const typeName = currentData.employeeTypes.find(t=>t.id===e.type)?.name || '-'; 
                const isTargetOwner = e.systemRole === ROLES.OWNER;
                const canViewThisAccount = (role === ROLES.OWNER) || (role === ROLES.ADMIN && !isTargetOwner);
                const hiddenBadge = e.isHidden ? '<span style="font-size:10px; background:#e2e8f0; color:#64748b; padding:2px 5px; border-radius:4px; margin-left:5px;">Hidden</span>' : '';
                const canViewSchedule = canEdit || (role === ROLES.EMPLOYEE && currentUser.id === e.id);
                html += `<tr>
                    <td>${e.name}${hiddenBadge}</td>
                    <td>${formatDate(e.seniorityDate)}</td>
                    <td>${shiftName}</td>
                    <td>${typeName}</td>
                    <td><input type="text" value="${e.rosterNote||''}" onchange="saveRosterNote('${e.id}', this.value)" placeholder="Add note..." ${!canEdit ? 'disabled' : ''}></td>
                    <td>
                        ${canViewSchedule ? `<button class="action-bubble view" onclick="viewEmployeeSchedule('${e.id}')">View Schedule</button>` : ''}
                        ${canManageAccounts && canViewThisAccount ? `<button class="action-bubble view" style="background:#f3e8ff; color:#6b21a8; border-color:#d8b4fe;" onclick="showEmployeeAccountModal('${e.id}')">Account</button>` : ''}
                        ${canEdit ? `<button class="action-bubble edit" onclick="editEmployee('${e.id}')">Edit</button>` : ''}
                        ${canEdit ? `<button class="action-bubble archive" onclick="archiveEmployee('${e.id}')">Archive</button>` : ''}
                        ${canViewThisAccount ? `<button class="action-bubble edit" onclick="editEmployee('${e.id}')">Edit</button>` : ''}
                        ${canViewThisAccount ? `<button class="action-bubble archive" onclick="archiveEmployee('${e.id}')">Archive</button>` : ''}
                    </td>
                </tr>`; 
            }); 
            html += `</tbody></table>`; document.getElementById('rosterActive').innerHTML = html;
            
            let html2 = `<table class="employee-bubble-table"><thead><tr><th>Name</th><th>Archived Date</th><th>Actions</th></tr></thead><tbody>`; 
            archived.forEach(e => { 
                html2 += `<tr>
                    <td>${e.name}</td>
                    <td>${formatDate(e.archivedAt)}</td>
                    <td>
                        <button class="action-bubble view" onclick="viewEmployeeSchedule('${e.id}')">History</button>
                        <button class="action-bubble restore" onclick="restoreEmployee('${e.id}')">Restore</button>
                        <button class="action-bubble delete" onclick="deleteEmployeePermanently('${e.id}', false)">Delete Permanently</button>
                    </td>
                </tr>`; 
            }); 
            html2 += `</tbody></table>`; 
            document.getElementById('rosterArchived').innerHTML = html2;
        }
        function saveRosterNote(id, val) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) return;
            const e = currentData.employees.find(x => x.id === id); if(e) e.rosterNote = val; 
        }
        
        let currentEmpViewId = null; let currentEmpViewMode = 'weekly'; let currentEmpViewDate = new Date();
        function viewEmployeeSchedule(id) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE && currentUser.id !== id) return alert("Access Denied: You can only view your own schedule.");
            if (role === ROLES.GUEST) return alert("Access Denied.");
            currentEmpViewId = id; currentEmpViewDate = new Date(currentCalendarDate); const emp = currentData.employees.find(x => x.id === id); createModal(`Schedule: ${emp.name}`, `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><div class="tabs" style="box-shadow:none; margin:0"><button class="tab active" id="tabEmpWeekly" onclick="switchEmpViewMode('weekly')">Weekly</button><button class="tab" id="tabEmpMonthly" onclick="switchEmpViewMode('monthly')">Monthly</button></div><div style="display:flex; gap:10px; align-items:center;"><button class="btn btn-sm btn-secondary" onclick="printContent('empScheduleContainer', 'Schedule: ${emp.name}')">Print</button><div><button class="btn btn-sm btn-secondary" onclick="navEmpView(-1)">â†</button> <span id="empViewLabel" style="font-weight:600; font-size:13px;"></span> <button class="btn btn-sm btn-secondary" onclick="navEmpView(1)">â†’</button></div></div></div><div id="empScheduleContainer" class="table-container" style="max-height:500px; overflow-y:auto;"></div>`, '900px'); renderEmpSchedule(); 
        }
        function switchEmpViewMode(mode) { currentEmpViewMode = mode; document.getElementById('tabEmpWeekly').classList.toggle('active', mode === 'weekly'); document.getElementById('tabEmpMonthly').classList.toggle('active', mode === 'monthly'); renderEmpSchedule(); }
        function navEmpView(dir) { if(currentEmpViewMode==='weekly') currentEmpViewDate.setDate(currentEmpViewDate.getDate() + (dir*7)); else currentEmpViewDate.setMonth(currentEmpViewDate.getMonth() + dir); renderEmpSchedule(); }
        
        function renderEmpSchedule() { 
            const container = document.getElementById('empScheduleContainer'); 
            const empId = currentEmpViewId; 
            document.getElementById('empViewLabel').textContent = currentEmpViewMode==='weekly' ? 'Week of ' + currentEmpViewDate.toLocaleDateString() : currentEmpViewDate.toLocaleDateString('en-US', {month:'long', year:'numeric'}); 
            
            if (currentEmpViewMode === 'weekly') { 
                const dates = getWeekDates(currentEmpViewDate); 
                let html = `<table class="modern-table"><thead><tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Shift</th>
                    <th>Time</th>
                    <th>Hours</th>
                    <th>Status</th>
                    <th>Notes</th>
                </tr></thead><tbody>`; 
                
                let totalHours = 0;

                dates.forEach(d => { 
                    const dStr = getLocalDateString(d); 
                    const asses = currentData.assignments.filter(a => a.employeeId === empId && a.date === dStr); 
                    
                    let dayHtml = `<tr><td>${d.toLocaleDateString()}</td><td>${d.toLocaleDateString('en-US', {weekday:'long'})}</td>`;
                    
                    if (asses.length === 0) {
                        dayHtml += `<td colspan="5" style="color:#94a3b8; font-style:italic;">Off / No Assignment</td></tr>`;
                    } else {
                        // There might be multiple assignments (e.g. half days), but usually one major one
                        // We will list them vertically in the cell if needed, or just take the first for simplicity in columns
                        // For detailed columns, we'll iterate
                        
                        asses.forEach((a, idx) => {
                            if (idx > 0) dayHtml += `<tr><td></td><td></td>`; // Empty cells for date/day on multi-row

                            // Get Shift Details
                            let shiftName = '-';
                            let timeRange = '-';
                            let hours = 0;
                            let status = a.type;
                            
                            // Calculate logic
                            if (a.scheduleId) {
                                const sched = currentData.schedules.find(s => s.id === a.scheduleId);
                                if (sched) {
                                    const shift = currentData.shifts.find(s => s.id === sched.shiftId);
                                    if (shift) {
                                        shiftName = shift.name;
                                        timeRange = `${shift.startTime} - ${shift.endTime}`;
                                        hours = calculateHours(a); // Uses helper from before
                                    }
                                }
                            }
                            
                            if (TIME_OFF_HOUR_TYPES.includes(a.type)) {
                                hours = 8; // Default for leave?
                                timeRange = 'All Day';
                            }
                            
                            if (WORKING_HOUR_TYPES.includes(a.type)) {
                                totalHours += hours;
                            } else {
                                // Maybe add leave hours separate? For now just summing work hours for bottom total
                            }

                            dayHtml += `<td>${shiftName}</td>
                                        <td>${timeRange}</td>
                                        <td>${hours > 0 ? hours : '-'}</td>
                                        <td><span class="assignment-tag" style="background:${getAssignmentColor(a.type)}; color:white;">${status}</span></td>
                                        <td>${a.note || ''}</td></tr>`;
                        });
                    }
                    html += dayHtml;
                }); 
                
                html += `<tr style="background:#f8fafc; font-weight:bold; border-top:2px solid #e2e8f0;">
                            <td colspan="4" style="text-align:right;">Total Work Hours:</td>
                            <td style="color:var(--primary-light); font-size:1.1em;">${totalHours}</td>
                            <td colspan="2"></td>
                         </tr>`;
                
                html += `</tbody></table>`; 
                container.innerHTML = html; 
            } else { 
                // MONTHLY GRID VIEW
                const year = currentEmpViewDate.getFullYear();
                const month = currentEmpViewDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayIndex = new Date(year, month, 1).getDay();

                let html = `<div class="calendar-grid calendar-month-view">`;
                
                // Headers
                ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => html+=`<div class="calendar-header-cell">${d}</div>`);
                
                // Padding
                for(let i=0; i<firstDayIndex; i++) html+=`<div class="calendar-cell other-month"></div>`;
                
                // Days
                for(let i=1; i<=daysInMonth; i++) {
                    const d = new Date(year, month, i);
                    const dStr = getLocalDateString(d); 
                    const asses = currentData.assignments.filter(a => a.employeeId === empId && a.date === dStr);
                    
                    html += `<div class="calendar-cell" style="min-height:80px;">
                                <div class="calendar-day-label">${i}</div>`;
                    
                    asses.forEach(a => {
                        const color = getAssignmentColor(a.type);
                        const contrast = getContrastColor(color);
                        html += `<div style="font-size:10px; margin-bottom:2px; padding:2px 4px; border-radius:3px; background:${color}; color:${contrast};" title="${a.type}">
                                    ${a.type}
                                 </div>`;
                    });
                    
                    html += `</div>`;
                }
                html += `</div>`;
                container.innerHTML = html; 
            } 
        }

        function archiveEmployee(id) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) return alert("Access Denied.");
            
            const targetEmp = currentData.employees.find(x => x.id === id);
            if (targetEmp && targetEmp.systemRole === ROLES.OWNER && role !== ROLES.OWNER) {
                return alert("Access Denied: Only Owners can archive Owner accounts.");
            }

            showArchiveModal('Archive Employee', '<strong>Warning:</strong> Archiving this employee will remove all their schedule assignments ON and AFTER the selected date.', (date) => { 
                const e = currentData.employees.find(x => x.id === id); 
                e.archived = true; 
                e.archivedAt = date; 
                // Remove future assignments
                logAction('Archive Employee', `Archived effective ${date}`, e);
                currentData.assignments = currentData.assignments.filter(a => {
                    // Keep if not this employee OR if date is strictly before archive date
                    return a.employeeId !== id || a.date < date;
                });
                renderRosterTables(); 
            }); 
        }
        function restoreEmployee(id) { const e = currentData.employees.find(x => x.id === id); e.archived = false; e.archivedAt = null; logAction('Restore Employee', `Restored employee`, e); renderRosterTables(); }
        
        function deleteEmployeePermanently(id, fromAdmin = false) {
            if (currentUser && currentUser.role === ROLES.ADMIN) return alert("Admin Restricted: Cannot permanently delete items.");
            showConfirmationModal('Delete Permanently?', 'This will permanently delete the employee record and ALL historical assignments. This cannot be undone.', () => {
                // Remove from employees array
                currentData.employees = currentData.employees.filter(e => e.id !== id);
                // Remove all assignments for this employee
                currentData.assignments = currentData.assignments.filter(a => a.employeeId !== id);
                // Remove from OT lists
                currentData.overtimeSignups = currentData.overtimeSignups.filter(s => s.employeeId !== id);
                currentData.vacationSchedules = currentData.vacationSchedules.filter(v => v.employeeId !== id);
                
                // Refresh admin views
                logAction('Delete Employee', `Permanently deleted employee ID ${id}`); // Log to system as item is gone
                if (fromAdmin) {
                    loadAdminSection('employee', 'archivedEmployees');
                } else {
                    renderRosterTables();
                }
            });
        }

        function editEmployee(id, fromAdmin = false) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) return alert("Access Denied.");
            const e = currentData.employees.find(x => x.id === id); if (!e) return;
            
            if (e.systemRole === ROLES.OWNER && role !== ROLES.OWNER) {
                return alert("Access Denied: Only Owners can edit Owner accounts.");
            }
            
            const shiftOptions = `<option value="">N/A</option>` + currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s => `<option value="${s.id}" ${s.id === e.defaultShift ? 'selected' : ''}>${s.name}</option>`).join(''); const typeOptions = currentData.employeeTypes.map(t => `<option value="${t.id}" ${t.id === e.type ? 'selected' : ''}>${t.name}</option>`).join(''); 
            const roleOptions = Object.values(ROLES).map(r => `<option value="${r}" ${e.systemRole === r ? 'selected' : ''}>${r}</option>`).join('');
            const roleSelect = fromAdmin ? `<div><label>System Role</label><select id="editEmpRole">${roleOptions}</select></div>` : '';
            const locOptions = globalData.locations.filter(l => !l.archived).map(l => `<option value="${l.id}" ${l.id === e.defaultLocation ? 'selected' : ''}>${l.name}</option>`).join('');
            const cancelAction = fromAdmin ? "loadAdminSection('employee', 'activeEmployees')" : "closeModal()";
            createModal('Edit Employee', `<div class="form-row"><div><label>Name</label><input type="text" id="editEmpName" value="${e.name}"></div><div><label>Seniority</label><input type="date" id="editEmpSeniority" value="${e.seniorityDate}"></div></div><div class="form-row"><div><label>Type</label><select id="editEmpType">${typeOptions}</select></div><div><label>Default Shift</label><select id="editEmpShift">${shiftOptions}</select></div></div><div class="form-row"><div><label>Default Location</label><select id="editEmpLocation">${locOptions}</select></div>${fromAdmin ? roleSelect : ''}</div><div class="form-group"><label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="editEmpHidden" ${e.isHidden ? 'checked' : ''} style="width:auto;"> Hide from Roster (User can still login)</label></div><div class="action-buttons"><button class="btn btn-primary" onclick="saveEmployeeChanges('${id}', ${fromAdmin})">Save Changes</button><button class="btn btn-secondary" onclick="${cancelAction}">Cancel</button></div>`); }
        function saveEmployeeChanges(id, fromAdmin) { const e = currentData.employees.find(x => x.id === id); if (e) { e.name = document.getElementById('editEmpName').value; e.seniorityDate = document.getElementById('editEmpSeniority').value; e.type = document.getElementById('editEmpType').value; e.defaultShift = document.getElementById('editEmpShift').value; e.defaultLocation = document.getElementById('editEmpLocation').value; e.isHidden = document.getElementById('editEmpHidden').checked; if(fromAdmin) e.systemRole = document.getElementById('editEmpRole').value; logAction('Edit Employee', `Updated details`, e); renderRosterTables(); if(fromAdmin) loadAdminSection('employee', 'activeEmployees'); else closeModal(); alert('Changes saved.'); } }

        function showEmployeeAccountModal(empId) {
            const emp = currentData.employees.find(e => e.id === empId);
            if (!emp) return;
            
            // Security Check: Admins cannot view Owner accounts
            if (emp.systemRole === ROLES.OWNER) {
                if (!currentUser || currentUser.role !== ROLES.OWNER) {
                    return alert("Security Alert: Only Owners can manage Owner accounts.");
                }
            }
            
            createModal(`Account: ${emp.name}`, `
                <div class="form-group"><label>Username</label><input type="text" id="adminEmpUser" value="${emp.username || ''}"></div>
                <div class="form-group"><label>Password</label><input type="text" id="adminEmpPass" value="${emp.password || ''}"></div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveEmployeeAccount('${empId}')">Save Credentials</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `, '400px');
        }

        function saveEmployeeAccount(empId) {
            const u = document.getElementById('adminEmpUser').value;
            const p = document.getElementById('adminEmpPass').value;
            const emp = currentData.employees.find(e => e.id === empId);
            if (emp) {
                emp.username = u;
                emp.password = p;
                logAction('Admin Password Change', `Changed credentials`, emp);
                alert("Credentials updated.");
                saveToFirebase();
                closeModal();
            }
        }

        // --- Overtime Shift Tabs ---
        function loadOvertime() { 
            document.getElementById('currentTabTitle').textContent = 'Overtime';
            const container = document.getElementById('overtime'); 
            const isAutoScratchOn = currentData.config.autoScratch !== false; // Default to true
            container.innerHTML = `
                <div style="margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center;">
                    <button class="btn btn-secondary" onclick="goHome()">â† Back to Home</button>
                    <button class="btn ${isAutoScratchOn ? 'btn-success' : 'btn-secondary'}" onclick="toggleAutoScratch()">Auto-Scratch: ${isAutoScratchOn ? 'ON' : 'OFF'}</button>
                </div>
                <div class="home-tiles-grid" style="margin-top: 20px; max-width: 1000px; margin-left: auto; margin-right: auto; grid-template-columns: repeat(3, 1fr);">
                    <div class="home-tile" onclick="showVoluntaryOTListModal()">
                        <div class="home-tile-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">ðŸ“‹</div>
                        <h3 class="home-tile-title">Voluntary List</h3>
                    </div>
                    <div class="home-tile" onclick="showMandatoryOTListModal()">
                        <div class="home-tile-icon" style="background: linear-gradient(135deg, #581c87 0%, #3b0764 100%); color: white;">ðŸ“‹</div>
                        <h3 class="home-tile-title">Mandatory Lists</h3>
                    </div>
                    <div class="home-tile" onclick="loadOvertimeCalendar()">
                        <div class="home-tile-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">ðŸ“…</div>
                        <h3 class="home-tile-title">Signup Calendar</h3>
                    </div>
                </div>
            `; 
        }

        function toggleAutoScratch() {
            if (currentData.config.autoScratch === undefined) currentData.config.autoScratch = true;
            currentData.config.autoScratch = !currentData.config.autoScratch;
            loadOvertime();
        }

        function loadOvertimeCalendar() {
            document.getElementById('currentTabTitle').textContent = 'Overtime Signup';
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const lockClear = (role === ROLES.ADMIN || role === ROLES.EMPLOYEE || role === ROLES.GUEST) ? 'btn-locked' : '';
            const container = document.getElementById('overtime'); 
            initializeOTCalendarShifts();
            container.innerHTML = `
                <div style="display:flex; justify-content:flex-end; align-items:center; margin-bottom: 10px; gap: 10px;">
                    <button class="btn btn-secondary" onclick="showManageOvertimeCalendarShiftsModal()">Manage Shifts</button>
                    <button class="btn btn-danger ${lockClear}" onclick="clearOvertimeForMonth()">Clear Month Log</button>
                </div>
                <div id="otCalendarHeader" class="calendar-header" style="margin-bottom: 20px; display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap: 20px;">
                    <div>
                        <button class="btn btn-secondary" onclick="loadOvertime()">â† Back to Menu</button>
                    </div>
                    <div class="filter-group" style="display:flex; align-items:center; justify-content:center;">
                        <select id="otShiftFilter" onchange="updateOTView()" style="padding: 8px 16px; border: 2px solid var(--primary-light); border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                            <option value="">All Shifts</option>${currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:flex-end; gap: 20px;">
                        <div class="calendar-nav" style="display:flex; align-items:center; gap:10px;">
                            <button class="btn btn-secondary" onclick="prevCalOT()">â†</button>
                            <button class="btn btn-secondary" onclick="todayCalOT()">Today</button>
                            <button class="btn btn-secondary" onclick="nextCalOT()">â†’</button>
                        </div>
                        <span id="otCalendarPeriodLabel" style="font-size: 20px; font-weight: 700; color: #2c3e50; min-width: 150px; text-align: right;"></span>
                    </div>
                </div>
                <div id="otCalendarContainer"></div>
                <div id="otFloatingBar" class="floating-action-bar">
                    <span id="otSelectedCount" style="font-weight:bold; margin-right:15px"></span>
                    <button class="btn btn-success" onclick="showOTSignupModalBatch()">Sign Up Selected</button>
                    <button class="btn btn-secondary" onclick="clearOTSelection()">Clear</button>
                </div>`; 
            populateOTShiftFilter();
            updateOTView(); 
        }

        function initializeOTCalendarShifts() {
            if (currentData && (!currentData.overtimeCalendarVisibleShifts || currentData.overtimeCalendarVisibleShifts.length === 0)) {
                const defaultShiftNames = ['Graveyard', 'Day Shift', 'Swing Shift'];
                currentData.overtimeCalendarVisibleShifts = currentData.shifts
                    .filter(s => !s.archived && defaultShiftNames.includes(s.name))
                    .map(s => s.id);
            }
        }

        function showManageOvertimeCalendarShiftsModal() {
            let html = `<p style="margin-bottom:15px; color:#64748b; font-size:13px;">Select which shifts to display on the Overtime Signup Calendar.</p>
            <div style="display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto;">`;
            
            currentData.shifts.filter(s => !s.archived).sort((a,b)=>a.order-b.order).forEach(s => {
                const isChecked = currentData.overtimeCalendarVisibleShifts.includes(s.id) ? 'checked' : '';
                html += `<label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border:1px solid #e2e8f0; border-radius:6px; background:#f8fafc;">
                            <input type="checkbox" class="ot-cal-shift-check" value="${s.id}" ${isChecked} style="width:auto;">
                            <span style="font-weight:600; color:${s.color}">${s.name}</span>
                         </label>`;
            });
            
            html += `</div>
            <div class="action-buttons" style="margin-top:20px; padding-top:15px; border-top:1px solid #e2e8f0;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveOvertimeCalendarShifts()">Save & View</button>
            </div>`;
            
            createModal('Manage Calendar Shifts', html, '400px');
        }

        function saveOvertimeCalendarShifts() {
            const checkboxes = document.querySelectorAll('.ot-cal-shift-check');
            currentData.overtimeCalendarVisibleShifts = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            closeModal();
            loadOvertimeCalendar();
        }

        function populateOTShiftFilter() {
            const select = document.getElementById('otShiftFilter');
            if (!select) return;
            
            select.innerHTML = '<option value="">All Shifts</option>';
            currentData.shifts.filter(s => !s.archived && currentData.overtimeCalendarVisibleShifts.includes(s.id)).sort((a,b) => a.order - b.order).forEach(shift => {
                select.innerHTML += '<option value="' + shift.id + '">' + shift.name + '</option>';
            });
        }

        // Removed switchOTShift as we now show all shifts in one view

        // Removed switchOTShift as we now show all shifts in one view
        
        function prevCalOT() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); updateOTView(); }
        function nextCalOT() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); updateOTView(); }
        function todayCalOT() { currentCalendarDate = new Date(); updateOTView(); }
        
        function clearOvertimeForMonth() {
            const monthName = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            showConfirmationModal('Clear Month?', `Delete ALL overtime signups for ${monthName}? This cannot be undone.`, () => {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                // Filter out signups that belong to the current month view
                currentData.overtimeSignups = currentData.overtimeSignups.filter(s => {
                    const d = getLocalDateFromStr(s.date);
                    // Keep if year or month is different (Note: JS months are 0-indexed)
                    return d.getFullYear() !== year || d.getMonth() !== month;
                });
                
                // Also remove OT assignments from the main calendar for this month if they were approved
                currentData.assignments = currentData.assignments.filter(a => {
                    if (!OVERTIME_ASSIGNMENTS.includes(a.type)) return true;
                    const d = getLocalDateFromStr(a.date);
                    return d.getFullYear() !== year || d.getMonth() !== month;
                });

                logAction('Clear OT Log', `Cleared overtime for ${monthName}`);
                updateOTView();
                alert(`Cleared overtime log for ${monthName}.`);
            });
        }

        function updateOTView() { 
            const label = document.getElementById('otCalendarPeriodLabel'); 
            if (!label) return; 
            label.textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }); 
            
            const container = document.getElementById('otCalendarContainer'); 
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay(); // 0 = Sun

            let html = `<div class="calendar-grid calendar-month-view ot-calendar-grid">`;
            
            // Headers
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => html+=`<div class="calendar-header-cell">${d}</div>`);
            
            // Padding for previous month
            for(let i=0; i<firstDayIndex; i++) html+=`<div class="calendar-cell other-month"></div>`;
            
            // Active Shifts
            // Active Shifts - with optional filter
            const shiftFilterValue = document.getElementById('otShiftFilter') ? document.getElementById('otShiftFilter').value : '';
           
            let shifts = currentData.shifts.filter(s => !s.archived && currentData.overtimeCalendarVisibleShifts.includes(s.id)).sort((a,b) => a.order - b.order);
            if (shiftFilterValue) {
                shifts = shifts.filter(s => s.id === shiftFilterValue);
            }

            // Days
            for(let i=1; i<=daysInMonth; i++) {
                const dateStr = getLocalDateString(new Date(year, month, i)); 
                html += `<div class="calendar-cell">
                            <div class="calendar-day-label" style="margin-bottom:8px; font-weight:bold; color:#64748b; font-size:14px;">${i}</div>`;
                
                shifts.forEach(shift => {
                     // Count volunteers for this shift on this day (across all schedules linked to this shift)
                     const volunteers = currentData.overtimeSignups.filter(s => s.date === dateStr && s.shiftId === shift.id && s.status !== 'cancelled');
                     const count = volunteers.length;
                     const isSelected = overtimeSelectedDates.some(x => x.date === dateStr && x.shiftId === shift.id);
                     
                     // MODIFICATION: Split Bubble Layout
                     html += `<div class="ot-shift-row">
                                <div class="ot-signup-bubble ${isSelected ? 'selected' : ''}" 
                                     style="border-left-color:${shift.color}" 
                                     onclick="toggleOTSelection('${shift.id}', '${dateStr}')"
                                     title="Click to Select for Signup">
                                    <span style="font-weight:600; color:#334155;">${shift.name}</span>
                                    <span class="ot-signup-icon">${isSelected ? 'âœ“' : '+'}</span>
                                </div>
                                <div class="ot-view-bubble ${count > 0 ? 'has-volunteers' : ''}" 
                                     onclick="showOTVolunteersModal('${shift.id}', '${dateStr}')"
                                     title="View Volunteers">
                                    ${count} <span style="font-size:10px; margin-left:4px;">ðŸ‘¥</span>
                                </div>
                              </div>`;
                });
                
                html += `</div>`;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }

        function handleOTBlockClick(e, shiftId, dateStr) {
            // Default behavior is now TOGGLE SELECTION to support "selecting as many as they want" easily.
            // Managers can view the list by clicking the badge or icon.
            toggleOTSelection(shiftId, dateStr);
        }

        function toggleOTSelection(shiftId, dateStr) { 
            const idx = overtimeSelectedDates.findIndex(x => x.date === dateStr && x.shiftId === shiftId); 
            if(idx > -1) { overtimeSelectedDates.splice(idx, 1); } 
            else { overtimeSelectedDates.push({ shiftId, date: dateStr }); } 
            updateOTView(); 
            updateOTFloatingBar(); 
        }
        
        function updateOTFloatingBar() { const bar = document.getElementById('otFloatingBar'); if(!bar) return; const count = overtimeSelectedDates.length; if(count > 0) { bar.classList.add('visible'); document.getElementById('otSelectedCount').textContent = `${count} Shift(s) Selected`; } else { bar.classList.remove('visible'); } }
        function clearOTSelection() { overtimeSelectedDates = []; updateOTView(); updateOTFloatingBar(); }
        
        // Batch Signup (from Floating Bar)
        function showOTSignupModalBatch() { 
            const empOptions = getFullTimeEmployees().map(e => `<option value="${e.id}">${e.name}</option>`).join(''); 
            createModal('Batch Sign Up', `
                <p>Signing up for <strong>${overtimeSelectedDates.length}</strong> selected slots.</p>
                <div class="form-row"><div><label>Employee</label><select id="otSignupEmp">${empOptions}</select></div></div>
                <div class="form-row"><div><label>Phone</label><input id="otPhone"></div><div><label>Notes</label><input id="otNotes"></div></div>
                <div class="action-buttons"><button class="btn btn-primary" onclick="processOTSignupBatch()">Confirm Sign Up</button></div>
            `); 
        }

        function processOTSignupBatch() { 
            const empId = document.getElementById('otSignupEmp').value; 
            const phone = document.getElementById('otPhone').value; 
            const notes = document.getElementById('otNotes').value; 
            
            overtimeSelectedDates.forEach(item => { 
                // We need to pick a default schedule for this shift since assignment model requires it
                // We'll pick the first available active schedule for the shift
                const sched = currentData.schedules.find(s => s.shiftId === item.shiftId && !s.archived);
                const schedId = sched ? sched.id : null;
                
                    currentData.overtimeSignups.push({ 
                        id: generateId(), 
                        employeeId: empId, 
                        shiftId: item.shiftId, 
                        scheduleId: schedId, 
                        date: item.date, 
                        status: 'pending', 
                        phone, 
                        notes, 
                        contactLog: [] 
                    }); 
            }); 
            logAction('Batch OT Signup', `Signed up ${overtimeSelectedDates.length} slots`, currentData.employees.find(e=>e.id===empId));
            clearOTSelection(); 
            closeModal(); 
            updateOTView(); 
        }

        // Single Shift Volunteers Modal
        function showOTVolunteersModal(shiftId, dateStr) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const shift = currentData.shifts.find(s => s.id === shiftId);
            
            // MODIFICATION: Removed the filter "&& s.status !== 'cancelled'" so cancelled items remain in the list
            const signups = currentData.overtimeSignups.filter(s => s.date === dateStr && s.shiftId === shiftId)
                .sort((a,b) => { 
                    const empA = currentData.employees.find(e => e.id === a.employeeId); 
                    const empB = currentData.employees.find(e => e.id === b.employeeId); 
                    const dateA = empA.seniorityDate ? new Date(empA.seniorityDate) : new Date('9999-12-31');
                    const dateB = empB.seniorityDate ? new Date(empB.seniorityDate) : new Date('9999-12-31');
                    return dateA - dateB; 
                }); 
            
            let html = `<div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                            <h3>${shift.name} - ${formatDate(dateStr)}</h3>
                            <button class="btn btn-primary btn-sm" onclick="showOTSignupModalSingle('${shiftId}', '${dateStr}')">+ Add Volunteer</button>
                        </div>`; 
            
            if (signups.length === 0) {
                html += `<div style="padding:20px; text-align:center; color:#64748b; background:#f8fafc; border-radius:8px;">No volunteers yet.</div>`;
            } else {
                // MODIFICATION: Added "Details" column
                html += `<table><thead><tr><th>Name</th><th>Details</th><th>Status</th><th>Log</th><th>Actions</th></tr></thead><tbody>`; 
                signups.forEach(s => { 
                    const emp = currentData.employees.find(e => e.id === s.employeeId); 
                    const latestLog = s.contactLog && s.contactLog.length > 0 ? s.contactLog[s.contactLog.length-1] : null;
                    
                    // MODIFICATION: Use Bubble Style for Logs
                    let logSummary;
                    if (latestLog) {
                        const timeStr = new Date(latestLog.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                        logSummary = `<div class="log-bubble" onclick="showContactLogModal('${s.id}')" title="Click to view full log">
                            <span class="log-bubble-time">${timeStr}</span>
                            <span class="log-bubble-text">${latestLog.message}</span>
                        </div>`;
                    } else {
                        logSummary = `<div class="log-bubble empty" onclick="showContactLogModal('${s.id}')" title="Add Log Entry">No Logs</div>`;
                    }
                    
                    // MODIFICATION: Logic to handle cancelled/declined styling
                    const isCancelled = s.status === 'cancelled';
                    const isDeclined = s.status === 'declined';
                    const nameClass = (isCancelled || isDeclined) ? 'scratched' : '';
                    let statusStyle = '';
                    
                    if (isCancelled) statusStyle = 'background:#f1f5f9; color:#94a3b8; border:1px solid #e2e8f0;';
                    else if (isDeclined) statusStyle = 'background:#fef2f2; color:#b91c1c; border:1px solid #fecaca;';
                    else if (s.status === 'approved') statusStyle = 'background:#dcfce7; color:#166534;';
                    else statusStyle = 'background:#fff7ed; color:#c2410c;';

                    const isPending = !isCancelled && !isDeclined && s.status !== 'approved';

                    // MODIFICATION: Generate Details Cell Content (Clickable for Popup)
                    const phoneDisplay = s.phone ? `<div style="font-size:11px; color:#475467; margin-bottom:2px;">ðŸ“ž ${s.phone}</div>` : '';
                    
                    // Added truncation styles to the note display
                    const noteDisplay = s.notes ? `<div style="font-size:11px; color:#64748b; font-style:italic; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">ðŸ“ ${s.notes}</div>` : '';
                    
                    let detailsContent;
                    if (phoneDisplay || noteDisplay) {
                        // Clickable container for existing details
                        detailsContent = `<div style="cursor:pointer; background:#f8fafc; border:1px solid #cbd5e1; border-radius:6px; padding:4px 8px; min-width:120px; max-width:220px;" 
                                            onclick="editOTSignupDetails('${s.id}')" 
                                            title="Click to View/Edit Full Details">
                                            ${phoneDisplay}${noteDisplay}
                                           </div>`;
                    } else {
                        // Button to add details if none exist
                        detailsContent = `<button class="action-bubble edit" onclick="editOTSignupDetails('${s.id}')">+ Details</button>`;
                    }

                    const seniorityDisplay = emp.seniorityDate ? `<span style="font-size:11px; color:#64748b; font-weight:normal; margin-left:4px;">(${formatDate(emp.seniorityDate)})</span>` : '';

                    const canApprove = (role === ROLES.OWNER || role === ROLES.ADMIN);
                    html += `<tr>
                        <td class="${nameClass}">${emp.name}${seniorityDisplay}</td>
                        <td>${detailsContent}</td>
                        <td><span class="status-badge" style="${statusStyle}">${s.status}</span></td>
                        <td style="max-width:250px;">${logSummary}</td>
                        <td>
                            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                                ${isPending && canApprove ? `<button class="btn btn-success btn-sm" onclick="approveOT('${s.id}', '${s.scheduleId}', '${dateStr}')">Approve</button>` : ''}
                                ${isPending && canApprove ? `<button class="btn btn-warning btn-sm" onclick="declineOT('${s.id}')">Decline</button>` : ''}
                                ${!isCancelled && !isDeclined ? `<button class="btn btn-danger btn-sm" onclick="cancelOT('${s.id}')">Cancel</button>` : ''}
                            </div>
                        </td>
                    </tr>`; 
                }); 
                html += `</tbody></table>`; 
            }
            createModal('Volunteers', html, '950px'); // Increased width to prevent cramping
        }

        // NEW FUNCTION: Edit Details Popup
        function editOTSignupDetails(signupId) {
            const s = currentData.overtimeSignups.find(x => x.id === signupId);
            if(!s) return;
            const emp = currentData.employees.find(e => e.id === s.employeeId);
            
            // Changed note input to textarea for better readability of long text
            createModal(`Edit Details: ${emp.name}`, `
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="editOTPhone" value="${s.phone || ''}" placeholder="e.g. 555-0123">
                </div>
                <div class="form-group">
                    <label>Signup Note</label>
                    <textarea id="editOTNote" rows="5" placeholder="Enter full details here..." style="width:100%; resize:vertical; padding:8px; border:1px solid var(--border-color); border-radius:6px;">${s.notes || ''}</textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="showOTVolunteersModal('${s.shiftId}', '${s.date}')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveOTSignupDetails('${signupId}')">Save Details</button>
                </div>
            `, '500px');
        }

        // NEW FUNCTION: Save Details
        function saveOTSignupDetails(signupId) {
            const s = currentData.overtimeSignups.find(x => x.id === signupId);
            if(s) {
                s.phone = document.getElementById('editOTPhone').value;
                s.notes = document.getElementById('editOTNote').value;
                // Return to the volunteers list to see changes
                showOTVolunteersModal(s.shiftId, s.date);
            }
        }

        function showOTSignupModalSingle(shiftId, dateStr) {
            const empOptions = getFullTimeEmployees().filter(e => !e.isHidden).map(e => `<option value="${e.id}">${e.name}</option>`).join(''); 
            
            // Removed Schedule Preference Dropdown
            createModal('Sign Up Volunteer', `
                <div class="form-row">
                    <div><label>Employee</label><select id="otSingleEmp">${empOptions}</select></div>
                </div>
                <div class="form-row">
                    <div><label>Phone</label><input id="otSinglePhone"></div>
                    <div><label>Notes</label><input id="otSingleNotes"></div>
                </div>
                <div class="action-buttons"><button class="btn btn-primary" onclick="processOTSignupSingle('${shiftId}', '${dateStr}')">Sign Up</button></div>
            `);
        }

        function processOTSignupSingle(shiftId, dateStr) {
            const empId = document.getElementById('otSingleEmp').value;
            const phone = document.getElementById('otSinglePhone').value;
            const notes = document.getElementById('otSingleNotes').value;

            // Automatically pick the first active schedule for this shift
            const sched = currentData.schedules.find(s => s.shiftId === shiftId && !s.archived);
            const schedId = sched ? sched.id : null;

            currentData.overtimeSignups.push({ 
                id: generateId(), 
                employeeId: empId, 
                shiftId: shiftId, 
                scheduleId: schedId, 
                date: dateStr, 
                status: 'pending', 
                phone, 
                notes, 
                contactLog: [] 
            }); 

            logAction('Single OT Signup', `Signed up for ${shiftId} on ${dateStr}`, currentData.employees.find(e=>e.id===empId));
            // Return to the list view
            showOTVolunteersModal(shiftId, dateStr);
            updateOTView();
        }

        function showContactLogModal(signupId) {
            const signup = currentData.overtimeSignups.find(s => s.id === signupId);
            const emp = currentData.employees.find(e => e.id === signup.employeeId);
            
            let logHtml = `<div id="logEntries" style="max-height:300px; overflow-y:auto; background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0;">`;
            if (!signup.contactLog || signup.contactLog.length === 0) {
                logHtml += `<p style="color:#94a3b8; text-align:center;">No log entries.</p>`;
            } else {
                signup.contactLog.forEach(log => {
                    logHtml += `<div style="margin-bottom:10px; border-bottom:1px solid #e2e8f0; padding-bottom:5px;">
                        <div style="display:flex; justify-content:space-between; font-size:10px; color:#64748b;">
                            <strong>${new Date(log.timestamp).toLocaleString()}</strong>
                        </div>
                        <div style="font-size:13px; color:#334155;">${log.message}</div>
                    </div>`;
                });
            }
            logHtml += `</div>
                <div class="form-group"><label>Add Log Entry</label><input type="text" id="newLogEntry" placeholder="e.g. Called, left voicemail"></div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addContactLog('${signupId}')">Add Entry</button>
                    <button class="btn btn-secondary" onclick="showOTVolunteersModal('${signup.shiftId}', '${signup.date}')">Back</button>
                </div>`;
            
            createModal(`Log: ${emp.name}`, logHtml, '500px');
        }

        function addContactLog(signupId) {
            const msg = document.getElementById('newLogEntry').value;
            if (!msg) return;
            const signup = currentData.overtimeSignups.find(s => s.id === signupId);
            if (!signup.contactLog) signup.contactLog = [];
            signup.contactLog.push({ timestamp: new Date().toISOString(), message: msg });
            showContactLogModal(signupId);
        }

        function getVacantScheduleId(shiftId, dateStr) {
            const scheds = currentData.schedules.filter(s => s.shiftId === shiftId && !s.archived).sort((a,b)=>(a.order||99)-(b.order||99));
            const dObj = getLocalDateFromStr(dateStr);
            const dayOfWeek = dObj.getDay();

            for (const sched of scheds) {
                // Check if work day
                if (sched.workDays && !sched.workDays.includes(dayOfWeek)) continue;

                // Check assignments
                const asses = currentData.assignments.filter(a => a.scheduleId === sched.id && a.date === dateStr);
                const hasFilling = asses.some(a => WORKING_HOUR_TYPES.includes(a.type) && a.type !== ASSIGNMENT_TYPES.TRAINING);
                
                if (!hasFilling) return sched.id;
            }
            return null;
        }

        function approveOT(id, scheduleId, dateStr) { 
             const s = currentData.overtimeSignups.find(x=>x.id===id);
             if(!s) return;
             // Check for duplicate
             const duplicate = currentData.assignments.find(a => a.date === dateStr && a.employeeId === s.employeeId && OVERTIME_ASSIGNMENTS.includes(a.type));
             if(duplicate) return alert('Employee has already worked an overtime on this date.');
             
             // Auto-assign to vacant slot
             let targetSchedId = getVacantScheduleId(s.shiftId, dateStr);
             
             if (!targetSchedId) {
                 if (!confirm("No vacant slots available for this shift. Approve and assign anyway?")) return;
                 
                 // Fallback to signup schedule or first active
                 targetSchedId = (scheduleId && scheduleId !== 'null' && scheduleId !== 'undefined') ? scheduleId : null;
                 if (!targetSchedId) {
                     const sched = currentData.schedules.find(sch => sch.shiftId === s.shiftId && !sch.archived);
                     if (sched) targetSchedId = sched.id;
                 }
             }

             if(applyAssignment(s.employeeId, targetSchedId, dateStr, dateStr, ASSIGNMENT_TYPES.OVERTIME_V)) {
                 s.status = 'approved';
                 
                 // Log approval
                 if(!s.contactLog) s.contactLog = [];
                 s.contactLog.push({ timestamp: new Date().toISOString(), message: "Approved and assigned." });
                 logAction('Approve OT', `Approved OT on ${dateStr}`, currentData.employees.find(e=>e.id===s.employeeId));

                 // Refresh modal to show updated status
                 showOTVolunteersModal(s.shiftId, dateStr);
                 updateOTView();
             }
        }
        
        function declineOT(id) {
            const s = currentData.overtimeSignups.find(x => x.id === id);
            if (!s) return;
            
            showConfirmationModal('Decline Signup?', 'Are you sure you want to decline this overtime? This will cancel the signup and scratch the employee from the Voluntary List.', () => {
                s.status = 'declined';
                
                // Log Decline with Timestamp
                if (!s.contactLog) s.contactLog = [];
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const dateStr = now.toLocaleDateString();
                
                s.contactLog.push({ 
                    timestamp: now.toISOString(), 
                    message: `Declined: ${dateStr} ${timeStr}` 
                });

                // Scratch from Voluntary List
                if (!currentData.overtimeScratches.voluntary.includes(s.employeeId)) {
                    currentData.overtimeScratches.voluntary.push(s.employeeId);
                }
                
                logAction('Decline OT', `Declined OT on ${s.date}`, currentData.employees.find(e=>e.id===s.employeeId));
                showOTVolunteersModal(s.shiftId, s.date);
                updateOTView();
            });
        }

        function cancelOT(id) { 
            const s = currentData.overtimeSignups.find(x=>x.id===id); 
            if(!s) return;

            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE && currentUser.id !== s.employeeId) {
                return alert("Access Denied: You can only cancel your own overtime signups.");
            }

            showConfirmationModal('Cancel Signup?', 'Are you sure you want to cancel this overtime signup?', () => {
                s.status = 'cancelled'; 
                
                if (!s.contactLog) s.contactLog = [];
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const dateStr = now.toLocaleDateString();
                
                s.contactLog.push({ timestamp: now.toISOString(), message: `Cancelled: ${dateStr} ${timeStr}` });
                
                logAction('Cancel OT', `Cancelled OT on ${s.date}`, currentData.employees.find(e=>e.id===s.employeeId));
                showOTVolunteersModal(s.shiftId, s.date); 
                updateOTView(); 
            });
        }
        
        // --- NOTE FUNCTIONALITY ---
        function showNoteInputModal(empId, listType) {
            const emp = currentData.employees.find(e => e.id === empId);
            const currentNote = currentData.overtimeNotes[empId] || '';
            
            createModal(`Note: ${emp.name}`, `
                <div class="form-group">
                    <label>Enter Note for ${listType} list:</label>
                    <textarea id="tempNoteInput" rows="6" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-family:inherit;">${currentNote}</textarea>
                </div>
                <div class="action-buttons" style="justify-content: flex-end; gap: 10px;">
                    <button class="btn btn-secondary" onclick="${listType === 'voluntary' ? 'showVoluntaryOTListModal()' : 'showMandatoryOTListModal()'}">Cancel</button>
                    <button class="btn btn-primary" onclick="saveNoteAndReturn('${empId}', '${listType}')">Save Note</button>
                </div>
            `, '500px');
            
            // Auto-focus the textarea
            setTimeout(() => {
                const el = document.getElementById('tempNoteInput');
                if(el) { el.focus(); el.setSelectionRange(el.value.length, el.value.length); }
            }, 100);
        }

        function saveNoteAndReturn(empId, listType) {
            const val = document.getElementById('tempNoteInput').value;
            currentData.overtimeNotes[empId] = val;
            if (listType === 'voluntary') showVoluntaryOTListModal();
            else showMandatoryOTListModal();
        }

        function showVoluntaryOTListModal() { 
            if (!currentVoluntaryFilter) {
                const ft = currentData.employeeTypes.find(t => t.name === 'Full-time');
                currentVoluntaryFilter = ft ? ft.id : 'all';
            }

            const typeOptions = `<option value="all" ${currentVoluntaryFilter === 'all' ? 'selected' : ''}>All Types</option>` + 
                currentData.employeeTypes.map(t => `<option value="${t.id}" ${t.id === currentVoluntaryFilter ? 'selected' : ''}>${t.name}</option>`).join('');

            let html = `<div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div class="filter-group" style="margin:0;">
                    <label style="margin-right:10px; display:inline;">Filter Type:</label>
                    <select onchange="updateVoluntaryFilter(this.value)" style="padding:6px; width:auto; display:inline-block;">${typeOptions}</select>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-secondary btn-sm" onclick="showManageListEmployeesModal('voluntary')">Manage Employees</button>
                    <button class="btn btn-warning btn-sm" onclick="resetOTList('voluntary')">Reset List</button>
                </div>
            </div>
            <table><thead><tr><th>Rank</th><th>Name</th><th>Seniority</th><th>Notes</th><th>Action</th></tr></thead><tbody>`; 
            
            let employees = currentData.employees.filter(e => !e.archived);
            if (currentVoluntaryFilter !== 'all') employees = employees.filter(e => e.type === currentVoluntaryFilter);
            employees.sort((a,b) => { const diff = new Date(a.seniorityDate) - new Date(b.seniorityDate); return diff !== 0 ? diff : a.name.localeCompare(b.name); });

            employees.forEach((e, i) => { 
                const scratched = currentData.overtimeScratches.voluntary.includes(e.id); 
                const note = currentData.overtimeNotes[e.id] || ''; 
                const noteBtnClass = note ? 'edit' : 'view';
                const noteBtnText = note ? 'View/Edit Note' : 'Add Note';
                
                html += `<tr>
                    <td>${i+1}</td>
                    <td class="${scratched?'scratched':''}">${e.name}</td>
                    <td>${formatDate(e.seniorityDate)}</td>
                    <td><button class="action-bubble ${noteBtnClass}" onclick="showNoteInputModal('${e.id}', 'voluntary')">${noteBtnText}</button></td>
                    <td><button class="btn btn-sm" onclick="toggleScratch('voluntary','${e.id}')">${scratched?'Unscratch':'Scratch'}</button></td>
                </tr>`; 
            }); 
            html += `</tbody></table>`; 
            createModal('Voluntary List', html); 
        }
        
        function updateVoluntaryFilter(val) { currentVoluntaryFilter = val; showVoluntaryOTListModal(); }
        function updateMandatoryFilter(val) { currentMandatoryFilter = val; showMandatoryOTListModal(); }

        function showMandatoryOTListModal() { 
            if(!currentData.overtimeRefusals) currentData.overtimeRefusals = {};
            // Initialize config for visible shifts if not present (Default to the standard 3)
            if (!currentData.mandatoryVisibleShifts) {
                const defaultShiftNames = ['Graveyard', 'Day Shift', 'Swing Shift'];
                currentData.mandatoryVisibleShifts = currentData.shifts
                    .filter(s => !s.archived && defaultShiftNames.includes(s.name))
                    .map(s => s.id);
            }

            if (!currentMandatoryFilter) {
                const ft = currentData.employeeTypes.find(t => t.name === 'Full-time');
                currentMandatoryFilter = ft ? ft.id : 'all';
            }

            const typeOptions = `<option value="all" ${currentMandatoryFilter === 'all' ? 'selected' : ''}>All Types</option>` + 
                currentData.employeeTypes.map(t => `<option value="${t.id}" ${t.id === currentMandatoryFilter ? 'selected' : ''}>${t.name}</option>`).join('');
            
            // Filter shifts based on user selection
            const shifts = currentData.shifts
                .filter(s => !s.archived && currentData.mandatoryVisibleShifts.includes(s.id))
                .sort((a,b)=>a.order-b.order); 
            
            // Add "Manage Lists" button and Filter at the top
            let content = `<div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div class="filter-group" style="margin:0;"><label style="margin-right:10px; display:inline;">Filter Type:</label><select onchange="updateMandatoryFilter(this.value)" style="padding:6px; width:auto; display:inline-block;">${typeOptions}</select></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-secondary btn-sm" onclick="showManageListEmployeesModal('mandatory')">Manage Employees</button>
                    <button class="btn btn-secondary btn-sm" onclick="showManageMandatoryShiftsModal()">âš™ï¸ Manage Shifts</button>
                </div>
            </div>`;

            content += `<div style="display:flex; gap:15px; overflow-x:auto;">`; 
            
            if (shifts.length === 0) {
                content += `<div style="padding:20px; color:#64748b; font-style:italic;">No shifts selected. Click "Manage Lists" to add shifts.</div>`;
            }

            shifts.forEach(shift => { 
                let shiftEmps = currentData.employees.filter(e => e.defaultShift === shift.id && !e.archived);
                if (currentMandatoryFilter !== 'all') shiftEmps = shiftEmps.filter(e => e.type === currentMandatoryFilter);
                shiftEmps.sort((a,b) => { const diff = new Date(b.seniorityDate) - new Date(a.seniorityDate); return diff !== 0 ? diff : b.name.localeCompare(a.name); });
                
                content += `<div style="flex:1; min-width:280px; border:1px solid #eee; padding:10px; border-radius:8px; background:#fff;">
                    <h4 style="border-bottom:2px solid ${shift.color}; margin-bottom:10px; padding-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
                        ${shift.name} 
                        <button class="action-bubble view" title="Reset ${shift.name}" onclick="resetMandatoryListForShift('${shift.id}')">Reset</button>
                    </h4>
                    <div style="max-height:400px; overflow-y:auto;">`; 
                
                shiftEmps.forEach((emp, idx) => { 
                    const scratched = currentData.overtimeScratches.mandatory.includes(emp.id); 
                    const refusal = currentData.overtimeRefusals[emp.id];
                    const isRefused = refusal && refusal.active;
                    const note = currentData.overtimeNotes[emp.id] || ''; 
                    const noteBtnClass = note ? 'edit' : 'view';
                    const noteBtnText = note ? 'Note' : '+ Note';
                    
                    const nameClass = `${scratched ? 'scratched' : ''} ${isRefused ? 'refused-text' : ''}`;

                    content += `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 5px; background:${scratched?'#f8fafc':'white'}; border-bottom:1px solid #f1f5f9;">
                        <span class="${nameClass}" style="font-size:13px;">${idx+1}. ${emp.name} ${isRefused ? '(Refused)' : ''}</span>
                        <div style="display:flex; align-items:center; gap:4px;">
                            <button class="action-bubble ${noteBtnClass}" onclick="showNoteInputModal('${emp.id}', 'mandatory')" style="margin-right:2px;">${noteBtnText}</button>
                            <button class="action-bubble delete" onclick="showRefusalModal('${emp.id}')" style="color:${isRefused?'#ef4444':'#64748b'}">${isRefused ? 'Refused' : 'Refuse'}</button>
                            ${!scratched ? `<button class="action-bubble edit" title="Force Assign" onclick="forceAssignModal('${emp.id}')">Force</button>` : ''}
                            <button class="action-bubble ${scratched?'restore':'delete'}" onclick="toggleScratch('mandatory','${emp.id}')">${scratched?'Un':'Sc'}</button>
                        </div>
                    </div>`; 
                }); 
                content += `</div></div>`; 
            }); 
            content += `</div>`; 
            createModal('Mandatory Lists', content, '95vw'); 
        }

        function showManageListEmployeesModal(listType) {
            // Ensure list is initialized
            if(!currentData.overtimeLists[listType] || !currentData.overtimeLists[listType].length) {
                 currentData.overtimeLists[listType] = getFullTimeEmployees().map(e=>e.id);
            }

            let html = `<p style="margin-bottom:15px; color:#64748b; font-size:13px;">Select employees to include in the ${listType === 'voluntary' ? 'Voluntary' : 'Mandatory'} Overtime List.</p>
            <div style="display:flex; flex-direction:column; gap:8px; max-height:400px; overflow-y:auto;">`;
            
            // List all active employees
            const allEmps = currentData.employees.filter(e => !e.archived).sort((a,b) => a.name.localeCompare(b.name));
            
            allEmps.forEach(e => {
                const isChecked = currentData.overtimeLists[listType].includes(e.id) ? 'checked' : '';
                const typeName = currentData.employeeTypes.find(t => t.id === e.type)?.name || '';
                html += `<label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border:1px solid #e2e8f0; border-radius:6px; background:#f8fafc;">
                            <input type="checkbox" class="list-emp-check" value="${e.id}" ${isChecked} style="width:auto;">
                            <div>
                                <div style="font-weight:600; font-size:13px;">${e.name}</div>
                                <div style="font-size:11px; color:#64748b;">${typeName}</div>
                            </div>
                         </label>`;
            });
            
            html += `</div>
            <div class="action-buttons" style="margin-top:20px; padding-top:15px; border-top:1px solid #e2e8f0;">
                <button class="btn btn-secondary" onclick="${listType === 'voluntary' ? 'showVoluntaryOTListModal()' : 'showMandatoryOTListModal()'}">Cancel</button>
                <button class="btn btn-primary" onclick="saveListEmployees('${listType}')">Save Changes</button>
            </div>`;
            
            createModal(`Manage ${listType === 'voluntary' ? 'Voluntary' : 'Mandatory'} List`, html, '450px');
        }

        function saveListEmployees(listType) {
            const checkboxes = document.querySelectorAll('.list-emp-check');
            currentData.overtimeLists[listType] = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (listType === 'voluntary') showVoluntaryOTListModal();
            else showMandatoryOTListModal();
        }
        
        function showRefusalModal(empId) {
            const emp = currentData.employees.find(e => e.id === empId);
            const refusal = currentData.overtimeRefusals[empId];
            const isRefused = refusal && refusal.active;
            const dateVal = isRefused ? refusal.date : getTodayDateString();
            
            createModal(`Refusal: ${emp.name}`, `
                <div class="form-group">
                    <label>Date of Refusal</label>
                    <input type="date" id="refusalDate" value="${dateVal}">
                </div>
                <div class="action-buttons">
                    ${isRefused ? `<button class="btn btn-success" onclick="undoRefusal('${empId}')">Undo Refusal</button>` : ''}
                    <button class="btn btn-danger" onclick="saveRefusal('${empId}')">${isRefused ? 'Update Date' : 'Confirm Refusal'}</button>
                    <button class="btn btn-secondary" onclick="showMandatoryOTListModal()">Cancel</button>
                </div>
            `, '400px');
        }
        
        function saveRefusal(empId) { const date = document.getElementById('refusalDate').value; if(!date) return; currentData.overtimeRefusals[empId] = { date: date, active: true }; showMandatoryOTListModal(); }
        function undoRefusal(empId) { if(currentData.overtimeRefusals[empId]) currentData.overtimeRefusals[empId].active = false; showMandatoryOTListModal(); }

        function showManageMandatoryShiftsModal() {
            let html = `<p style="margin-bottom:15px; color:#64748b; font-size:13px;">Select which shift lists to display in the Mandatory Overtime view.</p>
            <div style="display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto;">`;
            
            currentData.shifts.filter(s => !s.archived).sort((a,b)=>a.order-b.order).forEach(s => {
                const isChecked = currentData.mandatoryVisibleShifts.includes(s.id) ? 'checked' : '';
                html += `<label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:8px; border:1px solid #e2e8f0; border-radius:6px; background:#f8fafc;">
                            <input type="checkbox" class="mand-shift-check" value="${s.id}" ${isChecked} style="width:auto;">
                            <span style="font-weight:600; color:${s.color}">${s.name}</span>
                         </label>`;
            });
            
            html += `</div>
            <div class="action-buttons" style="margin-top:20px; padding-top:15px; border-top:1px solid #e2e8f0;">
                <button class="btn btn-secondary" onclick="showMandatoryOTListModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveMandatoryShiftSelection()">Save & View</button>
            </div>`;
            
            createModal('Manage Mandatory Lists', html, '400px');
        }

        function saveMandatoryShiftSelection() {
            const checkboxes = document.querySelectorAll('.mand-shift-check');
            currentData.mandatoryVisibleShifts = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            showMandatoryOTListModal();
        }

        function forceAssignModal(empId) { const emp = currentData.employees.find(e => e.id === empId); const shifts = currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)); const shiftOpts = shifts.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); createModal(`Force Assign: ${emp.name}`, `<div class="form-group"><label>Date</label><input type="date" id="forceDate" onchange="updateForceScheds()"></div><div class="form-group"><label>Shift</label><select id="forceShift" onchange="updateForceScheds()">${shiftOpts}</select></div><div class="form-group"><label>Schedule</label><select id="forceSched"></select></div><button class="btn btn-danger" onclick="processForceAssign('${empId}')">Assign Mandatory OT</button>`); updateForceScheds(); }
        function updateForceScheds() { 
            const shiftId = document.getElementById('forceShift').value; 
            const date = document.getElementById('forceDate').value;
            const container = document.getElementById('forceSched'); 
            const scheds = currentData.schedules.filter(s => s.shiftId === shiftId && !s.archived); 
            container.innerHTML = scheds.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); 
            
            // Auto-select vacant if date is present
            if (date) {
                const vacantId = getVacantScheduleId(shiftId, date);
                if (vacantId) container.value = vacantId;
            }
        }
        function processForceAssign(empId) { 
            const date = document.getElementById('forceDate').value; const schedId = document.getElementById('forceSched').value; 
            if(!date || !schedId) return alert('Fields required'); 
            
            // Check for vacancy warning
            const vacantId = getVacantScheduleId(document.getElementById('forceShift').value, date);
            if (!vacantId && !confirm("No vacant slots available for this shift. Assign anyway?")) return;

            if(applyAssignment(empId, schedId, date, date, ASSIGNMENT_TYPES.OVERTIME_M)) { 
                logAction('Force Assign OT', `Force assigned to Mandatory OT on ${date}`, currentData.employees.find(e=>e.id===empId));
                closeModal(); alert(currentData.config.autoScratch !== false ? 'Assigned and scratched from Mandatory List.' : 'Assigned (Auto-Scratch OFF).'); 
            } 
        }
        function saveOTNote(empId, text) { currentData.overtimeNotes[empId] = text; }
        function toggleScratch(type, id) { const list = currentData.overtimeScratches[type]; if(list.includes(id)) currentData.overtimeScratches[type] = list.filter(x=>x!==id); else list.push(id); type === 'voluntary' ? showVoluntaryOTListModal() : showMandatoryOTListModal(); }
        function resetOTList(type) { currentData.overtimeScratches[type] = []; type === 'voluntary' ? showVoluntaryOTListModal() : showMandatoryOTListModal(); }
        function resetMandatoryListForShift(shiftId) { showConfirmationModal('Reset List', 'Unscratch all employees on this shift?', () => { const shiftEmps = currentData.employees.filter(e => e.defaultShift === shiftId).map(e=>e.id); currentData.overtimeScratches.mandatory = currentData.overtimeScratches.mandatory.filter(id => !shiftEmps.includes(id)); showMandatoryOTListModal(); }); }

        // --- Weekly Hours Full Implementation (Restored) ---
        function loadWeeklyHours() { 
            const container = document.getElementById('weeklyHours'); 
            container.innerHTML = `<div style="margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center;"><div><button class="btn btn-secondary" onclick="goHome()">â† Back to Home</button></div><button class="btn btn-secondary" onclick="printWeeklyHours()">Print</button></div><div class="filter-section" style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; gap:15px; align-items:center;"><div class="filter-group"><label>Shift:</label><select id="weeklyHoursShiftFilter" onchange="displayWeeklyHours()"></select></div><div class="filter-group"><label>Employee:</label><select id="weeklyHoursEmployeeFilter" onchange="displayWeeklyHours()"></select></div><div class="filter-group"><label>Type:</label><select id="weeklyHoursTypeFilter" onchange="displayWeeklyHours()"><option value="all">All Assignments</option><option value="work">Work Assignments</option><option value="timeoff">Time Off Assignments</option></select></div><div class="tabs" style="margin:0; box-shadow:none; margin-left:15px;"><button class="tab active" id="tabWHActive" onclick="toggleWeeklyHoursView('active')">Active</button><button class="tab" id="tabWHArchived" onclick="toggleWeeklyHoursView('archived')">Archived</button></div></div><div class="calendar-nav"><button class="btn btn-secondary" onclick="prevWeekH()">â†</button><button class="btn btn-secondary" onclick="todayWeekH()">Today</button><button class="btn btn-secondary" onclick="nextWeekH()">â†’</button><span id="whPeriodLabel" style="font-weight:bold; font-size:16px; margin-left:15px; align-self:center;"></span></div></div><div class="table-container bubble-container"><table id="whGrid" class="employee-bubble-table"></table></div>`; 
            weeklyHoursViewMode = 'active';
            populateWeeklyHoursFilters();
            displayWeeklyHours(); 
        }

        function toggleWeeklyHoursView(mode) {
            weeklyHoursViewMode = mode;
            document.getElementById('tabWHActive').classList.toggle('active', mode === 'active');
            document.getElementById('tabWHArchived').classList.toggle('active', mode === 'archived');
            populateWeeklyHoursFilters();
            displayWeeklyHours();
        }

        function populateWeeklyHoursFilters() {
            const sFilter = document.getElementById('weeklyHoursShiftFilter');
            const currentShift = sFilter.value;
            sFilter.innerHTML = '<option value="">All Shifts</option>' + currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            if(currentShift) sFilter.value = currentShift;

            const eFilter = document.getElementById('weeklyHoursEmployeeFilter');
            const currentEmp = eFilter.value;
            const employees = weeklyHoursViewMode === 'active' ? currentData.employees.filter(e => !e.archived) : currentData.employees.filter(e => e.archived);
            eFilter.innerHTML = '<option value="">All Employees</option>' + employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            if(currentEmp && employees.find(e => e.id === currentEmp)) eFilter.value = currentEmp;
            else eFilter.value = "";
        }

        function prevWeekH() { currentCalendarDate.setDate(currentCalendarDate.getDate()-7); displayWeeklyHours(); }
        function nextWeekH() { currentCalendarDate.setDate(currentCalendarDate.getDate()+7); displayWeeklyHours(); }
        function todayWeekH() { currentCalendarDate = new Date(); displayWeeklyHours(); }
        
        function calculateHours(assignment) {
            // Find schedule to get shift
            if(!assignment.scheduleId) return 0;
            const sched = currentData.schedules.find(s => s.id === assignment.scheduleId);
            if(!sched) return 0;
            const shift = currentData.shifts.find(s => s.id === sched.shiftId);
            if(!shift || !shift.startTime || !shift.endTime) return 0; // fallback

            const startParts = shift.startTime.split(':');
            const endParts = shift.endTime.split(':');
            if(startParts.length < 2 || endParts.length < 2) return 0;

            const start = parseInt(startParts[0], 10) + (parseInt(startParts[1], 10)/60);
            let end = parseInt(endParts[0], 10) + (parseInt(endParts[1], 10)/60);
            
            if (isNaN(start) || isNaN(end)) return 0;
            if (end < start) end += 24; // Overnight shift
            return end - start;
        }

        function displayWeeklyHours() { 
            const label = document.getElementById('whPeriodLabel'); 
            const dates = getWeekDates(currentCalendarDate); 
            label.textContent = `${dates[0].toLocaleDateString()} - ${dates[6].toLocaleDateString()}`; 
            const table = document.getElementById('whGrid'); 
            const shiftFilter = document.getElementById('weeklyHoursShiftFilter').value; 
            const empFilter = document.getElementById('weeklyHoursEmployeeFilter').value; 
            const typeFilter = document.getElementById('weeklyHoursTypeFilter') ? document.getElementById('weeklyHoursTypeFilter').value : 'all';
            
            let html = `<thead><tr><th style="min-width:150px;">Employee</th>` + dates.map(d=>`<th>${d.toLocaleDateString('en-US',{weekday:'short'})}<br>${d.getDate()}</th>`).join('') + `<th>Work</th><th>Off</th><th>Total</th></tr></thead><tbody>`; 
            
            let weekTotalWork = 0;
            let weekTotalOff = 0;
            let filteredEmps = weeklyHoursViewMode === 'active' ? currentData.employees.filter(e=>!e.archived) : currentData.employees.filter(e=>e.archived);
            filteredEmps = filteredEmps.filter(e => !e.isHidden);
            if(shiftFilter) filteredEmps = filteredEmps.filter(e => e.defaultShift === shiftFilter); 
            if(empFilter) filteredEmps = filteredEmps.filter(e => e.id === empFilter);
            
            filteredEmps.forEach(emp => { 
                let empWorkTotal = 0;
                let empOffTotal = 0;
                let rowHtml = `<tr><td>${emp.name}</td>`; 
                
                dates.forEach(d => { 
                    const dStr = getLocalDateString(d); 
                    let asses = currentData.assignments.filter(a => a.employeeId === emp.id && a.date === dStr); 
                    if(typeFilter === 'work') asses = asses.filter(a => WORKING_HOUR_TYPES.includes(a.type));
                    else if(typeFilter === 'timeoff') asses = asses.filter(a => TIME_OFF_HOUR_TYPES.includes(a.type));
                    let cellContent = ''; 
                    
                    if(asses.length) { 
                        let dayHours = 0;
                        let isOff = false;

                        asses.forEach(a => {
                            const hours = calculateHours(a);
                            let displayH = hours;
                            
                            if (WORKING_HOUR_TYPES.includes(a.type)) {
                                dayHours += hours;
                                empWorkTotal += hours;
                            } else if (TIME_OFF_HOUR_TYPES.includes(a.type)) {
                                isOff = true;
                                if (a.type !== ASSIGNMENT_TYPES.RDO) {
                                    if(displayH === 0) displayH = 8;
                                    empOffTotal += 8; // Assume 8h for leave day
                                }
                            }

                            const color = getAssignmentColor(a.type); 
                            const contrast = getContrastColor(color);
                            
                            let label = a.type;
                            const shiftTypes = [ASSIGNMENT_TYPES.REGULAR, ASSIGNMENT_TYPES.OVERTIME_V, ASSIGNMENT_TYPES.OVERTIME_M, ASSIGNMENT_TYPES.ON_CALL];

                            if (a.scheduleId && shiftTypes.includes(a.type)) {
                                const sched = currentData.schedules.find(s => s.id === a.scheduleId);
                                if (sched) {
                                    const shift = currentData.shifts.find(s => s.id === sched.shiftId);
                                    if (shift) label = shift.name;
                                }
                            }

                            let hourText = `(${displayH}h)`;
                            if (a.type === ASSIGNMENT_TYPES.RDO) hourText = '';

                            cellContent += `<div style="margin-bottom:4px; padding:6px 8px; background:${color}; color:${contrast}; border-radius:6px; font-size:11px; font-weight:600; box-shadow:0 1px 2px rgba(0,0,0,0.1); white-space:nowrap;">${label} ${hourText}</div>`;
                        });
                    } 
                    rowHtml += `<td>${cellContent}</td>`; 
                }); 
                
                rowHtml += `<td><span class="total-cell" style="color:#166534; background:#dcfce7;">${empWorkTotal}</span></td>
                            <td><span class="total-cell" style="color:#991b1b; background:#fee2e2;">${empOffTotal}</span></td>
                            <td><span class="total-cell">${empWorkTotal + empOffTotal}</span></td></tr>`; 
                html += rowHtml;
                weekTotalWork += empWorkTotal;
                weekTotalOff += empOffTotal;
            }); 
            
            html += `<tr style="font-weight:bold; background-color:#f8fafc; border-top:2px solid #cbd5e1;">
                        <td colspan="8" style="text-align:right; padding-right:15px; color:#475467;">Weekly Totals:</td>
                        <td style="color:#166534;">${weekTotalWork}</td>
                        <td style="color:#991b1b;">${weekTotalOff}</td>
                        <td style="color:#1e293b;">${weekTotalWork + weekTotalOff}</td>
                     </tr>`; 
            html += `</tbody>`; 
            table.innerHTML = html; 
        }

        function printWeeklyHours() {
            const period = document.getElementById('whPeriodLabel').textContent;
            const tableHtml = document.getElementById('whGrid').outerHTML;
            
            const printWindow = window.open('', '', 'height=600,width=900');
            printWindow.document.write('<html><head><title>Weekly Hours Report</title>');
            const styles = document.getElementsByTagName('style');
            for (let i = 0; i < styles.length; i++) { printWindow.document.write(styles[i].outerHTML); }
            
            printWindow.document.write(`
                <style>
                    body { background: white; padding: 20px; font-family: sans-serif; }
                    .employee-bubble-table { border-collapse: collapse !important; border-spacing: 0 !important; width: 100%; }
                    .employee-bubble-table tbody td { border: 1px solid #cbd5e1 !important; background: white !important; border-radius: 0 !important; padding: 8px !important; vertical-align: middle; }
                    .employee-bubble-table thead th { background: #334155 !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0 !important; padding: 10px; }
                    .employee-bubble-table tbody td:first-child { font-weight: bold; text-align: left; background-color: #f8fafc !important; }
                    .total-cell { background: transparent !important; border: none !important; font-weight: bold; }
                    @media print { 
                        @page { size: landscape; margin: 0.5in; }
                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    }
                </style>
            `);
            
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<div style="text-align:center; margin-bottom:20px;"><h2 style="margin:0; color:#334155; text-transform:uppercase;">Weekly Hours Report</h2><p style="margin:5px 0; font-size:14px; color:#64748b;">${period}</p></div>`);
            printWindow.document.write(tableHtml);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }
        
        function loadVacation() { 
            const container = document.getElementById('vacation'); 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const lockClear = (role === ROLES.ADMIN || role === ROLES.EMPLOYEE || role === ROLES.GUEST) ? 'btn-locked' : '';
            const empFilterOptions = `<option value="">All Employees</option>` + currentData.employees.filter(e => !e.archived).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            container.innerHTML = `
                <div id="vacationCalendarHeader" class="calendar-header" style="margin-bottom: 20px; display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap: 20px;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <button class="btn btn-secondary" onclick="goHome()">â† Back to Home</button>
                        <div class="filter-group">
                            <label>Employee:</label>
                            <select id="vacationEmployeeFilter" onchange="updateVacationView()">${empFilterOptions}</select>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:center;">
                        <button class="btn btn-primary" onclick="showManageVacationSchedulesModal()">Manage Segments</button>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:flex-end; gap: 15px;">
                        <div class="calendar-nav" style="display:flex; align-items:center; gap:10px;">
                            <button class="btn btn-secondary" onclick="prevCalVac()">â†</button>
                            <button class="btn btn-secondary" onclick="todayCalVac()">Today</button>
                            <button class="btn btn-secondary" onclick="nextCalVac()">â†’</button>
                        </div>
                        <span id="vacationLabel" style="font-size: 18px; font-weight: 700; color: #2c3e50; min-width: 120px; text-align: center;"></span>
                        <button class="btn btn-danger ${lockClear}" onclick="clearVacationForMonth()">Clear Month Log</button>
                    </div>
                </div>
                <div id="vacationContainer" class="table-container"></div>`; 
            updateVacationView(); 
        }
        function prevCalVac() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); updateVacationView(); }
        function nextCalVac() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); updateVacationView(); }
        function todayCalVac() { currentCalendarDate = new Date(); updateVacationView(); }
        
        function clearVacationForMonth() {
            const monthName = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            showConfirmationModal('Clear Month?', `Delete ALL vacation entries for ${monthName}? This cannot be undone.`, () => {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                // Remove from vacation tracking
                currentData.vacationAssignments = currentData.vacationAssignments.filter(v => {
                    const d = getLocalDateFromStr(v.date);
                    return d.getFullYear() !== year || d.getMonth() !== month;
                });

                // Remove from main calendar
                currentData.assignments = currentData.assignments.filter(a => {
                    if (a.type !== ASSIGNMENT_TYPES.VACATION && a.type !== ASSIGNMENT_TYPES.VACATION_SEGMENT) return true;
                    const d = getLocalDateFromStr(a.date);
                    return d.getFullYear() !== year || d.getMonth() !== month;
                });

                logAction('Clear Vacation Log', `Cleared vacation for ${monthName}`);
                updateVacationView();
                alert(`Cleared vacation log for ${monthName}.`);
            });
        }

        function updateVacationView() { 
            document.getElementById('vacationLabel').textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }); 
            const container = document.getElementById('vacationContainer'); 
            const year = currentCalendarDate.getFullYear(); 
            const month = currentCalendarDate.getMonth(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate(); 
            const empFilter = document.getElementById('vacationEmployeeFilter').value;

            let vacationAssignments = currentData.vacationAssignments;
            if (empFilter) {
                vacationAssignments = vacationAssignments.filter(v => v.employeeId === empFilter);
            }

            let html = `<div class="calendar-grid calendar-month-view">`; 
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => html+=`<div class="calendar-header-cell">${d}</div>`); 
            for(let i=0; i<new Date(year, month, 1).getDay(); i++) html+=`<div class="calendar-cell other-month"></div>`; 
            for(let i=1; i<=daysInMonth; i++) { 
                const dateStr = getLocalDateString(new Date(year, month, i)); 
                html += `<div class="calendar-cell"><div class="calendar-day-label">${i}</div>`; 
                vacationAssignments.filter(v => v.date === dateStr).forEach(v => { 
                    const emp = currentData.employees.find(e=>e.id===v.employeeId); 
                    if(emp) html += `<div class="draggable" onclick="handleVacationClick('${v.id}')" style="font-size:10px; background:#d1fae5; border-left:3px solid #10b981; cursor:pointer;" title="${ASSIGNMENT_TYPES.VACATION_SEGMENT}">${emp.name}</div>`; 
                }); 
                html += `</div>`; 
            } 
            html += `</div>`; 
            container.innerHTML = html; 
        }
        function showManageVacationSchedulesModal() { const role = currentUser ? currentUser.role : ROLES.GUEST; const isReadOnly = (role === ROLES.EMPLOYEE || role === ROLES.GUEST); const emps = currentData.employees.filter(e=>!e.archived && !e.isHidden).sort((a,b)=>a.name.localeCompare(b.name)).map(e=>`<option value="${e.id}">${e.name}</option>`).join(''); createModal('Manage Vacation', `${isReadOnly ? '<p>View Only Mode</p>' : `<div class="form-row"><div><label>Employee</label><select id="vacEmp">${emps}</select></div><div><label>Start</label><input type="date" id="vacStart"></div><div><label>End</label><input type="date" id="vacEnd"></div></div><div class="action-buttons"><button class="btn btn-primary" onclick="addVacationSegment()">Add</button></div>`}<hr><div id="vacList"></div>`); renderVacationList(); }
        function renderVacationList() { const role = currentUser ? currentUser.role : ROLES.GUEST; const isReadOnly = (role === ROLES.EMPLOYEE || role === ROLES.GUEST); const container = document.getElementById('vacList'); if(!container) return; let html = '<table><thead><tr><th>Employee</th><th>Start</th><th>End</th><th>Actions</th></tr></thead><tbody>'; currentData.vacationSchedules.forEach(v => { const emp = currentData.employees.find(e=>e.id===v.employeeId); if(emp) html += `<tr><td>${emp.name}</td><td>${v.startDate}</td><td>${v.endDate}</td><td>${isReadOnly ? 'View Only' : `<button class="action-bubble edit" onclick="editVacationSegment('${v.id}')">Edit</button><button class="action-bubble delete" onclick="deleteVacationSegment('${v.id}')">Delete</button>`}</td></tr>`; }); html += '</tbody></table>'; container.innerHTML = html; }
        
        function addVacationSegment() { const empId = document.getElementById('vacEmp').value; const start = document.getElementById('vacStart').value; const end = document.getElementById('vacEnd').value; if(!empId || !start || !end) return alert('Fields required'); const segId = generateId(); currentData.vacationSchedules.push({ id: segId, employeeId: empId, startDate: start, endDate: end }); generateVacationAssignments(segId, empId, start, end); logAction('Add Vacation', `Added vacation segment: ${start} to ${end}`, currentData.employees.find(e=>e.id===empId)); renderVacationList(); updateVacationView(); }
        
        // FIXED: Use getLocalDateFromStr for proper iteration without timezone shifts
        function generateVacationAssignments(segId, empId, start, end, preservedSchedules = {}) {
            const d = getLocalDateFromStr(start);
            const e = getLocalDateFromStr(end); 
            
            // Loop using date objects but constructed locally
            for(let dt=d; dt<=e; dt.setDate(dt.getDate()+1)) { 
                const iso = getLocalDateString(dt); 
                
                // Try to find existing schedule to preserve layout
                let schedId = preservedSchedules[iso] || null;
                if (!schedId) {
                    const existing = currentData.assignments.find(a => a.employeeId === empId && a.date === iso && !ADDITIVE_TYPES.includes(a.type));
                    if (existing) schedId = existing.scheduleId;
                }

                if (schedId) {
                    const sched = currentData.schedules.find(s => s.id === schedId);
                    const dayOfWeek = dt.getDay();
                    if (sched && sched.workDays && sched.workDays.includes(dayOfWeek)) {
                        applyAssignment(empId, schedId, iso, null, ASSIGNMENT_TYPES.VACATION_SEGMENT); 
                    }
                }
                currentData.vacationAssignments.push({ id: generateId(), segmentId: segId, employeeId: empId, date: iso }); 
            }
        }

        function handleVacationClick(assignmentId) {
            const assignment = currentData.vacationAssignments.find(v => v.id === assignmentId);
            if (!assignment) return;
            editVacationSegment(assignment.segmentId, true);
        }

        function editVacationSegment(id, isFromCalendar = false) {
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) return; // Read only
            const seg = currentData.vacationSchedules.find(v => v.id === id);
            if (!seg) return;
            const emps = currentData.employees.filter(e => !e.archived && !e.isHidden).sort((a,b)=>a.name.localeCompare(b.name)).map(e => `<option value="${e.id}" ${e.id === seg.employeeId ? 'selected' : ''}>${e.name}</option>`).join('');
            
            const cancelAction = isFromCalendar ? 'closeModal()' : 'showManageVacationSchedulesModal()';
            const deleteAction = `processVacationDelete('${id}', ${isFromCalendar})`;

            createModal('Edit Vacation Segment', `
                <div class="form-row">
                    <div><label>Employee</label><select id="editVacEmp" disabled>${emps}</select></div>
                    <div><label>Start</label><input type="date" id="editVacStart" value="${seg.startDate}"></div>
                    <div><label>End</label><input type="date" id="editVacEnd" value="${seg.endDate}"></div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="${deleteAction}">Delete Range</button>
                    <button class="btn btn-primary" onclick="saveVacationEdit('${id}', ${isFromCalendar})">Save Changes</button>
                    <button class="btn btn-secondary" onclick="${cancelAction}">Cancel</button>
                </div>
            `);
        }

        function processVacationDelete(id, isFromCalendar) {
            const startVal = document.getElementById('editVacStart').value;
            const endVal = document.getElementById('editVacEnd').value;
            if (!startVal || !endVal) return alert("Dates required");

            const sDate = getLocalDateFromStr(startVal);
            const eDate = getLocalDateFromStr(endVal);

            const toRemove = [];
            const remaining = [];
            
            currentData.vacationAssignments.forEach(v => {
                if (v.segmentId === id) {
                    const vDate = getLocalDateFromStr(v.date);
                    if (vDate >= sDate && vDate <= eDate) toRemove.push(v);
                    else remaining.push(v);
                }
            });

            if (toRemove.length === 0) return alert("No assignments found in selected range.");

            currentData.vacationAssignments = currentData.vacationAssignments.filter(v => !toRemove.includes(v));
            currentData.assignments = currentData.assignments.filter(a => {
                const match = toRemove.find(tr => tr.employeeId === a.employeeId && tr.date === a.date);
                return !match || (a.type !== ASSIGNMENT_TYPES.VACATION && a.type !== ASSIGNMENT_TYPES.VACATION_SEGMENT);
            });

            if (remaining.length === 0) {
                currentData.vacationSchedules = currentData.vacationSchedules.filter(s => s.id !== id);
            } else {
                remaining.sort((a, b) => getLocalDateFromStr(a.date) - getLocalDateFromStr(b.date));
                const blocks = [];
                let currentBlock = [remaining[0]];
                
                for (let i = 1; i < remaining.length; i++) {
                    const prev = getLocalDateFromStr(remaining[i-1].date);
                    const curr = getLocalDateFromStr(remaining[i].date);
                    prev.setDate(prev.getDate() + 1);
                    if (prev.getTime() === curr.getTime()) currentBlock.push(remaining[i]);
                    else { blocks.push(currentBlock); currentBlock = [remaining[i]]; }
                }
                blocks.push(currentBlock);

                const seg = currentData.vacationSchedules.find(s => s.id === id);
                if (seg) {
                    seg.startDate = blocks[0][0].date;
                    seg.endDate = blocks[0][blocks[0].length - 1].date;
                }

                for (let i = 1; i < blocks.length; i++) {
                    const block = blocks[i];
                    const newSegId = generateId();
                    currentData.vacationSchedules.push({
                        id: newSegId,
                        employeeId: seg.employeeId,
                        startDate: block[0].date,
                        endDate: block[block.length - 1].date
                    });
                    block.forEach(b => b.segmentId = newSegId);
                }
            }

            if (isFromCalendar) closeModal();
            else showManageVacationSchedulesModal();
            updateVacationView();
        }

        function saveVacationEdit(id, isFromCalendar) {
            const start = document.getElementById('editVacStart').value;
            const end = document.getElementById('editVacEnd').value;
            const seg = currentData.vacationSchedules.find(v => v.id === id);
            
            if (!start || !end) return alert("Dates required");

            // 1. Remove old assignments associated with this segment
            const oldAssignments = currentData.vacationAssignments.filter(v => v.segmentId === id);
            const preservedSchedules = {};

            oldAssignments.forEach(old => {
                // Capture scheduleId before deleting to preserve row placement
                const mainAss = currentData.assignments.find(a => a.employeeId === old.employeeId && a.date === old.date && (a.type === ASSIGNMENT_TYPES.VACATION || a.type === ASSIGNMENT_TYPES.VACATION_SEGMENT));
                if (mainAss && mainAss.scheduleId) preservedSchedules[old.date] = mainAss.scheduleId;

                // Remove from main calendar
                currentData.assignments = currentData.assignments.filter(a => 
                    !(a.employeeId === old.employeeId && a.date === old.date && (a.type === ASSIGNMENT_TYPES.VACATION || a.type === ASSIGNMENT_TYPES.VACATION_SEGMENT))
                );
            });
            // Remove from vacation tracking
            currentData.vacationAssignments = currentData.vacationAssignments.filter(v => v.segmentId !== id);

            // 2. Update Segment
            seg.startDate = start;
            seg.endDate = end;

            // 3. Regenerate Assignments
            generateVacationAssignments(id, seg.employeeId, start, end, preservedSchedules);
            logAction('Edit Vacation', `Updated vacation segment: ${start} to ${end}`, currentData.employees.find(e=>e.id===seg.employeeId));

            if (isFromCalendar) {
                closeModal();
            } else {
                showManageVacationSchedulesModal();
            }
            updateVacationView();
        }

        function deleteVacationSegment(id) { 
            const seg = currentData.vacationSchedules.find(v => v.id === id);
            if(seg) logAction('Delete Vacation', `Deleted vacation segment`, currentData.employees.find(e=>e.id===seg.employeeId));
            currentData.vacationSchedules = currentData.vacationSchedules.filter(v => v.id !== id); 
            currentData.vacationAssignments = currentData.vacationAssignments.filter(v => v.segmentId !== id); 
            renderVacationList(); 
            updateVacationView(); 
        }
        
        // --- ADMIN ---
        function showAdminPanel() { 
            var html = '<p style="margin-bottom:25px; color:#64748b; font-size:15px;">Select an administrative task to manage system settings.</p>';
            html += '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom:20px;">';
            html += '<div class="admin-tile" onclick="loadAdminSection(\'employee\')">';
            html += '<div class="admin-tile-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">ðŸ‘¥</div>';
            html += '<h3 class="admin-tile-title">Manage Employees</h3>';
            html += '</div>';
            html += '<div class="admin-tile" onclick="loadAdminSection(\'shift\')">';
            html += '<div class="admin-tile-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">ðŸ•</div>';
            html += '<h3 class="admin-tile-title">Manage Shifts</h3>';
            html += '</div>';
            html += '<div class="admin-tile" onclick="loadAdminSection(\'schedule\')">';
            html += '<div class="admin-tile-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">ðŸ“…</div>';
            html += '<h3 class="admin-tile-title">Manage Schedules</h3>';
            html += '</div>';
            html += '</div>';
            html += '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">';
            html += '<div class="admin-tile" onclick="showLocationManager()">';
            html += '<div class="admin-tile-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ðŸ“</div>';
            html += '<h3 class="admin-tile-title">Manage Locations</h3>';
            html += '</div>';
            html += '<div class="admin-tile" onclick="editTitle()">';
            html += '<div class="admin-tile-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">âœï¸</div>';
            html += '<h3 class="admin-tile-title">Edit Title</h3>';
            html += '</div>';
            html += '<div class="admin-tile" onclick="showSystemLogs()">';
            html += '<div class="admin-tile-icon" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">ðŸ“œ</div>';
            html += '<h3 class="admin-tile-title">System Logs</h3>';
            html += '</div>';
            html += '</div>';
            createModal('Admin Panel', html, '900px');
        }
        
        function loadAdminSection(section, defaultTab = null) { if (!currentData) return alert('Please select a location first.'); closeModal(); if (section === 'employee') { const activeTab = defaultTab || 'activeEmployees'; const modalContent = `<div class="admin-modal-tabs" style="justify-content: space-between; align-items: center;"><div><button class="tab ${activeTab === 'activeEmployees' ? 'active' : ''}" onclick="showModalTab('activeEmployees', this)">Active Employees</button><button class="tab ${activeTab === 'archivedEmployees' ? 'active' : ''}" onclick="showModalTab('archivedEmployees', this)">Archived Employees</button></div><div style="display:flex; gap:10px;"><button class="btn btn-secondary btn-sm" onclick="showBulkAddEmployeeModal()">Bulk Add</button><button class="btn btn-secondary btn-sm" onclick="showManageEmployeeTypesModal()">Manage Types</button></div></div><div id="activeEmployees" class="tab-content ${activeTab === 'activeEmployees' ? '' : 'hidden'}" style="min-height:auto; padding-top: 20px;"><div id="addEmployeeAdmin"></div><hr style="margin: 20px 0; border-color: var(--border-color);"><div id="rosterAdmin"></div></div><div id="archivedEmployees" class="tab-content ${activeTab === 'archivedEmployees' ? '' : 'hidden'}" style="min-height:auto; padding-top: 20px;"><div id="archivedRosterAdmin"></div></div>`; createModal('Manage Employees', modalContent); loadAddEmployeeForm('addEmployeeAdmin'); loadRosterAdmin('rosterAdmin'); loadArchivedRosterAdmin('archivedRosterAdmin'); } else if (section === 'shift') { createModal('Manage Shifts', `<div id="shiftSettingsAdmin"></div>`); loadShiftSettings('shiftSettingsAdmin', defaultTab); } else if (section === 'schedule') { showManageSchedulesModal(defaultTab); } }
        
        // Helper function for Admin Tabs
        function showModalTab(tabId, btn) {
            // Scope lookup to the current modal
            const modalContent = btn.closest('.modal-content');
            if (!modalContent) return;

            // Hide all tab content divs in this modal
            modalContent.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            // Deactivate all tab buttons in this modal
            modalContent.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            // Show target
            const target = document.getElementById(tabId);
            if(target) target.classList.remove('hidden');
            
            // Activate button
            btn.classList.add('active');
        }

        function showBulkAddEmployeeModal() { createModal('Bulk Add Employees', `<div id="bulkStep1"><div class="form-group"><label>Paste Names (One per line)</label><textarea id="bulkNames" rows="10" placeholder="John Doe\nJane Smith"></textarea></div><div class="action-buttons"><button class="btn btn-primary" onclick="renderBulkConfigTable()">Next: Configure Details</button></div></div><div id="bulkStep2" class="hidden"></div>`); }
        function renderBulkConfigTable() { const text = document.getElementById('bulkNames').value; const names = text.split('\n').map(n => n.trim()).filter(n => n); if (names.length === 0) return alert('Please enter at least one name.'); const shiftOptions = `<option value="">N/A</option>` + currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s => `<option value="${s.id}">${s.name}</option>`).join(''); const typeOptions = currentData.employeeTypes.map(t => `<option value="${t.id}">${t.name}</option>`).join(''); const today = getTodayDateString(); let html = `<div class="table-container" style="max-height: 60vh; overflow-y: auto;"><table><thead><tr><th>Name</th><th>Seniority</th><th>Type</th><th>Default Shift</th></tr></thead><tbody>`; names.forEach((name, idx) => { html += `<tr><td><input type="text" class="bulk-name" value="${name}"></td><td><input type="date" class="bulk-date" value="${today}"></td><td><select class="bulk-type">${typeOptions}</select></td><td><select class="bulk-shift">${shiftOptions}</select></td></tr>`; }); html += `</tbody></table></div><div class="action-buttons" style="margin-top: 20px;"><button class="btn btn-secondary" onclick="showBulkAddEmployeeModal()">Back</button><button class="btn btn-primary" onclick="saveBulkAddedEmployees()">Save All Employees</button></div>`; const step1 = document.getElementById('bulkStep1'); const step2 = document.getElementById('bulkStep2'); step1.classList.add('hidden'); step2.innerHTML = html; step2.classList.remove('hidden'); }
        function saveBulkAddedEmployees() { 
            const rows = document.querySelectorAll('#bulkStep2 tbody tr'); 
            let count = 0; 
            let credsLog = "Generated Credentials:\n";
            rows.forEach(row => { 
                const name = row.querySelector('.bulk-name').value; 
                const date = row.querySelector('.bulk-date').value; 
                const type = row.querySelector('.bulk-type').value; 
                const shift = row.querySelector('.bulk-shift').value; 
                if (name) { 
                    const creds = generateCredentials(name);
                    currentData.employees.push({ id: generateId(), name: name, seniorityDate: date, type: type, defaultShift: shift, archived: false, username: creds.username, password: creds.password, systemRole: ROLES.EMPLOYEE, isHidden: false }); 
                    credsLog += `${name}: ${creds.username} / ${creds.password}\n`;
                    count++; 
                } 
            }); 
            logAction('Bulk Add Employees', `Added ${count} employees via bulk tool`);
            console.log(credsLog);
            alert(`Successfully added ${count} employees.\n\nCredentials have been logged to the browser console (F12) for security.`); 
            saveToFirebase();
            loadAdminSection('employee'); 
        }

        function loadAddEmployeeForm(containerId) { const container = document.getElementById(containerId); if(!container) return; const shiftOptions = `<option value="">N/A</option>` + currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s => `<option value="${s.id}">${s.name}</option>`).join(''); const typeOptions = currentData.employeeTypes.map(t => `<option value="${t.id}">${t.name}</option>`).join(''); const roleOptions = Object.values(ROLES).map(r => `<option value="${r}">${r}</option>`).join(''); 
            const locOptions = globalData.locations.filter(l => !l.archived).map(l => `<option value="${l.id}" ${l.id === globalData.currentLocation ? 'selected' : ''}>${l.name}</option>`).join('');
            container.innerHTML = `<h3>Add New Employee</h3><div class="form-row"><div><label>Name</label><input type="text" id="adminEmployeeName"></div><div><label>Seniority</label><input type="date" id="adminSeniorityDate" value="${getTodayDateString()}"></div></div><div class="form-row"><div><label>Type</label><select id="adminEmployeeType">${typeOptions}</select></div><div><label>Default Shift</label><select id="adminDefaultShift">${shiftOptions}</select></div></div><div class="form-row"><div><label>System Role</label><select id="adminEmployeeRole">${roleOptions}</select></div><div><label>Default Location</label><select id="adminDefaultLocation">${locOptions}</select></div></div><div class="form-group"><label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="adminIsHidden" style="width:auto;"> Hide from Roster (User can still login)</label></div><div class="action-buttons"><button class="btn btn-primary" onclick="addEmployee()">Add Employee</button></div>`; }
        function addEmployee() { 
            const name = document.getElementById('adminEmployeeName').value; 
            if(!name) return alert('Name required'); 
            const creds = generateCredentials(name);
            currentData.employees.push({ id: generateId(), name, seniorityDate: document.getElementById('adminSeniorityDate').value, type: document.getElementById('adminEmployeeType').value, defaultShift: document.getElementById('adminDefaultShift').value, archived: false, username: creds.username, password: creds.password, systemRole: document.getElementById('adminEmployeeRole').value, defaultLocation: document.getElementById('adminDefaultLocation').value, isHidden: document.getElementById('adminIsHidden').checked }); 
            const newEmp = currentData.employees[currentData.employees.length-1];
            logAction('Add Employee', `Added new employee`, newEmp);
            alert(`Employee Added.\n\nAuto-Generated Credentials:\nUsername: ${creds.username}\nPassword: ${creds.password}\n\nPlease record these now.`);
            saveToFirebase();
            loadAdminSection('employee', 'activeEmployees'); 
        }
        function loadRosterAdmin(containerId) { 
            const container = document.getElementById(containerId); if(!container) return; 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            let html = `<div class="table-container"><table><thead><tr><th>Name</th><th>Seniority</th><th>Shift</th><th>Actions</th></tr></thead><tbody>`; 
            currentData.employees.filter(e => !e.archived).sort((a,b) => new Date(a.seniorityDate) - new Date(b.seniorityDate)).forEach(e => { 
                const s = currentData.shifts.find(x => x.id === e.defaultShift); 
                const isTargetOwner = e.systemRole === ROLES.OWNER;
                const canModifyTarget = (role === ROLES.OWNER) || (role === ROLES.ADMIN && !isTargetOwner);
                html += `<tr><td>${e.name}</td><td>${formatDate(e.seniorityDate)}</td><td>${s ? s.name : 'N/A'}</td><td>
                    ${canModifyTarget ? `<button class="action-bubble edit" onclick="editEmployee('${e.id}', true)">Edit</button>` : ''}
                    ${canModifyTarget ? `<button class="action-bubble archive" onclick="archiveEmployee('${e.id}')">Archive</button>` : ''}
                </td></tr>`; 
            }); 
            container.innerHTML = html + '</tbody></table></div>'; 
        }
        function loadArchivedRosterAdmin(containerId) { const container = document.getElementById(containerId); if(!container) return; let html = `<div class="table-container"><table><thead><tr><th>Name</th><th>Archived</th><th>Actions</th></tr></thead><tbody>`; currentData.employees.filter(e => e.archived).forEach(e => { html += `<tr><td>${e.name}</td><td>${formatDate(e.archivedAt)}</td><td><button class="action-bubble restore" onclick="restoreEmployee('${e.id}')">Restore</button><button class="action-bubble delete" onclick="deleteEmployeePermanently('${e.id}', true)">Delete Permanently</button></td></tr>`; }); container.innerHTML = html + '</tbody></table></div>'; }
        function showManageEmployeeTypesModal() { isEmployeeTypeEditingUnlocked = false; let html = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><div class="action-buttons" style="margin:0;"><button class="btn btn-success" onclick="showAddEmployeeTypeInput()">+ Add Type</button></div><div><button class="icon-btn" id="unlockDefaultsBtn" onclick="toggleEmployeeTypeLock()" title="Unlock Default Types">ðŸ”’</button></div></div><div id="addTypeContainer"></div><div class="table-container"><table><thead><tr><th>Type Name</th><th>Actions</th></tr></thead><tbody>`; currentData.employeeTypes.forEach(t => { const isDefault = t.isDefault; const isLocked = isDefault && !isEmployeeTypeEditingUnlocked; html += `<tr><td><input type="text" id="type-name-${t.id}" value="${t.name}" ${isLocked ? 'disabled style="background:#f5f5f5; cursor:not-allowed; color:#888;"' : ''}></td><td>${isLocked ? '<span style="color:#888; font-size:12px; padding:5px;">Default (Locked)</span>' : `<button class="action-bubble edit" onclick="saveEmployeeTypeEdit('${t.id}')">Save</button><button class="action-bubble delete" onclick="deleteEmployeeType('${t.id}')">Delete</button>`}</td></tr>`; }); createModal('Manage Employee Types', html + '</tbody></table></div>'); }
        function toggleEmployeeTypeLock() { isEmployeeTypeEditingUnlocked = !isEmployeeTypeEditingUnlocked; showManageEmployeeTypesModal(); }
        function showAddEmployeeTypeInput() { document.getElementById('addTypeContainer').innerHTML = `<div class="form-group" style="margin-top:15px;"><label>Name</label><div style="display:flex; gap:10px;"><input type="text" id="newEmployeeTypeName"><button class="btn btn-primary" onclick="addEmployeeType()">Save</button></div></div>`; }
        function addEmployeeType() { const n = document.getElementById('newEmployeeTypeName').value; if(n) { currentData.employeeTypes.push({id:generateId(), name:n}); showManageEmployeeTypesModal(); } }
        function saveEmployeeTypeEdit(id) { const t = currentData.employeeTypes.find(x=>x.id===id); const v = document.getElementById(`type-name-${id}`).value; if(t && v) { t.name=v; alert('Updated'); } }
        function deleteEmployeeType(id) { showConfirmationModal('Delete?', 'Delete type?', () => { currentData.employeeTypes = currentData.employeeTypes.filter(t=>t.id!==id); showManageEmployeeTypesModal(); }); }
        function loadShiftSettings(containerId, defaultTab) { const container = document.getElementById(containerId); if(!container) return; const activeTab = defaultTab || 'activeShiftsTab'; container.innerHTML = `<div class="admin-modal-tabs"><button class="tab ${activeTab === 'activeShiftsTab' ? 'active' : ''}" onclick="showModalTab('activeShiftsTab', this)">Active Shifts</button><button class="tab ${activeTab === 'archivedShiftsTab' ? 'active' : ''}" onclick="showModalTab('archivedShiftsTab', this)">Archived Shifts</button></div><div id="activeShiftsTab" class="tab-content ${activeTab === 'activeShiftsTab' ? '' : 'hidden'}" style="min-height:auto; padding-top: 20px;"><div class="action-buttons"><button class="btn btn-primary" onclick="showAddShiftModal()">+ Add New Shift</button></div><div id="shiftsContainer" style="margin-top:20px;"></div></div><div id="archivedShiftsTab" class="tab-content ${activeTab === 'archivedShiftsTab' ? '' : 'hidden'}" style="min-height:auto; padding-top: 20px;"><div id="archivedShiftsContainer"></div></div>`; displayShiftsForAdmin(); displayArchivedShiftsForAdmin(); }
        function displayShiftsForAdmin() { const shiftContainer = document.getElementById('shiftsContainer'); if(!shiftContainer) return; shiftContainer.innerHTML = ''; currentData.shifts.filter(s => !s.archived).sort((a,b) => a.order - b.order).forEach(s => { const div = document.createElement('div'); div.className = 'shift-item'; div.setAttribute('draggable', 'true'); div.dataset.shiftId = s.id; div.style.borderColor = s.color; div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><div><h3 style="color:${s.color}">${s.name}</h3><p>${s.startTime} - ${s.endTime} (Min: ${s.minEmployees||0})</p></div><div><button class="action-bubble edit" onclick="showEditShiftModal('${s.id}')">Edit</button><button class="action-bubble archive" onclick="archiveShift('${s.id}')">Archive</button></div></div>`; shiftContainer.appendChild(div); }); addShiftDragAndDropListeners(shiftContainer); }
        function displayArchivedShiftsForAdmin() { const container = document.getElementById('archivedShiftsContainer'); if(!container) return; container.innerHTML = ''; const archived = currentData.shifts.filter(s => s.archived); if (archived.length === 0) { container.innerHTML = '<p>No archived shifts.</p>'; return; } archived.forEach(s => { container.innerHTML += `<div class="shift-item" style="border-color:#95a5a6; opacity:0.8;"><div style="display:flex; justify-content:space-between; align-items:center;"><div><h3 style="color:#7f8c8d">${s.name}</h3><p>Archived: ${formatDate(s.archivedAt)}</p></div><div><button class="action-bubble restore" onclick="restoreShift('${s.id}')">Restore</button><button class="action-bubble delete" onclick="deleteShiftPermanently('${s.id}')">Delete Permanently</button></div></div></div>`; }); }
        function addShiftDragAndDropListeners(container) { 
            container.querySelectorAll('.shift-item').forEach(item => { 
                item.addEventListener('dragstart', () => { item.classList.add('dragging'); }); 
                item.addEventListener('dragend', () => { 
                    item.classList.remove('dragging'); 
                    const newOrder = Array.from(container.children).map(c => c.dataset.shiftId); 
                    newOrder.forEach((id, idx) => { const s = currentData.shifts.find(x => x.id === id); if(s) s.order = idx + 1; }); 
                    refreshCurrentTab('calendar'); 
                }); 
            }); 
            container.addEventListener('dragover', e => { 
                e.preventDefault(); 
                const afterElement = getDragAfterElement(container, e.clientY, '.shift-item'); 
                const draggable = container.querySelector('.dragging'); 
                if(draggable) { if(afterElement == null) container.appendChild(draggable); else container.insertBefore(draggable, afterElement); } 
            }); 
        }
        function getDragAfterElement(container, y, selector) { const draggableElements = [...container.querySelectorAll(selector + ':not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
        
        function showAddShiftModal() { 
            const colorOptions = SHIFT_COLORS.map(c => `<option value="${c.value}">${c.name}</option>`).join('');
            createModal('Add New Shift', `
                <div class="form-row">
                    <div><label>Name</label><input id="newShiftName"></div>
                    <div><label>Color</label><select id="newShiftColor">${colorOptions}</select></div>
                </div>
                <div class="form-row">
                    <div><label>Start</label><input type="time" id="newShiftStart"></div>
                    <div><label>End</label><input type="time" id="newShiftEnd"></div>
                </div>
                <div class="form-group"><label>Min Staff</label><input type="number" id="newShiftMin" value="1"></div>
                <button class="btn btn-primary" onclick="addNewShift()">Save Shift</button>
            `); 
        }
        
        function addNewShift() { 
            const name = document.getElementById('newShiftName').value; 
            const start = document.getElementById('newShiftStart').value;
            const end = document.getElementById('newShiftEnd').value;
            if (!start || !end) return alert("Start and End times are required.");
            if(name) { 
                currentData.shifts.push({ 
                    id: generateId(), 
                    name, 
                    color: document.getElementById('newShiftColor').value, 
                    startTime: start, 
                    endTime: end, 
                    minEmployees: parseInt(document.getElementById('newShiftMin').value) || 0, 
                    order: currentData.shifts.length + 1, 
                    archived: false 
                }); 
                const newShift = currentData.shifts[currentData.shifts.length-1];
                logAction('Add Shift', `Added shift`, newShift);
                loadAdminSection('shift', 'activeShiftsTab'); 
            } 
        }
        
        function showEditShiftModal(id) { 
            const s = currentData.shifts.find(x => x.id === id); 
            if(!s) return; 
            const colorOptions = SHIFT_COLORS.map(c => `<option value="${c.value}" ${c.value === s.color ? 'selected' : ''}>${c.name}</option>`).join('');
            
            createModal('Edit Shift', `
                <div class="form-row">
                    <div><label>Name</label><input id="editShiftName" value="${s.name}"></div>
                    <div><label>Color</label><select id="editShiftColor">${colorOptions}</select></div>
                </div>
                <div class="form-row">
                    <div><label>Start</label><input type="time" id="editShiftStart" value="${s.startTime}"></div>
                    <div><label>End</label><input type="time" id="editShiftEnd" value="${s.endTime}"></div>
                </div>
                <div class="form-group"><label>Min Staff</label><input type="number" id="editShiftMin" value="${s.minEmployees}"></div>
                <button class="btn btn-primary" onclick="saveShiftEdit('${id}')">Save Changes</button>
            `); 
        }
        
        function saveShiftEdit(id) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) return alert("Access Denied.");
            const s = currentData.shifts.find(x => x.id === id); 
            const start = document.getElementById('editShiftStart').value;
            const end = document.getElementById('editShiftEnd').value;
            if (!start || !end) return alert("Start and End times are required.");
            if(s) { s.name = document.getElementById('editShiftName').value; s.color = document.getElementById('editShiftColor').value; s.startTime = start; s.endTime = end; s.minEmployees = parseInt(document.getElementById('editShiftMin').value) || 0; logAction('Edit Shift', `Updated shift`, s); loadAdminSection('shift', 'activeShiftsTab'); refreshCurrentTab('calendar'); } }
        function archiveShift(id) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) return alert("Access Denied.");
            showArchiveModal('Archive Shift', 'Enter effective archive date (removes assignments on and after this date):', (date) => { const s = currentData.shifts.find(x => x.id === id); s.archived = true; s.archivedAt = date; logAction('Archive Shift', `Archived shift`, s); currentData.assignments = currentData.assignments.filter(a => { const sched = currentData.schedules.find(sc => sc.id === a.scheduleId); if(sched && sched.shiftId === id && a.date >= date) return false; return true; }); loadAdminSection('shift', 'activeShiftsTab'); refreshCurrentTab('calendar'); }); }
        function restoreShift(id) { const s = currentData.shifts.find(x => x.id === id); if(s) { s.archived = false; logAction('Restore Shift', `Restored shift`, s); loadAdminSection('shift', 'archivedShiftsTab'); refreshCurrentTab('calendar'); } }
        function deleteShiftPermanently(id) {
            if (currentUser && currentUser.role === ROLES.ADMIN) return alert("Admin Restricted: Cannot permanently delete items.");
            showConfirmationModal('Delete Permanently?', 'This will permanently delete this shift and ALL associated schedules and assignments. This cannot be undone.', () => {
                currentData.shifts = currentData.shifts.filter(s => s.id !== id);
                const schedIds = currentData.schedules.filter(s => s.shiftId === id).map(s => s.id);
                currentData.schedules = currentData.schedules.filter(s => s.shiftId !== id);
                currentData.assignments = currentData.assignments.filter(a => !schedIds.includes(a.scheduleId));
                currentData.overtimeSignups = currentData.overtimeSignups.filter(s => s.shiftId !== id);
                currentData.employees.forEach(e => { if(e.defaultShift === id) e.defaultShift = ''; });
                logAction('Delete Shift', `Permanently deleted shift ID ${id}`);
                loadAdminSection('shift', 'archivedShiftsTab');
                refreshCurrentTab('calendar');
            });
        }
        function showManageSchedulesModal(defaultTab = 'activeSched') { 
            const activeSchedules = currentData.schedules.filter(s => !s.archived); 
            const archivedSchedules = currentData.schedules.filter(s => s.archived); 
            const activeTab = defaultTab || 'activeSched'; 
            
            let activeContent = `<div class="action-buttons" style="justify-content: flex-end; gap: 10px;">
                <button class="btn btn-primary" onclick="saveManagedSchedules()">Save All Changes</button>
                <button class="btn btn-success" onclick="showShiftSelectionForNewSchedule()">+ Add New Schedule</button>
            </div>
            <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="text-align:left;">Schedule Name</th>
                        <th style="text-align:left;">Shift</th>
                        <th style="text-align:center; width:30px;">S</th>
                        <th style="text-align:center; width:30px;">M</th>
                        <th style="text-align:center; width:30px;">T</th>
                        <th style="text-align:center; width:30px;">W</th>
                        <th style="text-align:center; width:30px;">T</th>
                        <th style="text-align:center; width:30px;">F</th>
                        <th style="text-align:center; width:30px;">S</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`; 
                
            currentData.shifts.filter(s => !s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).forEach(shift => { 
                activeSchedules.filter(s => s.shiftId === shift.id).sort((a,b)=>(a.order||99)-(b.order||99)).forEach(schedule => { 
                    activeContent += `<tr draggable="true" class="schedule-row" data-schedule-id="${schedule.id}" style="cursor:move;">
                        <td><input type="text" class="schedule-name-input" data-schedule-id="${schedule.id}" value="${schedule.name}" style="width:150px;"></td>
                        <td style="color:${shift.color}; font-weight: bold;">${shift.name}</td>`; 
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) { 
                        activeContent += `<td style="text-align:center;"><input type="checkbox" class="work-day-checkbox" data-schedule-id="${schedule.id}" data-day="${dayIndex}" ${(schedule.workDays || []).includes(dayIndex) ? 'checked' : ''}></td>`; 
                    } 
                    activeContent += `<td><button class="action-bubble archive" onclick="archiveSchedule('${schedule.id}')">Archive</button></td></tr>`; 
                }); 
            }); 
            activeContent += '</tbody></table></div>'; 
            
            let archivedContent = `<div class="table-container"><table><thead><tr><th>Schedule Name</th><th>Shift</th><th>Archived</th><th>Actions</th></tr></thead><tbody>`; 
            if (archivedSchedules.length === 0) { archivedContent += '<tr><td colspan="4" style="text-align:center">No archived schedules</td></tr>'; } 
            else { 
                archivedSchedules.forEach(s => { 
                    const shift = currentData.shifts.find(sh => sh.id === s.shiftId); 
                    archivedContent += `<tr><td>${s.name}</td><td>${shift ? shift.name : 'Unknown'}</td><td>${formatDate(s.archivedAt)}</td><td>
                        <button class="action-bubble restore" onclick="restoreSchedule('${s.id}')">Restore</button>
                        <button class="action-bubble delete" onclick="deleteSchedulePermanently('${s.id}')">Delete Permanently</button>
                    </td></tr>`; 
                }); 
            } 
            archivedContent += '</tbody></table></div>'; 
            
            const modalHTML = `<div class="admin-modal-tabs">
                <button class="tab ${activeTab === 'activeSched' ? 'active' : ''}" onclick="showModalTab('activeSched', this)">Active</button>
                <button class="tab ${activeTab === 'archivedSched' ? 'active' : ''}" onclick="showModalTab('archivedSched', this)">Archived</button>
            </div>
            <div id="activeSched" class="tab-content ${activeTab === 'activeSched' ? '' : 'hidden'}" style="min-height:auto; padding-top: 20px;">${activeContent}</div>
            <div id="archivedSched" class="tab-content ${activeTab === 'archivedSched' ? '' : 'hidden'}" style="min-height:auto; padding-top: 20px;">${archivedContent}</div>`; 
            
            createModal('Manage Schedules', modalHTML, '90vw'); 
            addScheduleDragAndDropListeners();
        }
        function addScheduleDragAndDropListeners() {
            const container = document.querySelector('#activeSched tbody');
            if(!container) return;
            container.querySelectorAll('.schedule-row').forEach(row => {
                row.addEventListener('dragstart', () => { row.classList.add('dragging'); setTimeout(()=>row.style.opacity='0.5',0); });
                row.addEventListener('dragend', () => { 
                    row.classList.remove('dragging'); row.style.opacity='1';
                    // Update Order based on DOM position
                    Array.from(container.querySelectorAll('.schedule-row')).forEach((r, idx) => {
                        const s = currentData.schedules.find(x => x.id === r.dataset.scheduleId);
                        if(s) s.order = idx + 1;
                    });
                    refreshCurrentTab('calendar');
                });
            });
            container.addEventListener('dragover', e => { e.preventDefault(); const afterElement = getDragAfterElement(container, e.clientY, '.schedule-row'); const draggable = container.querySelector('.dragging'); if(draggable) { if(afterElement == null) container.appendChild(draggable); else container.insertBefore(draggable, afterElement); } });
        }
        function showShiftSelectionForNewSchedule() { const html = currentData.shifts.filter(s=>!s.archived).sort((a,b)=>(a.order||99)-(b.order||99)).map(s => `<button class="btn btn-secondary" style="margin:5px; border-color:${s.color}" onclick="createNewScheduleForShift('${s.id}')">${s.name}</button>`).join(''); createModal('Select Shift', html); }
        function createNewScheduleForShift(shiftId) { const shift = currentData.shifts.find(s => s.id === shiftId); const count = currentData.schedules.filter(s => s.shiftId === shiftId).length + 1; currentData.schedules.push({ id: generateId(), name: `${shift.name} Sched ${count}`, shiftId, workDays: [1,2,3,4,5], archived: false, order: currentData.schedules.length + 1 }); logAction('Create Schedule', `Created new schedule`, currentData.schedules[currentData.schedules.length-1]); showManageSchedulesModal('activeSched'); }
        function saveManagedSchedules() { document.querySelectorAll('.schedule-name-input').forEach(input => { const s = currentData.schedules.find(x => x.id === input.dataset.scheduleId); if(s) s.name = input.value; }); document.querySelectorAll('.work-day-checkbox').forEach(cb => { const s = currentData.schedules.find(x => x.id === cb.dataset.scheduleId); if(s) { if(!s.workDays) s.workDays = []; const d = parseInt(cb.dataset.day); if(cb.checked && !s.workDays.includes(d)) s.workDays.push(d); if(!cb.checked && s.workDays.includes(d)) s.workDays = s.workDays.filter(x => x !== d); } }); logAction('Update Schedules', 'Saved changes to schedules'); alert('Saved'); closeModal(); refreshCurrentTab('calendar'); }
        function archiveSchedule(id) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) return alert("Access Denied.");
            showArchiveModal('Archive Schedule', 'Enter effective archive date (removes assignments on and after this date):', (date) => { 
            const s = currentData.schedules.find(x => x.id === id); 
            s.archived = true; 
            s.archivedAt = date; 
            currentData.assignments = currentData.assignments.filter(a => {
                if (a.scheduleId === id && a.date >= date) return false;
                return true;
            });
            logAction('Archive Schedule', `Archived schedule`, s);
            showManageSchedulesModal('activeSched'); 
            refreshCurrentTab('calendar'); 
        }, () => showManageSchedulesModal('activeSched')); }
        function restoreSchedule(id) { const s = currentData.schedules.find(x => x.id === id); if(s) { s.archived = false; logAction('Restore Schedule', `Restored schedule`, s); showManageSchedulesModal('archivedSched'); refreshCurrentTab('calendar'); } }
        
        function deleteSchedulePermanently(id) {
            if (currentUser && currentUser.role === ROLES.ADMIN) return alert("Admin Restricted: Cannot permanently delete items.");
            showConfirmationModal('Delete Permanently?', 'This will remove the schedule and ALL associated assignments forever.', () => {
                currentData.schedules = currentData.schedules.filter(s => s.id !== id);
                currentData.assignments = currentData.assignments.filter(a => a.scheduleId !== id);
                currentData.overtimeSignups = currentData.overtimeSignups.filter(s => s.scheduleId !== id);
                logAction('Delete Schedule', `Permanently deleted schedule ID ${id}`);
                showManageSchedulesModal('archivedSched');
                refreshCurrentTab('calendar');
            });
        }

        // --- LOCATION ---
        function showLocationManager() {
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.ADMIN) return alert("Admin Restricted: Cannot manage locations.");
            const activeLocations = globalData.locations.filter(l => !l.archived);
            const archivedLocations = globalData.locations.filter(l => l.archived);
            
            // Build Active Tab Content
            let activeHtml = `<div class="action-buttons"><button class="btn btn-primary" onclick="showAddLocationModal()">Add New Location</button></div><div class="location-grid">`;
            activeLocations.forEach(location => {
                activeHtml += `<div class="location-card">
                        <div class="location-card-header"><span class="location-name">${location.name}</span></div>
                        <div class="action-buttons" style="margin-top: 10px; flex-wrap:wrap;">
                            <button class="action-bubble edit" onclick="selectLocation('${location.id}')">Select</button>
                            <button class="action-bubble edit" onclick="showEditLocationModal('${location.id}')">Rename</button>
                            ${activeLocations.length > 1 ? `<button class="action-bubble archive" onclick="archiveLocation('${location.id}')">Archive</button>` : ''}
                        </div></div>`;
            });
            activeHtml += '</div>';

            // Build Archived Tab Content
            let archivedHtml = `<div class="location-grid">`;
            if(archivedLocations.length === 0) archivedHtml += `<p style="padding:20px; color:#64748b;">No archived locations.</p>`;
            archivedLocations.forEach(location => {
                archivedHtml += `<div class="location-card" style="opacity:0.7; background:#f8fafc;">
                        <div class="location-card-header"><span class="location-name" style="text-decoration:line-through; color:#94a3b8;">${location.name}</span> <span style="font-size:11px;">(${formatDate(location.archivedAt)})</span></div>
                        <div class="action-buttons" style="margin-top: 10px;">
                            <button class="action-bubble restore" onclick="restoreLocation('${location.id}')">Restore</button>
                            <button class="action-bubble delete" onclick="deleteLocationPermanently('${location.id}')">Delete Permanently</button>
                        </div></div>`;
            });
            archivedHtml += '</div>';

            // Combine into Tabs
            const html = `
                <div class="admin-modal-tabs">
                    <button class="tab active" onclick="showModalTab('locActive', this)">Active Locations</button>
                    <button class="tab" onclick="showModalTab('locArchived', this)">Archived</button>
                </div>
                <div id="locActive" class="tab-content" style="min-height:auto;">${activeHtml}</div>
                <div id="locArchived" class="tab-content hidden" style="min-height:auto;">${archivedHtml}</div>
            `;

            createModal('Location Manager', html);
        }

        function showAddLocationModal() { showCustomPrompt('New Location Name', '', (n) => { if(n) { globalData.locations.push(new Location(n)); logAction('Add Location', `Added location: ${n}`, globalData.locations[globalData.locations.length-1]); showLocationManager(); updateLocationDropdown(); }}); }
        function showEditLocationModal(id) { const l = globalData.locations.find(x=>x.id===id); showCustomPrompt('Rename', l.name, (n) => { if(n) { l.name = n; logAction('Rename Location', `Renamed location to ${n}`, l); showLocationManager(); updateLocationDropdown(); }}); }
        function archiveLocation(id) { 
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role === ROLES.EMPLOYEE || role === ROLES.GUEST) return alert("Access Denied.");
            showConfirmationModal('Archive?', 'Archive this location?', () => { const l = globalData.locations.find(x=>x.id===id); l.archived=true; l.archivedAt=getTodayDateString(); logAction('Archive Location', `Archived location ${l.name}`, l); showLocationManager(); updateLocationDropdown(); }); }
        function restoreLocation(id) { const l = globalData.locations.find(x=>x.id===id); l.archived=false; logAction('Restore Location', `Restored location ${l.name}`, l); showLocationManager(); updateLocationDropdown(); }
        function deleteLocationPermanently(id) { 
            if (currentUser && currentUser.role === ROLES.ADMIN) return alert("Admin Restricted: Cannot permanently delete items.");
            showConfirmationModal('Delete?', 'Permanently delete this location and all its data?', () => {
                logAction('Delete Location', `Permanently deleted location ID ${id}`); // Global log
                globalData.locations = globalData.locations.filter(l => l.id !== id);
                showLocationManager();
                updateLocationDropdown();
            }); 
        }
        function selectLocation(id) { 
            globalData.currentLocation = id; 
            currentData = globalData.locations.find(l => l.id === id).data; 
            updateLocationUI(); 
            if (!document.getElementById('calendar').classList.contains('hidden')) loadCalendar();
            else if (!document.getElementById('roster').classList.contains('hidden')) loadRoster();
            else if (!document.getElementById('weeklyHours').classList.contains('hidden')) loadWeeklyHours();
            else if (!document.getElementById('overtime').classList.contains('hidden')) loadOvertime();
            else if (!document.getElementById('vacation').classList.contains('hidden')) loadVacation();
            else if (!document.getElementById('home').classList.contains('hidden')) loadHome();
            closeModal(); 
        }

        function editTitle() { 
            if (currentUser && currentUser.role === ROLES.ADMIN) return alert("Admin Restricted: Cannot edit title.");
            if (!currentData) return alert('Please select a location first.'); 
            createModal('Edit Title', `<div class="form-group"><label>New Title</label><input type="text" id="editTitleInput" value="${currentData.config.title}"></div><div class="action-buttons"><button class="btn btn-primary" onclick="confirmEditTitle()">Save</button><button class="btn btn-secondary" onclick="closeModal()">Cancel</button></div>`); 
        }
        function confirmEditTitle() { const newTitle = document.getElementById('editTitleInput').value; if (newTitle) { currentData.config.title = newTitle; document.getElementById('mainTitle').textContent = newTitle; logAction('Edit Title', `Changed title to ${newTitle}`); closeModal(); } }

        function showSystemLogs() {
            if (!currentData) return;
            
            // Collect all logs
            let allLogs = [];
            
            // Helper to add logs with reference for deletion
            const addLogs = (sourceArray, source, sourceName) => {
                if (sourceArray && Array.isArray(sourceArray)) {
                    sourceArray.forEach(l => {
                        allLogs.push({ ...l, source, sourceName, _ref: l, _parent: sourceArray });
                    });
                }
            };
            
            // 1. System Logs
            addLogs(currentData.logs, 'System', 'General');
            
            // 2. Employee Logs
            currentData.employees.forEach(e => addLogs(e.logs, 'Employee', e.name));
            
            // 3. Shift Logs
            currentData.shifts.forEach(s => addLogs(s.logs, 'Shift', s.name));
            
            // 4. Schedule Logs
            currentData.schedules.forEach(s => addLogs(s.logs, 'Schedule', s.name));

            // Sort newest first
            allLogs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Store in window for filtering
            window.currentSystemLogs = allLogs;
            
            renderSystemLogsModal();
        }

        function renderSystemLogsModal(filterType = 'All', searchTerm = '') {
            let logs = window.currentSystemLogs || [];
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            const canDelete = (role === ROLES.OWNER);
            
            if (filterType !== 'All') {
                logs = logs.filter(l => l.source === filterType);
            }
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                logs = logs.filter(l => 
                    l.user.toLowerCase().includes(term) || 
                    l.action.toLowerCase().includes(term) || 
                    l.details.toLowerCase().includes(term) ||
                    l.sourceName.toLowerCase().includes(term)
                );
            }

            let html = `
                <div style="display:flex; gap:15px; margin-bottom:15px;">
                    <div style="display:flex; align-items:flex-end;">
                        ${canDelete ? `<button class="btn btn-danger" onclick="clearFilteredLogs()">Clear Listed Logs</button>` : ''}
                    </div>
                    <div class="filter-group">
                        <label>Source</label>
                        <select id="logFilterType" onchange="updateLogView()">
                            <option value="All" ${filterType === 'All' ? 'selected' : ''}>All Sources</option>
                            <option value="System" ${filterType === 'System' ? 'selected' : ''}>System (General)</option>
                            <option value="Employee" ${filterType === 'Employee' ? 'selected' : ''}>Employees</option>
                            <option value="Shift" ${filterType === 'Shift' ? 'selected' : ''}>Shifts</option>
                            <option value="Schedule" ${filterType === 'Schedule' ? 'selected' : ''}>Schedules</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex:1;">
                        <label>Search</label>
                        <input type="text" id="logSearchTerm" value="${searchTerm}" onkeyup="updateLogView()" placeholder="Search user, action, details...">
                    </div>
                </div>
                <div class="table-container" style="max-height:600px; overflow-y:auto;">
                    <table>
                        <thead><tr><th>Timestamp</th><th>Source</th><th>User</th><th>Action</th><th>Details</th>${canDelete ? '<th>Action</th>' : ''}</tr></thead>
                        <tbody>`;
            
            if (logs.length === 0) {
                html += `<tr><td colspan="${canDelete ? 6 : 5}" style="text-align:center; color:#64748b; padding:20px;">No logs found matching criteria.</td></tr>`;
            } else {
                logs.slice(0, 500).forEach((l, index) => { // Limit display for performance
                    html += `<tr>
                        <td style="white-space:nowrap; font-size:11px;">${new Date(l.timestamp).toLocaleString()}</td>
                        <td><span class="assignment-tag" style="background:#e2e8f0; color:#475467;">${l.source}: ${l.sourceName}</span></td>
                        <td>${l.user}</td>
                        <td style="font-weight:600;">${l.action}</td>
                        <td style="font-size:12px;">${l.details}</td>
                        ${canDelete ? `<td><button class="action-bubble delete" onclick="deleteLogEntry('${l.timestamp}', '${l.action}')">Delete</button></td>` : ''}
                    </tr>`;
                });
            }
            html += `</tbody></table></div>
            <div style="margin-top:10px; font-size:11px; color:#64748b; text-align:right;">Showing top 500 results</div>`;
            
            // If modal exists, update content, else create
            const container = document.getElementById('systemLogsContent');
            if (container) {
                container.innerHTML = html;
            } else {
                createModal('System Logs', `<div id="systemLogsContent">${html}</div>`, '1000px');
            }
        }

        window.updateLogView = function() {
            const type = document.getElementById('logFilterType').value;
            const term = document.getElementById('logSearchTerm').value;
            renderSystemLogsModal(type, term);
        };

        function deleteLogEntry(timestamp, action) {
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role !== ROLES.OWNER) return alert("Access Denied: Only Owners can delete logs.");

            // Find the log in the current global list to get its parent reference
            const logItem = window.currentSystemLogs.find(l => l.timestamp === timestamp && l.action === action);
            if (logItem && logItem._parent) {
                const idx = logItem._parent.indexOf(logItem._ref);
                if (idx > -1) {
                    logItem._parent.splice(idx, 1);
                    showSystemLogs(); // Re-aggregate and render
                }
            }
        }

        function clearFilteredLogs() {
            const role = currentUser ? currentUser.role : ROLES.GUEST;
            if (role !== ROLES.OWNER) return alert("Access Denied: Only Owners can delete logs.");

            if (!confirm("Are you sure you want to delete all currently listed logs? This cannot be undone.")) return;
            
            // Get current filter state to know what is being displayed
            const type = document.getElementById('logFilterType').value;
            const term = document.getElementById('logSearchTerm').value;
            
            // We need to re-run the filter logic on the currentSystemLogs to find what to delete
            // Or simply iterate the DOM? Better to use the data source.
            // Since renderSystemLogsModal filters `window.currentSystemLogs`, we can do the same here.
            let logsToDelete = window.currentSystemLogs;

            if (type !== 'All') logsToDelete = logsToDelete.filter(l => l.source === type);
            if (term) {
                const t = term.toLowerCase();
                logsToDelete = logsToDelete.filter(l => 
                    l.user.toLowerCase().includes(t) || 
                    l.action.toLowerCase().includes(t) || 
                    l.details.toLowerCase().includes(t) ||
                    l.sourceName.toLowerCase().includes(t)
                );
            }

            // Delete them
            logsToDelete.forEach(logItem => {
                if (logItem._parent) {
                    const idx = logItem._parent.indexOf(logItem._ref);
                    if (idx > -1) logItem._parent.splice(idx, 1);
                }
            });

            showSystemLogs();
        }

        function openTutorials() {
            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>System Tutorials & Guide</title>
                    <style>
                        body { font-family: 'Segoe UI', system-ui, sans-serif; line-height: 1.6; color: #334155; background: #f1f5f9; margin: 0; display: flex; }
                        .sidebar { width: 280px; background: #1e293b; color: white; position: fixed; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
                        .sidebar-header { padding: 20px; background: #0f172a; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #334155; }
                        .nav-item { padding: 15px 20px; color: #94a3b8; cursor: pointer; border-bottom: 1px solid #334155; transition: all 0.2s; font-size: 0.95rem; }
                        .nav-item:hover { background: #334155; color: white; padding-left: 25px; }
                        .content { margin-left: 280px; padding: 40px; width: 100%; max-width: 1000px; }
                        .section { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 40px; scroll-margin-top: 20px; }
                        h1 { color: #0f172a; border-bottom: 3px solid #3b82f6; padding-bottom: 10px; margin-top: 0; }
                        h2 { color: #3b82f6; margin-top: 30px; font-size: 1.4rem; }
                        p { margin-bottom: 15px; font-size: 1.05rem; }
                        .visual-box { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center; }
                        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white; }
                        .tag.blue { background: #3b82f6; } .tag.green { background: #10b981; } .tag.red { background: #ef4444; }
                        .btn-sim { display: inline-block; padding: 6px 12px; background: #e2e8f0; border: 1px solid #cbd5e1; border-radius: 4px; color: #334155; font-weight: bold; font-size: 0.85rem; }
                        .btn-sim.primary { background: #3b82f6; color: white; border-color: #2563eb; }
                        ul { padding-left: 20px; }
                        li { margin-bottom: 8px; }
                    </style>
                </head>
                <body>
                    <div class="sidebar">
                        <div class="sidebar-header">ðŸ“– User Guide</div>
                        <div class="nav-item" onclick="document.getElementById('login').scrollIntoView({behavior: 'smooth'})">1. Login & Roles</div>
                        <div class="nav-item" onclick="document.getElementById('calendar').scrollIntoView({behavior: 'smooth'})">2. Schedule Calendar</div>
                        <div class="nav-item" onclick="document.getElementById('roster').scrollIntoView({behavior: 'smooth'})">3. Roster Management</div>
                        <div class="nav-item" onclick="document.getElementById('overtime').scrollIntoView({behavior: 'smooth'})">4. Overtime System</div>
                        <div class="nav-item" onclick="document.getElementById('vacation').scrollIntoView({behavior: 'smooth'})">5. Vacation Segments</div>
                        <div class="nav-item" onclick="document.getElementById('admin').scrollIntoView({behavior: 'smooth'})">6. Admin Settings</div>
                    </div>
                    <div class="content">
                        <div id="login" class="section">
                            <h1>1. Login & Roles</h1>
                            <p>The system uses a Role-Based Access Control system. When an employee is added to the roster, credentials are auto-generated.</p>
                            <div class="visual-box">
                                <strong>Roles:</strong><br><br>
                                <span class="tag red">Owner</span> Full access to everything, including logs and other Owner accounts.<br><br>
                                <span class="tag blue">Admin</span> Can manage schedules and employees, but cannot delete logs or edit Owners.<br><br>
                                <span class="tag green">Employee</span> View-only access to the schedule. Can sign up for Overtime.
                            </div>
                            <p><strong>Note:</strong> Employees can change their password by clicking "View Account" on the Home Screen.</p>
                        </div>

                        <div id="calendar" class="section">
                            <h1>2. Schedule Calendar</h1>
                            <p>The main workspace for managing daily operations. You can view by Week, Month, or Day.</p>
                            <h2>Quick Assign (Drag & Drop)</h2>
                            <p>Click the <strong>Quick Assign</strong> button in the top right to open the sidebar. Select an employee, then drag a colored bubble onto the calendar.</p>
                            <div class="visual-box">
                                <span class="btn-sim primary">Quick Assign â–¶</span> &nbsp; âž &nbsp; <span class="tag blue">Regular</span> (Drag me!) &nbsp; âž &nbsp; ðŸ“… Calendar Cell
                            </div>
                            <h2>Managing Assignments</h2>
                            <p>Click any cell on the calendar to open the <strong>Assignment Manager</strong>. From here you can:</p>
                            <ul>
                                <li>Add multiple employees to one slot.</li>
                                <li>Add notes to assignments.</li>
                                <li>Override "RDO" (Regular Day Off) blocks if necessary.</li>
                            </ul>
                        </div>

                        <div id="roster" class="section">
                            <h1>3. Roster Management</h1>
                            <p>Manage your team from the Roster tab. You can Add, Edit, Archive, or Hide employees.</p>
                            <p><strong>Hidden Employees:</strong> Use the "Hide from Roster" checkbox in the Edit screen to keep an employee in the system (so they can login) but hide them from the daily schedule views.</p>
                        </div>

                        <div id="overtime" class="section">
                            <h1>4. Overtime System</h1>
                            <p>A complete system for tracking Voluntary and Mandatory overtime lists.</p>
                            <h2>Signup Calendar</h2>
                            <p>Employees can sign up for shifts by clicking on the <strong>Overtime</strong> tile. They can select multiple shifts and click "Sign Up Selected".</p>
                            <h2>Approval Process</h2>
                            <p>Admins/Owners can view the <strong>Volunteers</strong> list for any shift. Click "Approve" to automatically assign the employee to the schedule and log the action.</p>
                            <div class="visual-box">
                                Statuses: <span class="tag green">Approved</span> <span class="tag red">Declined</span> <span style="background:#f1f5f9; color:#94a3b8; padding:2px 8px; border-radius:4px; border:1px solid #cbd5e1;">Cancelled</span>
                            </div>
                        </div>

                        <div id="vacation" class="section">
                            <h1>5. Vacation Segments</h1>
                            <p>Use the <strong>Vacation Segments</strong> tab to manage long-term leave. Creating a segment here automatically populates the main schedule.</p>
                            <p><strong>Smart Filling:</strong> The system is smart enough to only assign vacation hours to scheduled work days, skipping RDOs automatically.</p>
                        </div>

                        <div id="admin" class="section">
                            <h1>6. Admin Settings</h1>
                            <p>Access global settings via the "Admin Settings" tile on the Home Screen.</p>
                            <ul>
                                <li><strong>System Logs:</strong> View a detailed audit trail of all actions (Login, Delete, Assign, etc.).</li>
                                <li><strong>Manage Locations:</strong> Create and switch between different facility locations.</li>
                            </ul>
                        </div>
                    </div>
                </body>
                </html>
            `);
            w.document.close();
        }
    </script>
</body>
</html>
